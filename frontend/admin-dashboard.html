<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель - Bunyod-Tour</title>
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f3f4f6;
        }
        
        .sidebar {
            width: 260px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 100;
            transition: transform 0.3s ease;
        }
        
        .sidebar.collapsed {
            transform: translateX(-100%);
        }
        
        .main-content {
            margin-left: 260px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }
        
        .main-content.expanded {
            margin-left: 0;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .nav-item {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
            cursor: pointer;
            text-decoration: none;
        }
        
        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.15);
            color: white;
        }
        
        .tab-button {
            padding: 10px 24px;
            border: none;
            background: transparent;
            color: #6b7280;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .tab-button:hover {
            color: #4b5563;
        }
        
        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .data-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .data-table th {
            background: #f9fafb;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .data-table tr:hover {
            background: #f9fafb;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 32px;
            position: relative;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
        }
        
        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }
        
        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .badge-warning {
            background: #fed7aa;
            color: #92400e;
        }
        
        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
        }
        
        .image-preview {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            margin-right: 10px;
            margin-bottom: 10px;
            display: inline-block;
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 8px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .checkbox-item:hover {
            background: #f3f4f6;
        }
        
        .checkbox-item.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .search-bar {
            position: relative;
            max-width: 400px;
        }
        
        .search-bar input {
            width: 100%;
            padding: 10px 40px 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
        }
        
        .search-bar i {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen bg-gradient-to-br from-purple-600 to-blue-500 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Админ-панель</h1>
                <p class="text-gray-600">Войдите в систему управления</p>
            </div>
            <form id="loginForm">
                <div class="mb-6">
                    <label class="form-label">Имя пользователя</label>
                    <input type="text" id="username" class="form-input" placeholder="admin" required>
                </div>
                <div class="mb-6">
                    <label class="form-label">Пароль</label>
                    <input type="password" id="password" class="form-input" placeholder="••••••••" required>
                </div>
                <button type="submit" class="btn btn-primary w-full">
                    <i class="fas fa-sign-in-alt"></i>
                    Войти в систему
                </button>
                <div class="mt-4 text-center text-sm text-gray-500">
                    Тестовые данные: admin / admin123
                </div>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" style="display: none;">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="p-6 border-b border-white/20">
                <h2 class="text-white text-xl font-bold">Bunyod-Tour</h2>
                <p class="text-white/60 text-sm mt-1">Панель управления</p>
            </div>
            
            <nav class="p-4">
                <a href="#" class="nav-item active" data-section="dashboard">
                    <i class="fas fa-chart-line"></i>
                    <span>Главная</span>
                </a>
                <a href="#" class="nav-item" data-section="tours">
                    <i class="fas fa-map-marked-alt"></i>
                    <span>Туры</span>
                </a>
                <a href="#" class="nav-item" data-section="price-calculator">
                    <i class="fas fa-calculator"></i>
                    <span>Калькулятор цен</span>
                </a>
                <a href="#" class="nav-item" data-section="banner-management">
                    <i class="fas fa-images"></i>
                    <span>Управление баннером</span>
                </a>
                <a href="#" class="nav-item" data-section="bookings">
                    <i class="fas fa-calendar-check"></i>
                    <span>Заказы</span>
                </a>
                <a href="#" class="nav-item" data-section="hotels">
                    <i class="fas fa-hotel"></i>
                    <span>Отели</span>
                </a>
                <a href="#" class="nav-item" data-section="guides">
                    <i class="fas fa-user-tie"></i>
                    <span>Гиды</span>
                </a>
                <a href="#" class="nav-item" data-section="customers">
                    <i class="fas fa-users"></i>
                    <span>Клиенты</span>
                </a>
                <a href="#" class="nav-item" data-section="reviews">
                    <i class="fas fa-star"></i>
                    <span>Отзывы</span>
                </a>
                <a href="#" class="nav-item" data-section="payments">
                    <i class="fas fa-credit-card"></i>
                    <span>Платежи</span>
                </a>
                <a href="#" class="nav-item" data-section="exchange-rates">
                    <i class="fas fa-exchange-alt"></i>
                    <span>Курсы валют</span>
                </a>
                <a href="#" class="nav-item" data-section="cms">
                    <i class="fas fa-edit"></i>
                    <span>CMS - Контент</span>
                </a>
                <a href="#" class="nav-item" data-section="translations">
                    <i class="fas fa-language"></i>
                    <span>Переводы</span>
                </a>
                <a href="#" class="nav-item" data-section="settings">
                    <i class="fas fa-cog"></i>
                    <span>Настройки</span>
                </a>
                <a href="#" class="nav-item" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Выход</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Header -->
            <header class="bg-white shadow-sm px-6 py-4 flex justify-between items-center">
                <button class="lg:hidden" onclick="toggleSidebar()">
                    <i class="fas fa-bars text-gray-600 text-xl"></i>
                </button>
                <h1 class="text-2xl font-semibold text-gray-800" id="sectionTitle">Главная</h1>
                <div class="flex items-center gap-4">
                    <button class="relative">
                        <i class="fas fa-bell text-gray-600 text-xl"></i>
                        <span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">3</span>
                    </button>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center text-white font-semibold">
                            A
                        </div>
                        <span class="text-gray-700 font-medium">Администратор</span>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="p-6" id="contentArea">
                <!-- Dashboard Section -->
                <section id="dashboardSection">
                    <!-- Statistics -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="stat-card">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-map text-blue-600 text-xl"></i>
                                </div>
                                <span class="text-green-500 text-sm font-medium">+12%</span>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-800">156</h3>
                            <p class="text-gray-600 text-sm mt-1">Активных туров</p>
                        </div>
                        
                        <div class="stat-card">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-users text-green-600 text-xl"></i>
                                </div>
                                <span class="text-green-500 text-sm font-medium">+23%</span>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-800">342</h3>
                            <p class="text-gray-600 text-sm mt-1">Заказов за месяц</p>
                        </div>
                        
                        <div class="stat-card">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-dollar-sign text-purple-600 text-xl"></i>
                                </div>
                                <span class="text-green-500 text-sm font-medium">+18%</span>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-800">$45,678</h3>
                            <p class="text-gray-600 text-sm mt-1">Доход за месяц</p>
                        </div>
                        
                        <div class="stat-card">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-users text-orange-600 text-xl"></i>
                                </div>
                                <span class="text-green-500 text-sm font-medium">+8%</span>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-800">1,234</h3>
                            <p class="text-gray-600 text-sm mt-1">Активных клиентов</p>
                        </div>
                    </div>

                    <!-- Recent Orders -->
                    <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Последние заказы</h2>
                        <div class="overflow-x-auto">
                            <table class="data-table w-full">
                                <thead>
                                    <tr>
                                        <th>№ Заказа</th>
                                        <th>Клиент</th>
                                        <th>Тур</th>
                                        <th>Дата</th>
                                        <th>Сумма</th>
                                        <th>Статус</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="recentOrdersTable">
                                    <!-- Orders will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">График продаж</h3>
                            <div style="height: 300px; position: relative;">
                                <canvas id="salesChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Популярные направления</h3>
                            <div style="height: 300px; position: relative;">
                                <canvas id="destinationsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Tours Section -->
                <section id="toursSection" style="display: none;">
                    <div class="mb-6 flex justify-between items-center">
                        <div class="search-bar">
                            <input type="text" placeholder="Поиск туров..." id="tourSearch">
                            <i class="fas fa-search"></i>
                        </div>
                        <button class="btn btn-primary" onclick="openTourModal()">
                            <i class="fas fa-plus"></i>
                            Добавить тур
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm">
                        <div class="overflow-x-auto">
                            <table class="data-table w-full">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Название</th>
                                        <th>Категория</th>
                                        <th>Страна</th>
                                        <th>Город</th>
                                        <th>Длительность</th>
                                        <th>Цена</th>
                                        <th>Статус</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="toursTable">
                                    <!-- Tours will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Bookings Section -->
                <section id="bookingsSection" style="display: none;">
                    <div class="mb-6">
                        <div class="flex gap-2 mb-4">
                            <button class="tab-button active" data-status="all">Все заказы</button>
                            <button class="tab-button" data-status="pending">Ожидающие</button>
                            <button class="tab-button" data-status="confirmed">Подтвержденные</button>
                            <button class="tab-button" data-status="paid">Оплаченные</button>
                            <button class="tab-button" data-status="completed">Завершенные</button>
                            <button class="tab-button" data-status="cancelled">Отмененные</button>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm">
                        <div class="overflow-x-auto">
                            <table class="data-table w-full">
                                <thead>
                                    <tr>
                                        <th>№ Заказа</th>
                                        <th>Дата заказа</th>
                                        <th>Клиент</th>
                                        <th>Тур</th>
                                        <th>Дата тура</th>
                                        <th>Кол-во человек</th>
                                        <th>Сумма</th>
                                        <th>Оплата</th>
                                        <th>Статус</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="bookingsTable">
                                    <!-- Bookings will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Hotels Section -->
                <section id="hotelsSection" style="display: none;">
                    <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-semibold">Управление отелями</h2>
                            <button class="btn btn-primary" onclick="openHotelModal()">
                                <i class="fas fa-plus"></i>
                                Добавить отель
                            </button>
                        </div>
                        
                        <!-- Search and Filter -->
                        <div class="flex justify-between items-center mb-4">
                            <div class="search-bar">
                                <input type="text" id="hotelSearch" placeholder="Поиск отелей..." onkeyup="searchHotels()">
                                <i class="fas fa-search"></i>
                            </div>
                            <select id="hotelFilter" onchange="filterHotels()" class="form-input" style="max-width: 200px;">
                                <option value="">Все отели</option>
                                <option value="active">Активные</option>
                                <option value="inactive">Неактивные</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="hotelsList">
                        <!-- Hotels will be loaded here -->
                    </div>
                </section>

                <!-- Guides Section -->
                <section id="guidesSection" style="display: none;">
                    <div class="mb-6 flex justify-between items-center">
                        <h2 class="text-xl font-semibold">Управление гидами</h2>
                        <button class="btn btn-primary" onclick="openGuideModal()">
                            <i class="fas fa-plus"></i>
                            Добавить гида
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="guidesList">
                        <!-- Guides will be loaded here -->
                    </div>
                </section>

                <!-- Reviews Section -->
                <section id="reviewsSection" style="display: none;">
                    <div class="mb-6">
                        <div class="flex gap-2 mb-4">
                            <button class="tab-button active" data-filter="all">Все отзывы</button>
                            <button class="tab-button" data-filter="pending">На модерации</button>
                            <button class="tab-button" data-filter="approved">Одобренные</button>
                            <button class="tab-button" data-filter="rejected">Отклоненные</button>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-sm">
                        <div class="overflow-x-auto">
                            <table class="data-table w-full">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Дата</th>
                                        <th>Имя туриста</th>
                                        <th>Тур</th>
                                        <th>Рейтинг</th>
                                        <th>Отзыв</th>
                                        <th>Фотографии</th>
                                        <th>Статус</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="reviewsTable">
                                    <!-- Reviews will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- CMS Section -->
                <section id="cmsSection" style="display: none;">
                    <div class="mb-6">
                        <div class="flex gap-2 mb-4">
                            <button class="tab-button active" onclick="switchCMSTab('blocks')">Блоки туров</button>
                            <button class="tab-button" onclick="switchCMSTab('settings')">Настройки сайта</button>
                            <button class="tab-button" onclick="switchCMSTab('tours')">Форма туров</button>
                        </div>
                    </div>

                    <!-- Tour Blocks Tab -->
                    <div id="cmsBlocksTab">
                        <div class="mb-6 flex justify-between items-center">
                            <h2 class="text-xl font-semibold">Управление блоками туров</h2>
                            <button class="btn btn-primary" onclick="openTourBlockModal()">
                                <i class="fas fa-plus"></i>
                                Создать блок туров
                            </button>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-sm">
                            <div class="overflow-x-auto">
                                <table class="data-table w-full">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Название блока (RU)</th>
                                            <th>Название блока (EN)</th>
                                            <th>Слаг</th>
                                            <th>Количество туров</th>
                                            <th>Статус</th>
                                            <th>Порядок</th>
                                            <th>Действия</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tourBlocksTable">
                                        <!-- Tour blocks will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Site Settings Tab -->
                    <div id="cmsSettingsTab" style="display: none;">
                        <div class="mb-6">
                            <h2 class="text-xl font-semibold">Настройки сайта</h2>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <form id="siteSettingsForm">
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div class="form-group">
                                        <label class="form-label">Название сайта (RU)</label>
                                        <input type="text" class="form-input" id="siteTitle_ru" name="siteTitle_ru">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Название сайта (EN)</label>
                                        <input type="text" class="form-input" id="siteTitle_en" name="siteTitle_en">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Описание сайта (RU)</label>
                                        <textarea class="form-input" rows="3" id="siteDescription_ru" name="siteDescription_ru"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Описание сайта (EN)</label>
                                        <textarea class="form-input" rows="3" id="siteDescription_en" name="siteDescription_en"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-input" id="contactEmail" name="contactEmail">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Телефон</label>
                                        <input type="text" class="form-input" id="contactPhone" name="contactPhone">
                                    </div>
                                </div>
                                <div class="mt-6">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i>
                                        Сохранить настройки
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- УДАЛЕНО: Вся Enhanced Tours Form Tab полностью удалена -->
                </section>

                <!-- Translations Section -->
                <section id="translationsSection" style="display: none;">
                    <div class="mb-6">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Автоматический перевод туров</h2>
                        <p class="text-gray-600">Используйте искусственный интеллект для автоматического перевода содержания туров на поддерживаемые языки</p>
                    </div>
                    
                    <!-- Translation Statistics -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-language text-blue-600 text-xl"></i>
                                </div>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-800" id="supportedLanguagesCount">6</h3>
                            <p class="text-gray-600 text-sm mt-1">Поддерживаемых языков</p>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-check-circle text-green-600 text-xl"></i>
                                </div>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-800" id="translatedToursCount">0</h3>
                            <p class="text-gray-600 text-sm mt-1">Полностью переведенных туров</p>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-clock text-orange-600 text-xl"></i>
                                </div>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-800" id="pendingTranslationsCount">0</h3>
                            <p class="text-gray-600 text-sm mt-1">Требует перевода</p>
                        </div>
                    </div>

                    <!-- Translation Tools -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <!-- Single Tour Translation -->
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="text-lg font-semibold mb-4">
                                <i class="fas fa-map-marker-alt text-blue-600 mr-2"></i>
                                Перевести один тур
                            </h3>
                            <p class="text-gray-600 mb-6 text-sm">Выберите конкретный тур для автоматического перевода на недостающие языки</p>
                            
                            <form id="singleTranslationForm">
                                <div class="form-group mb-4">
                                    <label class="form-label">Выберите тур</label>
                                    <select class="form-input" id="translationTourSelect" required>
                                        <option value="">-- Выберите тур --</option>
                                    </select>
                                </div>
                                
                                <button type="submit" class="btn btn-primary w-full" id="translateSingleBtn">
                                    <i class="fas fa-language mr-2"></i>
                                    Перевести тур
                                </button>
                            </form>
                        </div>

                        <!-- Batch Translation -->
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="text-lg font-semibold mb-4">
                                <i class="fas fa-globe text-green-600 mr-2"></i>
                                Массовый перевод
                            </h3>
                            <p class="text-gray-600 mb-6 text-sm">Переведите все туры или выбранные туры одновременно</p>
                            
                            <div class="space-y-4">
                                <button class="btn btn-success w-full" onclick="batchTranslateAllTours()">
                                    <i class="fas fa-rocket mr-2"></i>
                                    Перевести все туры
                                </button>
                                
                                <button class="btn btn-outline w-full" onclick="showBatchTranslationModal()">
                                    <i class="fas fa-check-square mr-2"></i>
                                    Выбрать туры для перевода
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Manual Text Translation -->
                    <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                        <h3 class="text-lg font-semibold mb-4">
                            <i class="fas fa-edit text-purple-600 mr-2"></i>
                            Ручной перевод текста
                        </h3>
                        <p class="text-gray-600 mb-6 text-sm">Переведите любой текст с одного языка на другой</p>
                        
                        <form id="manualTranslationForm" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <div class="form-group mb-4">
                                    <label class="form-label">Исходный язык</label>
                                    <select class="form-input" id="sourceLanguage" required>
                                        <option value="ru">Русский</option>
                                        <option value="en">English</option>
                                        <option value="tj">Тоҷикӣ (Tajik)</option>
                                        <option value="fa">فارسی (Farsi)</option>
                                        <option value="de">Deutsch</option>
                                        <option value="zh">中文 (Chinese)</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Исходный текст</label>
                                    <textarea class="form-input" id="sourceText" rows="8" placeholder="Введите текст для перевода..." required></textarea>
                                </div>
                            </div>
                            
                            <div>
                                <div class="form-group mb-4">
                                    <label class="form-label">Целевой язык</label>
                                    <select class="form-input" id="targetLanguage" required>
                                        <option value="en">English</option>
                                        <option value="ru">Русский</option>
                                        <option value="tj">Тоҷикӣ (Tajik)</option>
                                        <option value="fa">فارسی (Farsi)</option>
                                        <option value="de">Deutsch</option>
                                        <option value="zh">中文 (Chinese)</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Переведенный текст</label>
                                    <textarea class="form-input" id="translatedText" rows="8" placeholder="Переведенный текст появится здесь..." readonly></textarea>
                                </div>
                            </div>
                            
                            <div class="lg:col-span-2">
                                <button type="submit" class="btn btn-primary" id="manualTranslateBtn">
                                    <i class="fas fa-arrow-right mr-2"></i>
                                    Перевести текст
                                </button>
                                
                                <button type="button" class="btn btn-outline ml-4" onclick="copyTranslation()">
                                    <i class="fas fa-copy mr-2"></i>
                                    Копировать перевод
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Translation Progress -->
                    <div class="bg-white rounded-xl shadow-sm p-6" id="translationProgress" style="display: none;">
                        <h3 class="text-lg font-semibold mb-4">
                            <i class="fas fa-spinner fa-spin text-blue-600 mr-2"></i>
                            Прогресс перевода
                        </h3>
                        <div class="w-full bg-gray-200 rounded-full h-2 mb-4">
                            <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" id="progressBar" style="width: 0%"></div>
                        </div>
                        <p class="text-sm text-gray-600" id="progressText">Подготовка к переводу...</p>
                        <div id="translationResults" class="mt-4 space-y-2"></div>
                    </div>
                </section>

                <!-- Price Calculator Section -->
                <section id="priceCalculatorSection" style="display: none;">
                    <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                        <h2 class="text-2xl font-semibold mb-6">
                            <i class="fas fa-calculator text-blue-600 mr-3"></i>
                            Автоматический калькулятор цен
                        </h2>
                        <p class="text-gray-600 mb-6">Главный регулятор для расчета стоимости туров в сомони (сом)</p>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse border border-gray-300">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="border border-gray-300 px-4 py-2 text-left">Услуга</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center">Цена (TJS)</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center">Единица</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center">Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="priceCalculatorTable">
                                    <!-- Динамически загружается из базы данных -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-6 flex gap-4">
                            <button class="btn btn-success" onclick="savePriceCalculator()">
                                <i class="fas fa-save mr-2"></i>
                                Сохранить цены
                            </button>
                            <button class="btn btn-primary" onclick="addNewPriceRow()">
                                <i class="fas fa-plus mr-2"></i>
                                Добавить услугу
                            </button>
                            <button class="btn btn-secondary" onclick="resetPrices()">
                                <i class="fas fa-undo mr-2"></i>
                                Сбросить к стандартным
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Banner Management Section -->
                <section id="bannerManagementSection" style="display: none;">
                    <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                        <h2 class="text-2xl font-semibold mb-6">
                            <i class="fas fa-images text-blue-600 mr-3"></i>
                            Управление баннером
                        </h2>
                        <p class="text-gray-600 mb-6">Управление слайдами баннера на главной странице</p>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Текущие слайды -->
                            <div>
                                <h3 class="text-lg font-semibold mb-4">Текущие слайды</h3>
                                <div id="currentSlides" class="space-y-4">
                                    <!-- Slides will be loaded here -->
                                </div>
                            </div>
                            
                            <!-- Добавить новый слайд -->
                            <div>
                                <h3 class="text-lg font-semibold mb-4">Добавить новый слайд</h3>
                                <form id="bannerForm" class="space-y-4">
                                    <div class="form-group">
                                        <label class="form-label">Заголовок (Русский)</label>
                                        <input type="text" class="form-input" id="bannerTitleRu" placeholder="Заголовок слайда">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Заголовок (English)</label>
                                        <input type="text" class="form-input" id="bannerTitleEn" placeholder="Slide title">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Описание (Русский)</label>
                                        <textarea class="form-input" rows="3" id="bannerDescRu" placeholder="Описание слайда"></textarea>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Описание (English)</label>
                                        <textarea class="form-input" rows="3" id="bannerDescEn" placeholder="Slide description"></textarea>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">URL фонового изображения</label>
                                        <input type="url" class="form-input" id="bannerImage" placeholder="https://example.com/image.jpg">
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Текст кнопки (Русский)</label>
                                        <input type="text" class="form-input" id="bannerButtonTextRu" placeholder="Узнать больше">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Текст кнопки (English)</label>
                                        <input type="text" class="form-input" id="bannerButtonTextEn" placeholder="Learn more">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Ссылка (необязательно)</label>
                                        <input type="url" class="form-input" id="bannerLink" placeholder="https://example.com">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Порядок отображения</label>
                                        <input type="number" class="form-input" id="bannerOrder" value="1" min="1">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="checkbox-item">
                                            <input type="checkbox" id="bannerActive" checked> Активный
                                        </label>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary w-full">
                                        <i class="fas fa-plus mr-2"></i>
                                        Добавить слайд
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Settings Section -->
                <section id="settingsSection" style="display: none;">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="text-lg font-semibold mb-4">Общие настройки</h3>
                            <form id="generalSettingsForm">
                                <div class="form-group">
                                    <label class="form-label">Название компании</label>
                                    <input type="text" class="form-input" value="Bunyod-Tour">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email администратора</label>
                                    <input type="email" class="form-input" value="admin@bunyod-tour.com">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email сообщества</label>
                                    <input type="email" class="form-input" value="community@bunyod-tour.com">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Телефон поддержки</label>
                                    <input type="tel" class="form-input" value="+992 123 456 789">
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i>
                                    Сохранить изменения
                                </button>
                            </form>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="text-lg font-semibold mb-4">Настройки платежей</h3>
                            <form id="paymentSettingsForm">
                                <div class="form-group">
                                    <label class="form-label">
                                        <input type="checkbox" checked> Payme
                                    </label>
                                    <input type="text" class="form-input mt-2" placeholder="Merchant ID">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        <input type="checkbox" checked> Click
                                    </label>
                                    <input type="text" class="form-input mt-2" placeholder="Service ID">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        <input type="checkbox" checked> Stripe
                                    </label>
                                    <input type="text" class="form-input mt-2" placeholder="API Key">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">
                                        <input type="checkbox" checked> PayPal
                                    </label>
                                    <input type="text" class="form-input mt-2" placeholder="Client ID">
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i>
                                    Сохранить настройки
                                </button>
                            </form>
                        </div>
                    </div>
                </section>

                <!-- Exchange Rates Section -->
                <section id="exchange-ratesSection" style="display: none;">
                    <div class="mb-6">
                        <h2 class="text-xl font-semibold text-gray-800">Управление курсами валют</h2>
                        <p class="text-gray-600 mt-2">Настройка курсов валют для конвертации цен на сайте</p>
                    </div>

                    <!-- Exchange Rates Table -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-semibold">Текущие курсы валют</h3>
                            <button onclick="loadExchangeRates()" class="btn btn-secondary">
                                <i class="fas fa-sync-alt"></i>
                                Обновить
                            </button>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="data-table w-full">
                                <thead>
                                    <tr>
                                        <th>Валюта</th>
                                        <th>Название</th>
                                        <th>Символ</th>
                                        <th>Курс к TJS</th>
                                        <th>Последнее обновление</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="exchangeRatesTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center py-8 text-gray-500">
                                            <i class="fas fa-spinner fa-spin"></i>
                                            Загрузка курсов валют...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Exchange Rate Calculator -->
                    <div class="mt-6 bg-white rounded-xl shadow-sm p-6">
                        <h3 class="text-lg font-semibold mb-4">Калькулятор валют</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="form-group">
                                <label class="form-label">Сумма в TJS</label>
                                <input type="number" class="form-input" id="calcAmount" placeholder="100" min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Конвертировать в</label>
                                <select class="form-input" id="calcTargetCurrency">
                                    <option value="USD">USD - Доллар США</option>
                                    <option value="EUR">EUR - Евро</option>
                                    <option value="TJS">TJS - Сомони</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Результат</label>
                                <div class="form-input bg-gray-50" id="calcResult">0</div>
                            </div>
                        </div>
                        <button onclick="calculateCurrency()" class="btn btn-primary mt-4">
                            <i class="fas fa-calculator"></i>
                            Рассчитать
                        </button>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Exchange Rate Modal -->
    <div id="exchangeRateModal" class="modal">
        <div class="modal-content" style="width: 500px;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold" id="exchangeRateModalTitle">Редактировать курс валюты</h2>
                <button onclick="closeExchangeRateModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="exchangeRateForm">
                <input type="hidden" id="editCurrency">
                
                <div class="form-group">
                    <label class="form-label">Валюта</label>
                    <input type="text" class="form-input" id="editCurrencyCode" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Название</label>
                    <input type="text" class="form-input" id="editCurrencyName" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Символ</label>
                    <input type="text" class="form-input" id="editCurrencySymbol" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Курс к TJS</label>
                    <input type="number" class="form-input" id="editCurrencyRate" step="0.0001" min="0" required>
                    <small class="text-gray-500 mt-1">1 TJS = ? единиц этой валюты</small>
                </div>
                
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeExchangeRateModal()" class="btn btn-secondary">
                        Отмена
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        Сохранить
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Hotel Modal -->
    <div id="hotelModal" class="modal">
        <div class="modal-content" style="width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold" id="hotelModalTitle">Добавить отель</h2>
                <button onclick="closeHotelModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="hotelForm">
                <!-- КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Добавлено скрытое поле ID -->
                <input type="hidden" id="hotel-id">
                
                <div class="grid grid-cols-1 gap-4">
                    <div class="form-group">
                        <label class="form-label">Название отеля</label>
                        <input type="text" class="form-input" id="hotelName" placeholder="Hilton Dushanbe, Serena Hotel и т.д." required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Описание отеля</label>
                        <textarea class="form-input" rows="4" id="hotelDescription" placeholder="Краткое описание отеля, расположения и особенностей..." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Адрес</label>
                        <input type="text" class="form-input" id="hotelAddress" required>
                    </div>
                    
                    
                    <div class="form-group">
                        <label class="form-label">Количество звезд</label>
                        <select class="form-input" id="hotelStars">
                            <option value="">Не указано</option>
                            <option value="1">⭐ 1 звезда</option>
                            <option value="2">⭐⭐ 2 звезды</option>
                            <option value="3">⭐⭐⭐ 3 звезды</option>
                            <option value="4">⭐⭐⭐⭐ 4 звезды</option>
                            <option value="5">⭐⭐⭐⭐⭐ 5 звезд</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Бренд отеля</label>
                        <div class="flex gap-2">
                            <select class="form-input flex-1" id="hotelBrand">
                                <option value="">Выберите бренд</option>
                                <option value="Four Seasons">Four Seasons</option>
                                <option value="Ritz-Carlton">Ritz-Carlton</option>
                                <option value="St. Regis">St. Regis</option>
                                <option value="Waldorf Astoria">Waldorf Astoria</option>
                                <option value="Conrad">Conrad</option>
                                <option value="Hilton">Hilton</option>
                                <option value="Marriott">Marriott</option>
                                <option value="Sheraton">Sheraton</option>
                                <option value="Westin">Westin</option>
                                <option value="Hyatt">Hyatt</option>
                                <option value="InterContinental">InterContinental</option>
                                <option value="Crowne Plaza">Crowne Plaza</option>
                                <option value="Holiday Inn">Holiday Inn</option>
                                <option value="Radisson">Radisson</option>
                                <option value="Novotel">Novotel</option>
                                <option value="Ibis">Ibis</option>
                                <option value="Best Western">Best Western</option>
                                <option value="Serena Hotels">Serena Hotels</option>
                                <option value="Golden Tulip">Golden Tulip</option>
                                <option value="Независимый отель">Независимый отель</option>
                                <option value="custom">+ Добавить новый бренд</option>
                            </select>
                        </div>
                        <input type="text" class="form-input mt-2" id="hotelBrandCustom" placeholder="Введите название нового бренда" style="display: none;">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Категория отеля</label>
                        <select class="form-input" id="hotelCategory">
                            <option value="">Выберите категорию</option>
                            <option value="Economy">Эконом</option>
                            <option value="Premium">Премиум</option>
                            <option value="Luxury">Люкс</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Страна</label>
                        <select class="form-input" id="hotelCountry">
                            <option value="">Выберите страну</option>
                            <option value="Таджикистан">Таджикистан</option>
                            <option value="Узбекистан">Узбекистан</option>
                            <option value="Киргизстан">Киргизстан</option>
                            <option value="Туркменистан">Туркменистан</option>
                            <option value="Казахстан">Казахстан</option>
                        </select>
                    </div>
                    
                    <!-- НОВОЕ: Секция категорий номеров с ценами -->
                    <div class="form-group">
                        <label class="form-label">Категории номеров и цены</label>
                        <div class="bg-gray-50 p-4 rounded-lg border">
                            <p class="text-sm text-gray-600 mb-3">Настройте цены за ночь для разных типов номеров (в USD)</p>
                            
                            <!-- SGL - Одноместный -->
                            <div class="flex items-center justify-between py-2 border-b border-gray-200">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" id="roomSGL" class="rounded">
                                    <label for="roomSGL" class="font-medium">SGL - Одноместный</label>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span>$</span>
                                    <input type="number" id="priceSGL" class="form-input w-20" placeholder="100" min="0" step="1" disabled>
                                    <span class="text-sm text-gray-500">/ ночь</span>
                                </div>
                            </div>
                            
                            <!-- TWL - Двухместный -->
                            <div class="flex items-center justify-between py-2 border-b border-gray-200">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" id="roomTWL" class="rounded">
                                    <label for="roomTWL" class="font-medium">TWL - Двухместный</label>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span>$</span>
                                    <input type="number" id="priceTWL" class="form-input w-20" placeholder="150" min="0" step="1" disabled>
                                    <span class="text-sm text-gray-500">/ ночь</span>
                                </div>
                            </div>
                            
                            <!-- DBL - Двухспальный -->
                            <div class="flex items-center justify-between py-2">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" id="roomDBL" class="rounded">
                                    <label for="roomDBL" class="font-medium">DBL - Двухспальный</label>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span>$</span>
                                    <input type="number" id="priceDBL" class="form-input w-20" placeholder="180" min="0" step="1" disabled>
                                    <span class="text-sm text-gray-500">/ ночь</span>
                                </div>
                            </div>
                        </div>
                        <small class="text-gray-500 mt-2 block">Отметьте доступные типы номеров и укажите цену за ночь для каждого</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Город</label>
                        <input type="text" class="form-input" id="hotelCity" placeholder="Душанбе, Самарканд, Бишкек и т.д.">
                    </div>
                    
                    <!-- НОВОЕ: Секция типов питания с ценами -->
                    <div class="form-group">
                        <label class="form-label">Типы питания и цены</label>
                        <div class="bg-gray-50 p-4 rounded-lg border">
                            <p class="text-sm text-gray-600 mb-3">Настройте доплату за питание в сутки (в USD)</p>
                            
                            <!-- RO - Без питания -->
                            <div class="flex items-center justify-between py-2 border-b border-gray-200">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" id="mealRO" class="rounded">
                                    <label for="mealRO" class="font-medium">RO - Без питания</label>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span>$</span>
                                    <input type="number" id="priceMealRO" class="form-input w-20" placeholder="0" min="0" step="1" disabled>
                                    <span class="text-sm text-gray-500">/ сутки</span>
                                </div>
                            </div>
                            
                            <!-- BB - Завтрак -->
                            <div class="flex items-center justify-between py-2 border-b border-gray-200">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" id="mealBB" class="rounded">
                                    <label for="mealBB" class="font-medium">BB - Завтрак</label>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span>$</span>
                                    <input type="number" id="priceMealBB" class="form-input w-20" placeholder="25" min="0" step="1" disabled>
                                    <span class="text-sm text-gray-500">/ сутки</span>
                                </div>
                            </div>
                            
                            <!-- HB - Полупансион -->
                            <div class="flex items-center justify-between py-2 border-b border-gray-200">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" id="mealHB" class="rounded">
                                    <label for="mealHB" class="font-medium">HB - Полупансион (завтрак + ужин)</label>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span>$</span>
                                    <input type="number" id="priceMealHB" class="form-input w-20" placeholder="45" min="0" step="1" disabled>
                                    <span class="text-sm text-gray-500">/ сутки</span>
                                </div>
                            </div>
                            
                            <!-- FB - Полный пансион -->
                            <div class="flex items-center justify-between py-2 border-b border-gray-200">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" id="mealFB" class="rounded">
                                    <label for="mealFB" class="font-medium">FB - Полный пансион (завтрак + обед + ужин)</label>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span>$</span>
                                    <input type="number" id="priceMealFB" class="form-input w-20" placeholder="65" min="0" step="1" disabled>
                                    <span class="text-sm text-gray-500">/ сутки</span>
                                </div>
                            </div>
                            
                            <!-- AI - Все включено -->
                            <div class="flex items-center justify-between py-2">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" id="mealAI" class="rounded">
                                    <label for="mealAI" class="font-medium">AI - Все включено</label>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span>$</span>
                                    <input type="number" id="priceMealAI" class="form-input w-20" placeholder="85" min="0" step="1" disabled>
                                    <span class="text-sm text-gray-500">/ сутки</span>
                                </div>
                            </div>
                        </div>
                        <small class="text-gray-500 mt-2 block">Отметьте доступные типы питания и укажите доплату за питание в сутки</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Фотографии отеля</label>
                        <div id="hotel-uploader-container"></div>
                        <input type="hidden" id="hotelImages">
                        <!-- Список загруженных изображений отеля -->
                        <div id="hotelImagesList" class="mt-3">
                            <p class="text-gray-500 text-sm">Нет загруженных изображений</p>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Удобства</label>
                        <div class="checkbox-group" id="hotelAmenities">
                            <label class="checkbox-item">
                                <input type="checkbox" value="WiFi"> WiFi
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="Завтрак"> Завтрак
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="Парковка"> Парковка
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="Ресторан"> Ресторан
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="Бассейн"> Бассейн
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="Спа"> Спа
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="Фитнес-центр"> Фитнес-центр
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="Кондиционер"> Кондиционер
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="Мини-бар"> Мини-бар
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="Трансфер"> Трансфер
                            </label>
                        </div>
                        <div class="mt-3 flex gap-2">
                            <input type="text" class="form-input flex-1" id="newAmenity" placeholder="Введите название нового удобства">
                            <button type="button" onclick="addNewAmenity()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md">
                                <i class="fas fa-plus"></i> Добавить
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="hotelActive" checked> Активный
                        </label>
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeHotelModal()" class="btn btn-secondary">
                        Отмена
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        Сохранить
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tour Modal -->
    <div id="tourModal" class="modal">
        <div class="modal-content" style="width: 800px;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold">Добавить/Редактировать тур</h2>
                <button onclick="closeTourModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="tourForm">
                <!-- Скрытое поле для ID тура -->
                <input type="hidden" id="tour-id">
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group col-span-2">
                        <label class="form-label">Тип тура</label>
                        <select class="form-input" id="tourType" required>
                            <option value="">Выберите тип тура</option>
                            <option value="Персональный">Персональный</option>
                            <option value="Групповой персональный">Групповой персональный</option>
                            <option value="Групповой общий">Групповой общий</option>
                        </select>
                    </div>
                    
                    <div class="form-group col-span-2">
                        <label class="form-label">Название тура (Русский)</label>
                        <input type="text" class="form-input" id="tourTitleRu" required>
                    </div>
                    
                    <div class="form-group col-span-2">
                        <label class="form-label">Название тура (English)</label>
                        <input type="text" class="form-input" id="tourTitleEn" required>
                    </div>
                    
                    <div class="form-group col-span-2">
                        <label class="form-label">Описание (Русский)</label>
                        <textarea class="form-input" rows="4" id="tourDescRu" required></textarea>
                    </div>
                    
                    <div class="form-group col-span-2">
                        <label class="form-label">Описание (English)</label>
                        <textarea class="form-input" rows="4" id="tourDescEn" required></textarea>
                    </div>

                    <!-- Что включено -->
                    <div class="form-group col-span-2">
                        <label class="form-label">Что включено в тур</label>
                        <div id="highlightsList" class="space-y-2 mb-3">
                            <!-- Динамически добавляемые элементы -->
                        </div>
                        <div class="flex gap-2">
                            <input type="text" class="form-input flex-1" id="newHighlight" placeholder="Например: Профессиональный гид">
                            <button type="button" onclick="addHighlight()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                                Добавить
                            </button>
                        </div>
                        <small class="text-gray-500">Добавьте пункты списка "Что включено"</small>
                    </div>

                    <!-- Программа тура -->
                    <div class="form-group col-span-2">
                        <label class="form-label">Программа тура</label>
                        <div id="itineraryList" class="space-y-3 mb-3">
                            <!-- Динамически добавляемые элементы -->
                        </div>
                        <div class="bg-gray-50 p-4 rounded border">
                            <div class="grid grid-cols-4 gap-3 mb-3">
                                <input type="time" class="form-input" id="newItineraryTime" placeholder="08:00">
                                <input type="text" class="form-input col-span-2" id="newItineraryTitle" placeholder="Встреча с гидом">
                                <button type="button" onclick="addItinerary()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                                    Добавить
                                </button>
                            </div>
                            <textarea class="form-input" rows="2" id="newItineraryDesc" placeholder="Подробное описание этапа программы"></textarea>
                        </div>
                        <small class="text-gray-500">Создайте расписание тура по времени</small>
                    </div>

                    <!-- Доступное время начала тура -->
                    <div class="form-group col-span-2">
                        <label class="form-label">Доступное время начала тура</label>
                        <div id="startTimesList" class="space-y-2 mb-3">
                            <!-- Динамически добавляемые варианты времени -->
                        </div>
                        <div class="flex gap-2">
                            <input type="time" class="form-input flex-1" id="newStartTime" placeholder="07:30">
                            <button type="button" onclick="addStartTime()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded">
                                Добавить время
                            </button>
                        </div>
                        <small class="text-gray-500">Добавьте возможные варианты времени начала тура</small>
                    </div>

                    
                    <div class="form-group">
                        <label class="form-label">Категории тура</label>
                        <div class="flex gap-2 mb-2">
                            <select class="form-input flex-1" id="availableCategories">
                                <option value="">Выберите категорию для добавления</option>
                            </select>
                            <button type="button" onclick="addCategoryToTour()" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-md">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div id="selectedCategories" class="space-y-1 max-h-32 overflow-y-auto border rounded p-2 bg-gray-50">
                            <small class="text-gray-500">Выбранные категории появятся здесь</small>
                        </div>
                        <input type="hidden" id="tourCategory" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Блок тура</label>
                        <select class="form-input" id="tourBlockId">
                            <option value="">Выберите блок</option>
                            <option value="1">Популярные туры</option>
                            <option value="2">Рекомендованные туры по Центральной Азии</option>
                            <option value="3">Туры по Таджикистану</option>
                            <option value="4">Туры по Узбекистану</option>
                            <option value="5">Туры по Киргизстану</option>
                            <option value="6">Туры по Туркменистану</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Страна</label>
                        <select class="form-input" id="tourCountry" required>
                            <option value="">Выберите страну</option>
                            <option value="Таджикистан">Таджикистан</option>
                            <option value="Узбекистан">Узбекистан</option>
                            <option value="Казахстан">Казахстан</option>
                            <option value="Кыргызстан">Кыргызстан</option>
                            <option value="Туркменистан">Туркменистан</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Город</label>
                        <input type="text" class="form-input" id="tourCity" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Длительность (дней)</label>
                        <input type="number" class="form-input" id="tourDurationDays" min="1" required>
                    </div>
                    
                    
                    
                    <!-- Component-based Pricing System -->
                    <div class="form-group col-span-2">
                        <label class="form-label">Компоненты тура и цены (TJS)</label>
                        <div class="border rounded-lg p-4 bg-gray-50">
                            <div class="mb-3 text-sm text-gray-600">
                                Отметьте нужные компоненты и настройте цены за ночь для каждого типа
                            </div>
                            
                            <!-- Price Components Selection with Inline Price Editing -->
                            <div id="tourPricingComponents" class="space-y-4">
                                <div class="text-center text-gray-500 py-4">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>
                                    Загрузка компонентов цен...
                                </div>
                            </div>
                            
                            <!-- Calculated Total -->
                            <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold">Общая стоимость:</span>
                                    <span class="text-xl font-bold text-blue-600" id="calculatedTotalPrice">0 TJS</span>
                                </div>
                                <div class="mt-2">
                                    <label class="form-label">Тип цены</label>
                                    <select class="form-input" id="tourPriceType" required>
                                        <option value="за человека">За человека</option>
                                        <option value="за группу">За группу</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Hidden fields -->
                            <input type="hidden" id="tourPricingData" value="">
                            <input type="hidden" id="tourPrice" value="0">
                        </div>
                    </div>
                    
                    
                    <div class="form-group">
                        <label class="form-label">Информация о приёме/сборе</label>
                        <input type="text" class="form-input" id="tourPickupInfo" placeholder="Например: Приём включён, Место сбора: отель, и т.д." required>
                        <small class="text-gray-500">Укажите информацию о приёме/месте сбора для туристов</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Языки тура</label>
                        <div class="flex gap-2 mb-2">
                            <select class="form-input flex-1" id="availableLanguages">
                                <option value="">Выберите язык для добавления</option>
                                <option value="Русский">Русский</option>
                                <option value="Английский">Английский</option>
                                <option value="Таджикский">Таджикский</option>
                                <option value="Узбекский">Узбекский</option>
                                <option value="Киргизский">Киргизский</option>
                                <option value="Казахский">Казахский</option>
                                <option value="Туркменский">Туркменский</option>
                                <option value="Персидский">Персидский</option>
                                <option value="Арабский">Арабский</option>
                                <option value="Китайский">Китайский</option>
                                <option value="Французский">Французский</option>
                                <option value="Немецкий">Немецкий</option>
                                <option value="Испанский">Испанский</option>
                                <option value="Итальянский">Итальянский</option>
                            </select>
                            <button type="button" onclick="addLanguageToTour()" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-md">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div id="selectedLanguages" class="space-y-1 max-h-32 overflow-y-auto border rounded p-2 bg-gray-50">
                            <small class="text-gray-500">Выбранные языки появятся здесь</small>
                        </div>
                        <input type="hidden" id="tourLanguages">
                    </div>
                    
                    
                    <!-- Дополнительная информация о туре -->
                    
                    
                    <!-- Поле сложности тура удалено по требованию пользователя -->
                    
                    <div class="form-group">
                        <label class="form-label">Минимальное количество людей</label>
                        <input type="number" class="form-input" id="tourMinPeople" min="1" placeholder="2">
                        <small class="text-gray-500">Минимальное количество участников</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Максимальное количество людей</label>
                        <input type="number" class="form-input" id="tourMaxPeople" min="1" placeholder="12">
                        <small class="text-gray-500">Максимальное количество участников</small>
                    </div>
                    
                    <!-- Доступность тура -->
                    <div class="form-group col-span-2">
                        <label class="form-label">Доступные месяцы</label>
                        <div class="grid grid-cols-4 gap-2 mt-2">
                            <label class="checkbox-item">
                                <input type="checkbox" value="1" id="month-1"> Январь
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="2" id="month-2"> Февраль
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="3" id="month-3"> Март
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="4" id="month-4"> Апрель
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="5" id="month-5"> Май
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="6" id="month-6"> Июнь
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="7" id="month-7"> Июль
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="8" id="month-8"> Август
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="9" id="month-9"> Сентябрь
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="10" id="month-10"> Октябрь
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="11" id="month-11"> Ноябрь
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="12" id="month-12"> Декабрь
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group col-span-2">
                        <label class="form-label">Доступные дни недели</label>
                        <div class="grid grid-cols-4 gap-2 mt-2">
                            <label class="checkbox-item">
                                <input type="checkbox" value="1" id="day-1"> Понедельник
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="2" id="day-2"> Вторник
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="3" id="day-3"> Среда
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="4" id="day-4"> Четверг
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="5" id="day-5"> Пятница
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="6" id="day-6"> Суббота
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="0" id="day-0"> Воскресенье
                            </label>
                        </div>
                    </div>
                    
                    <!-- Галерея изображений -->
                    <div class="form-group col-span-2">
                        <label class="form-label">
                            <i class="fas fa-images text-blue-600 mr-2"></i>
                            Фотографии тура
                        </label>
                        
                        <div id="tour-uploader-container"></div>
                        <p class="text-gray-500 text-sm mt-2">
                            Первая загруженная фотография автоматически станет главной для карточки тура
                        </p>
                        <input type="hidden" id="tourImages">
                        
                        <!-- Список галереи для редактирования -->
                        <div id="galleryImagesList" class="space-y-2 mt-4">
                            <!-- Загруженные изображения для редактирования появятся здесь -->
                        </div>
                    </div>
                    
                    <div class="form-group col-span-2">
                        <label class="form-label">Услуги включенные в тур</label>
                        <div class="checkbox-group" id="includesOptions">
                            <label class="checkbox-item">
                                <input type="checkbox" value="Трансфер"> Трансфер
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="Проживание"> Проживание
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="Питание"> Питание
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="Гид"> Гид
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="Входные билеты"> Входные билеты
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" value="Страховка"> Страховка
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group col-span-2">
                        <label class="form-label">Связанные отели</label>
                        <div class="checkbox-group" id="hotelCheckboxes">
                            <!-- Hotels will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="form-group col-span-2">
                        <label class="form-label">Доступные гиды</label>
                        <div class="checkbox-group" id="guideCheckboxes">
                            <!-- Guides will be loaded here -->
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeTourModal()" class="btn btn-secondary">
                        Отмена
                    </button>
                    <button type="submit" class="btn btn-primary" onclick="createFullTour(event)">
                        <i class="fas fa-save"></i>
                        Сохранить
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Category List Modal -->
    <div id="categoryListModal" class="modal">
        <div class="modal-content max-w-md">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold">Выберите категорию</h2>
                <button type="button" onclick="closeCategoryListModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="space-y-2 max-h-96 overflow-y-auto">
                    <div class="category-item p-3 border rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-300" onclick="selectCategory('Однодневные туры', 'Day Tours')">
                        <div class="font-medium">Однодневные туры</div>
                        <div class="text-sm text-gray-500">Day Tours</div>
                    </div>
                    <div class="category-item p-3 border rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-300" onclick="selectCategory('Многодневные туры', 'Multi-day Tours')">
                        <div class="font-medium">Многодневные туры</div>
                        <div class="text-sm text-gray-500">Multi-day Tours</div>
                    </div>
                    <div class="category-item p-3 border rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-300" onclick="selectCategory('Экскурсии', 'Excursions')">
                        <div class="font-medium">Экскурсии</div>
                        <div class="text-sm text-gray-500">Excursions</div>
                    </div>
                    <div class="category-item p-3 border rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-300" onclick="selectCategory('Городские туры', 'City Tours')">
                        <div class="font-medium">Городские туры</div>
                        <div class="text-sm text-gray-500">City Tours</div>
                    </div>
                    <div class="category-item p-3 border rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-300" onclick="selectCategory('Природа/экологические туры', 'Nature/Eco Tours')">
                        <div class="font-medium">Природа/экологические туры</div>
                        <div class="text-sm text-gray-500">Nature/Eco Tours</div>
                    </div>
                    <div class="category-item p-3 border rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-300" onclick="selectCategory('Культурно познавательные туры', 'Cultural Educational Tours')">
                        <div class="font-medium">Культурно познавательные туры</div>
                        <div class="text-sm text-gray-500">Cultural Educational Tours</div>
                    </div>
                    <div class="category-item p-3 border rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-300" onclick="selectCategory('Исторические туры', 'Historical Tours')">
                        <div class="font-medium">Исторические туры</div>
                        <div class="text-sm text-gray-500">Historical Tours</div>
                    </div>
                    <div class="category-item p-3 border rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-300" onclick="selectCategory('Походы/трекинги', 'Hiking/Trekking')">
                        <div class="font-medium">Походы/трекинги</div>
                        <div class="text-sm text-gray-500">Hiking/Trekking</div>
                    </div>
                    <div class="category-item p-3 border rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-300" onclick="selectCategory('Горные ландшафты', 'Mountain Landscapes')">
                        <div class="font-medium">Горные ландшафты</div>
                        <div class="text-sm text-gray-500">Mountain Landscapes</div>
                    </div>
                    <div class="category-item p-3 border rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-300" onclick="selectCategory('Озерные ландшафты', 'Lake Landscapes')">
                        <div class="font-medium">Озерные ландшафты</div>
                        <div class="text-sm text-gray-500">Lake Landscapes</div>
                    </div>
                    <div class="category-item p-3 border rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-300" onclick="selectCategory('Приключенческие туры', 'Adventure Tours')">
                        <div class="font-medium">Приключенческие туры</div>
                        <div class="text-sm text-gray-500">Adventure Tours</div>
                    </div>
                    <div class="category-item p-3 border rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-300" onclick="selectCategory('Гастрономические туры', 'Gastronomic Tours')">
                        <div class="font-medium">Гастрономические туры</div>
                        <div class="text-sm text-gray-500">Gastronomic Tours</div>
                    </div>
                    <div class="category-item p-3 border rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-300" onclick="selectCategory('Автотуры/сафари/джип-туры', 'Auto Tours/Safari/Jeep Tours')">
                        <div class="font-medium">Автотуры/сафари/джип-туры</div>
                        <div class="text-sm text-gray-500">Auto Tours/Safari/Jeep Tours</div>
                    </div>
                    <div class="category-item p-3 border rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-300" onclick="selectCategory('Агротуры', 'Agro Tours')">
                        <div class="font-medium">Агротуры</div>
                        <div class="text-sm text-gray-500">Agro Tours</div>
                    </div>
                    <div class="category-item p-3 border rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-300" onclick="selectCategory('VIP туры', 'VIP Tours')">
                        <div class="font-medium">VIP туры</div>
                        <div class="text-sm text-gray-500">VIP Tours</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking Details Modal -->
    <div id="bookingModal" class="modal">
        <div class="modal-content" style="width: 700px;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold">Детали заказа</h2>
                <button onclick="closeBookingModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="bookingDetails">
                <!-- Booking details will be loaded here -->
            </div>
            
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeBookingModal()" class="btn btn-secondary">
                    Закрыть
                </button>
                <button onclick="confirmBooking()" class="btn btn-success">
                    <i class="fas fa-check"></i>
                    Подтвердить
                </button>
                <button onclick="cancelBooking()" class="btn btn-danger">
                    <i class="fas fa-times"></i>
                    Отменить
                </button>
            </div>
        </div>
    </div>

    <!-- Content Block Modal -->
    <div id="contentBlockModal" class="modal">
        <div class="modal-content" style="width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold" id="contentBlockModalTitle">Добавить блок контента</h2>
                <button onclick="closeContentBlockModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="contentBlockForm">
                <div class="grid grid-cols-1 gap-4">
                    <div class="form-group">
                        <label class="form-label">Тип блока</label>
                        <select class="form-input" id="blockType" required>
                            <option value="">Выберите тип</option>
                            <option value="hero_banner">Главный баннер</option>
                            <option value="about_section">О нас</option>
                            <option value="services_section">Услуги</option>
                            <option value="tours_section">Туры</option>
                            <option value="testimonials">Отзывы</option>
                            <option value="contact_info">Контакты</option>
                            <option value="footer_text">Текст футера</option>
                            <option value="custom">Пользовательский</option>
                        </select>
                    </div>
                    
                    <!-- Multilingual fields for each supported language -->
                    <div class="form-group">
                        <label class="form-label">Заголовок (Русский)</label>
                        <input type="text" class="form-input" id="blockTitle_ru">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Заголовок (English)</label>
                        <input type="text" class="form-input" id="blockTitle_en">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Заголовок (Тоҷикӣ)</label>
                        <input type="text" class="form-input" id="blockTitle_tj">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Заголовок (فارسی)</label>
                        <input type="text" class="form-input" id="blockTitle_fa">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Заголовок (Deutsch)</label>
                        <input type="text" class="form-input" id="blockTitle_de">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Заголовок (中文)</label>
                        <input type="text" class="form-input" id="blockTitle_zh">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Содержание (Русский)</label>
                        <textarea class="form-input" rows="4" id="blockContent_ru"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Содержание (English)</label>
                        <textarea class="form-input" rows="4" id="blockContent_en"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Содержание (Тоҷикӣ)</label>
                        <textarea class="form-input" rows="4" id="blockContent_tj"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Содержание (فارسی)</label>
                        <textarea class="form-input" rows="4" id="blockContent_fa"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Содержание (Deutsch)</label>
                        <textarea class="form-input" rows="4" id="blockContent_de"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Содержание (中文)</label>
                        <textarea class="form-input" rows="4" id="blockContent_zh"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Порядок отображения</label>
                        <input type="number" class="form-input" id="blockOrder" min="0" value="0">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="blockActive" checked>
                            Активен
                        </label>
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="closeContentBlockModal()" class="btn btn-secondary">
                        Отмена
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i>
                        Сохранить
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="components/ObjectUploader.js"></script>
    <script>
        // Global variables
        let currentSection = 'dashboard';
        let currentBookingId = null;
        let currentTourId = null;
        let currentContentBlockId = null;
        
        // API URL Configuration
        function getApiUrl() {
            const hostname = window.location.hostname;
            const protocol = window.location.protocol;
            
            console.log('Current location:', {
                hostname: hostname,
                protocol: protocol,
                port: window.location.port,
                href: window.location.href
            });
            
            // Always use relative URL for unified server
            return '/api';
            
        }

        // Authorization helper
        function getAuthHeaders() {
            const token = localStorage.getItem('authToken');
            if (token) {
                return {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                };
            }
            return {
                'Content-Type': 'application/json'
            };
        }
        
        // Authentication
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            console.log('🔐 Login form submitted');
            e.preventDefault();
            const usernameElement = document.getElementById('username');
            const passwordElement = document.getElementById('password');
            
            if (!usernameElement || !passwordElement) {
                alert('Ошибка формы входа');
                return;
            }
            
            const username = usernameElement.value;
            const password = passwordElement.value;
            
            console.log('📝 Username:', username);
            console.log('🔒 Password length:', password.length);
            
            // API login using unified server
            const apiUrl = getApiUrl();
            console.log('🌐 API URL:', apiUrl);
            
            fetch(`${apiUrl}/admin/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username, password })
            })
            .then(res => {
                console.log('📡 Response status:', res.status);
                return res.json();
            })
            .then(data => {
                console.log('📊 Response data:', data);
                if (data.success) {
                    console.log('✅ Login successful, storing token');
                    localStorage.setItem('authToken', data.data.token);
                    localStorage.setItem('user', JSON.stringify(data.data.admin));
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('adminDashboard').style.display = 'block';
                    loadDashboard();
                } else {
                    console.log('❌ Login failed:', data.message);
                    alert('Неверные учетные данные: ' + (data.message || 'Ошибка авторизации'));
                }
            })
            .catch(err => {
                console.error('🚨 Login error:', err);
                alert('Ошибка соединения с сервером: ' + err.message);
            });
        });
        
        function logout() {
            if (confirm('Вы уверены, что хотите выйти?')) {
                localStorage.removeItem('authToken');
                localStorage.removeItem('user');
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('adminDashboard').style.display = 'none';
            }
        }
        
        // Navigation
        document.querySelectorAll('.nav-item[data-section]').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const section = this.dataset.section;
                switchSection(section);
                
                // Update active state
                document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                this.classList.add('active');
            });
        });
        
        function switchSection(section) {
            // Hide all sections
            document.querySelectorAll('section').forEach(sec => sec.style.display = 'none');
            
            // Show selected section
            const sectionElement = document.getElementById(section + 'Section');
            if (sectionElement) {
                sectionElement.style.display = 'block';
            }
            
            // Update title
            const titles = {
                dashboard: 'Главная',
                tours: 'Управление турами',
                bookings: 'Управление заказами',
                hotels: 'Управление отелями',
                guides: 'Управление гидами',
                customers: 'Клиенты',
                reviews: 'Модерация отзывов',
                payments: 'Платежи',
                cms: 'CMS - Управление контентом',
                settings: 'Настройки'
            };
            document.getElementById('sectionTitle').textContent = titles[section] || 'Админ-панель';
            
            // Load section data
            switch(section) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'tours':
                    loadTours();
                    break;
                case 'bookings':
                    loadBookings();
                    break;
                case 'hotels':
                    loadHotels();
                    break;
                case 'guides':
                    loadGuides();
                    break;
                case 'reviews':
                    loadReviews();
                    break;
                case 'cms':
                    loadCMSContentBlocks();
                    break;
            }
        }
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('sidebar').classList.toggle('collapsed');
            document.getElementById('mainContent').classList.toggle('expanded');
        }
        
        // Dashboard functions
        function loadDashboard() {
            loadDashboardStats();
            loadRecentOrders();
            loadCharts();
        }
        
        function loadDashboardStats() {
            // Check if user is authenticated first
            const token = localStorage.getItem('authToken');
            if (!token) {
                console.log('No auth token found, user needs to login');
                return;
            }
            
            // Use the new dedicated dashboard stats endpoint
            fetch(`${getApiUrl()}/admin/dashboard-stats`, { 
                headers: getAuthHeaders() 
            })
                .then(response => {
                    if (response.status === 401 || response.status === 403) {
                        // Token is invalid, redirect to login
                        console.log('Token invalid, redirecting to login');
                        logout();
                        return null;
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data) return; // Handle logout case
                    
                    console.log('Dashboard stats loaded:', data);
                    if (data.success) {
                        const stats = data.data.stats;
                        const revenue = data.data.recentOrders.reduce((total, order) => 
                            total + (parseFloat(order.totalAmount) || 0), 0);
                        
                        // Обновить статистические карточки
                        const statsCards = document.querySelectorAll('.stat-card h3');
                        if (statsCards.length >= 4) {
                            statsCards[0].textContent = stats.tours || 0;
                            statsCards[1].textContent = stats.orders || 0; 
                            statsCards[2].textContent = '$' + revenue.toFixed(2);
                            statsCards[3].textContent = stats.customers || 0;
                        }
                    } else {
                        console.error('Dashboard stats API error:', data.message);
                        // Show default values if API fails
                        showDefaultStats();
                    }
                })
                .catch(err => {
                    console.error('Error loading dashboard stats:', err);
                    showDefaultStats();
                });
        }
        
        function showDefaultStats() {
            const statsCards = document.querySelectorAll('.stat-card h3');
            if (statsCards.length >= 4) {
                statsCards[0].textContent = '-';
                statsCards[1].textContent = '-';
                statsCards[2].textContent = '$0.00';
                statsCards[3].textContent = '-';
            }
        }
        
        function loadRecentOrders() {
            fetch(`${getApiUrl()}/orders?limit=5`, {
                headers: getAuthHeaders()
            })
                .then(res => res.json())
                .then(data => {
                    const tbody = document.getElementById('recentOrdersTable');
                    const orders = data.data || data.orders || [];
                    if (orders.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500">Нет заказов</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = orders.map(order => `
                        <tr>
                            <td class="font-medium">${order.orderNumber || 'N/A'}</td>
                            <td>${order.customer?.fullName || 'Неизвестно'}</td>
                            <td>${getTourName(order.tour)}</td>
                            <td>${formatDate(order.createdAt)}</td>
                            <td class="font-semibold">$${order.totalAmount}</td>
                            <td>${getStatusBadge(order.status)}</td>
                            <td>
                                <button onclick="viewBooking(${order.id})" class="text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                })
                .catch(err => {
                    console.error('Error loading orders:', err);
                    document.getElementById('recentOrdersTable').innerHTML = 
                        '<tr><td colspan="7" class="text-center text-red-500">Ошибка загрузки данных</td></tr>';
                });
        }
        
        function loadCharts() {
            // Sales Chart
            const salesCtx = document.getElementById('salesChart');
            if (salesCtx) {
                new Chart(salesCtx, {
                    type: 'line',
                    data: {
                        labels: ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн'],
                        datasets: [{
                            label: 'Продажи',
                            data: [12000, 19000, 15000, 25000, 22000, 30000],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            // Destinations Chart
            const destCtx = document.getElementById('destinationsChart');
            if (destCtx) {
                new Chart(destCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Таджикистан', 'Узбекистан', 'Казахстан', 'Кыргызстан'],
                        datasets: [{
                            data: [45, 25, 20, 10],
                            backgroundColor: ['#667eea', '#10b981', '#f59e0b', '#ef4444']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
        }
        
        // Global variables for selected items
        let selectedCategories = [];
        let selectedLanguages = [];
        
        // Инициализация всех глобальных переменных
        window.tourLanguages = window.tourLanguages || [];
        window.tourHighlights = window.tourHighlights || [];
        window.tourItinerary = window.tourItinerary || [];
        window.tourStartTimes = window.tourStartTimes || [];
        window.editStartTimes = window.editStartTimes || [];
        window.tourGalleryImages = window.tourGalleryImages || [];
        window.uploadedTourImages = window.uploadedTourImages || [];

        // Load categories from API
        function loadCategories() {
            return fetch(`${getApiUrl()}/categories`, {
                headers: getAuthHeaders()
            })
                .then(res => res.json())
                .then(data => {
                    const categories = data.data || data.categories || [];
                    
                    // Update available categories select
                    const availableSelect = document.getElementById('availableCategories');
                    if (availableSelect) {
                        // If no categories, add predefined ones
                        if (categories.length === 0) {
                            availableSelect.innerHTML = `
                                <option value="">Выберите категорию для добавления</option>
                                <option value="add_day_tours" data-name="Однодневные туры">Однодневные туры (создать)</option>
                                <option value="add_multi_day_tours" data-name="Многодневные туры">Многодневные туры (создать)</option>
                                <option value="add_excursions" data-name="Экскурсии">Экскурсии (создать)</option>
                                <option value="add_city_tours" data-name="Городские туры">Городские туры (создать)</option>
                                <option value="add_nature_eco_tours" data-name="Природа/экологические туры">Природа/экологические туры (создать)</option>
                                <option value="add_cultural_tours" data-name="Культурно познавательные туры">Культурно познавательные туры (создать)</option>
                                <option value="add_historical_tours" data-name="Исторические туры">Исторические туры (создать)</option>
                                <option value="add_hiking_trekking" data-name="Походы/трекинги">Походы/трекинги (создать)</option>
                                <option value="add_mountain_landscapes" data-name="Горные ландшафты">Горные ландшафты (создать)</option>
                                <option value="add_lake_landscapes" data-name="Озерные ландшафты">Озерные ландшафты (создать)</option>
                                <option value="add_adventure_tours" data-name="Приключенческие туры">Приключенческие туры (создать)</option>
                                <option value="add_gastronomic_tours" data-name="Гастрономические туры">Гастрономические туры (создать)</option>
                                <option value="add_auto_tours" data-name="Автотуры/сафари/джип-туры">Автотуры/сафари/джип-туры (создать)</option>
                                <option value="add_agro_tours" data-name="Агротуры">Агротуры (создать)</option>
                                <option value="add_vip_tours" data-name="VIP туры">VIP туры (создать)</option>
                            `;
                        } else {
                            availableSelect.innerHTML = '<option value="">Выберите категорию для добавления</option>' +
                                categories.map(cat => {
                                    let categoryName;
                                    try {
                                        if (cat.name && typeof cat.name === 'string') {
                                            const parsed = JSON.parse(cat.name);
                                            categoryName = parsed.ru || parsed.en || 'Безымянная категория';
                                        } else if (cat.name && cat.name.ru) {
                                            categoryName = cat.name.ru;
                                        } else if (cat.title) {
                                            const parsed = typeof cat.title === 'string' ? JSON.parse(cat.title) : cat.title;
                                            categoryName = parsed.ru || parsed.en || 'Безымянная категория';
                                        } else {
                                            categoryName = 'Безымянная категория';
                                        }
                                    } catch (e) {
                                        categoryName = cat.name || cat.title || 'Безымянная категория';
                                    }
                                    return `<option value="${cat.id}" data-name="${categoryName}">${categoryName}</option>`;
                                }).join('');
                        }
                    }
                    
                    // Update enhanced tour category select (if exists)
                    const enhancedSelect = document.getElementById('eTourCategoryId');
                    if (enhancedSelect) {
                        enhancedSelect.innerHTML = '<option value="">Выберите категорию</option>' +
                            categories.map(cat => {
                                let categoryName;
                                try {
                                    if (cat.name && typeof cat.name === 'string') {
                                        const parsed = JSON.parse(cat.name);
                                        categoryName = parsed.ru || parsed.en || 'Безымянная категория';
                                    } else if (cat.name && cat.name.ru) {
                                        categoryName = cat.name.ru;
                                    } else if (cat.title) {
                                        const parsed = typeof cat.title === 'string' ? JSON.parse(cat.title) : cat.title;
                                        categoryName = parsed.ru || parsed.en || 'Безымянная категория';
                                    } else {
                                        categoryName = 'Безымянная категория';
                                    }
                                } catch (e) {
                                    categoryName = cat.name || cat.title || 'Безымянная категория';
                                }
                                return `<option value="${cat.id}">${categoryName}</option>`;
                            }).join('');
                    }
                    
                    return categories;
                })
                .catch(err => {
                    console.error('Error loading categories:', err);
                    return [];
                });
        }

        // Инициализация глобальных переменных для нового тура
        window.tourHighlights = [];
        window.tourItinerary = [];
        window.tourStartTimes = [];
        window.editStartTimes = [];

        // Функции управления "Что включено"
        function addHighlight() {
            const input = document.getElementById('newHighlight');
            const text = input.value.trim();
            
            if (text) {
                window.tourHighlights.push(text);
                updateHighlightsList();
                input.value = '';
            }
        }

        function removeHighlight(index) {
            window.tourHighlights.splice(index, 1);
            updateHighlightsList();
        }

        function updateHighlightsList() {
            const highlightsContainer = document.getElementById('highlightsList');
            if (!highlightsContainer) {
                console.warn('highlightsList container not found');
                return;
            }
            highlightsContainer.innerHTML = window.tourHighlights.map((highlight, index) => `
                <div class="flex items-center justify-between bg-gray-50 p-2 rounded">
                    <span>✓ ${highlight}</span>
                    <button type="button" onclick="removeHighlight(${index})" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        // Инициализация глобальных переменных для галереи
        window.tourGalleryImages = window.tourGalleryImages || [];

        // Функции управления галереей изображений
        function addGalleryImage() {
            const imageUrlInput = document.getElementById('newImageUrl');
            const imageUrl = imageUrlInput.value.trim();
            
            if (imageUrl && !window.tourGalleryImages.includes(imageUrl)) {
                window.tourGalleryImages.push(imageUrl);
                updateGalleryImagesList();
                imageUrlInput.value = '';
            } else if (window.tourGalleryImages.includes(imageUrl)) {
                alert('Это изображение уже добавлено');
            } else {
                alert('Пожалуйста, введите корректный URL изображения');
            }
        }

        function removeGalleryImage(index) {
            window.tourGalleryImages.splice(index, 1);
            updateGalleryImagesList();
        }

        function updateGalleryImagesList() {
            const galleryContainer = document.getElementById('galleryImagesList');
            if (!galleryContainer) {
                console.warn('galleryImagesList container not found');
                return;
            }
            galleryContainer.innerHTML = window.tourGalleryImages.map((imageUrl, index) => `
                <div class="flex items-center justify-between bg-gray-50 p-3 rounded border">
                    <div class="flex items-center gap-3">
                        <img src="${imageUrl}" alt="Preview" class="w-12 h-12 object-cover rounded" onerror="this.style.display='none';">
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-medium text-gray-900 truncate">${imageUrl}</div>
                        </div>
                    </div>
                    <button type="button" onclick="removeGalleryImage(${index})" class="text-red-500 hover:text-red-700 ml-2">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        // Initialize global variable for uploaded tour images
        window.uploadedTourImages = [];

        // Function to handle file upload for tour images
        function handleTourImageUpload(input) {
            const files = input.files;
            if (!files || files.length === 0) return;
            
            window.uploadedTourImages = []; // Reset uploaded images
            const previewContainer = document.getElementById('tourImagePreview');
            previewContainer.innerHTML = '';
            
            Array.from(files).forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        window.uploadedTourImages.push({
                            file: file,
                            dataURL: e.target.result,
                            isMain: index === 0 // First image becomes main image
                        });
                        
                        // Create preview element
                        const previewDiv = document.createElement('div');
                        previewDiv.className = 'relative border rounded-lg overflow-hidden';
                        
                        previewDiv.innerHTML = `
                            <img src="${e.target.result}" alt="Preview ${index + 1}" class="w-full h-32 object-cover">
                            <div class="absolute top-2 left-2">
                                ${index === 0 ? '<span class="bg-green-500 text-white text-xs px-2 py-1 rounded">Главное</span>' : ''}
                            </div>
                            <button type="button" onclick="removeUploadedImage(${index})" 
                                    class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600">
                                <i class="fas fa-times text-xs"></i>
                            </button>
                            <div class="p-2 bg-gray-50">
                                <p class="text-xs text-gray-600 truncate">${file.name}</p>
                            </div>
                        `;
                        
                        previewContainer.appendChild(previewDiv);
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Show preview container
            if (files.length > 0) {
                previewContainer.style.display = 'grid';
            }
        }

        // Function to remove uploaded image
        function removeUploadedImage(index) {
            window.uploadedTourImages.splice(index, 1);
            
            // Reassign main image (first one becomes main)
            if (window.uploadedTourImages.length > 0) {
                window.uploadedTourImages[0].isMain = true;
                window.uploadedTourImages.forEach((img, i) => {
                    if (i > 0) img.isMain = false;
                });
            }
            
            // Update preview
            const previewContainer = document.getElementById('tourImagePreview');
            previewContainer.innerHTML = '';
            
            window.uploadedTourImages.forEach((imageData, i) => {
                const previewDiv = document.createElement('div');
                previewDiv.className = 'relative border rounded-lg overflow-hidden';
                
                previewDiv.innerHTML = `
                    <img src="${imageData.dataURL}" alt="Preview ${i + 1}" class="w-full h-32 object-cover">
                    <div class="absolute top-2 left-2">
                        ${i === 0 ? '<span class="bg-green-500 text-white text-xs px-2 py-1 rounded">Главное</span>' : ''}
                    </div>
                    <button type="button" onclick="removeUploadedImage(${i})" 
                            class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                    <div class="p-2 bg-gray-50">
                        <p class="text-xs text-gray-600 truncate">${imageData.file.name}</p>
                    </div>
                `;
                
                previewContainer.appendChild(previewDiv);
            });
            
            if (window.uploadedTourImages.length === 0) {
                previewContainer.style.display = 'none';
                // Clear file input
                const tourImagesElement = document.getElementById('tourImages');
                if (tourImagesElement) tourImagesElement.value = '';
            }
        }

        // Главная функция создания тура с полными данными
        function createFullTour(event) {
            event.preventDefault();
            
            // Process uploaded images - convert to base64 or use URLs from uploaded images
            let mainImage = '';
            let allImages = [];
            
            if (window.uploadedTourImages && window.uploadedTourImages.length > 0) {
                // Use uploaded images
                const mainImageData = window.uploadedTourImages.find(img => img.isMain) || window.uploadedTourImages[0];
                mainImage = mainImageData.dataURL; // base64 data
                allImages = window.uploadedTourImages.map(img => img.dataURL);
            } else {
                // Fallback to old URL system (if no images uploaded)
                mainImage = '';
                allImages = [];
            }
            
            // Собираем включенные услуги из чекбоксов
            const serviceCheckboxes = document.querySelectorAll('.checkbox-group input[type="checkbox"]:checked');
            const includedServices = Array.from(serviceCheckboxes).map(cb => cb.value);
            
            // Формируем данные для отправки
            const tourData = {
                title: {
                    ru: document.getElementById('tourTitleRu')?.value || '',
                    en: document.getElementById('tourTitleEn')?.value || ''
                },
                description: {
                    ru: document.getElementById('tourDescRu')?.value || '',
                    en: document.getElementById('tourDescEn')?.value || ''
                },
                duration: '',  // Поле удалено из формы
                durationDays: parseInt(document.getElementById('tourDurationDays')?.value) || 1,
                price: document.getElementById('tourPrice')?.value || '',
                priceType: document.getElementById('tourPriceType')?.value || 'за человека',
                country: document.getElementById('tourCountry')?.value || '',
                city: document.getElementById('tourCity')?.value || '',
                categoryId: parseInt(document.getElementById('tourCategory')?.value) || null,
                tourBlockId: parseInt(document.getElementById('tourBlockId')?.value) || null,
                
                // Информация о туре
                pickupInfo: document.getElementById('tourPickupInfo')?.value || '',
                languages: document.getElementById('tourLanguages')?.value || '',
                // difficulty field removed per user request
                minPeople: parseInt(document.getElementById('tourMinPeople')?.value) || null,
                maxPeople: parseInt(document.getElementById('tourMaxPeople')?.value) || null,
                
                // Images - using uploaded files
                mainImage: mainImage || '',
                images: JSON.stringify(allImages),
                
                // Что включено
                includes: JSON.stringify(includedServices),
                
                // Программа тура  
                itinerary: JSON.stringify(window.tourItinerary || []),
                
                // Время начала
                startTimeOptions: JSON.stringify(window.tourStartTimes || []),
                
                // Доступность тура (месяцы и дни недели)
                availableMonths: JSON.stringify(getSelectedCheckboxValues('month-')),
                availableDays: JSON.stringify(getSelectedCheckboxValues('day-')),
                
                // Дополнительная информация из формы
                highlights: JSON.stringify(window.tourHighlights || [])
            };
            
            console.log('💾 Используем правильную функцию saveTourForm для основной формы');
            
            // Объединенная логика сохранения POST/PUT
            
            const titleRuElement = document.getElementById('tourTitleRu');
            if (!titleRuElement || !titleRuElement.value || titleRuElement.value.trim() === '') {
                alert('Пожалуйста, введите название тура на русском языке');
                return;
            }
            
            const tourPriceElement = document.getElementById('tourPrice');
            if (!tourPriceElement || !tourPriceElement.value || isNaN(parseFloat(tourPriceElement.value))) {
                alert('Пожалуйста, введите корректную цену тура');
                return;
            }
            
            const tourDurationElement = document.getElementById('tourDurationDays');
            if (!tourDurationElement || !tourDurationElement.value || isNaN(parseInt(tourDurationElement.value))) {
                alert('Пожалуйста, введите длительность тура в днях');
                return;
            }
            
            // Получаем ID тура из скрытого поля
            const tourId = document.getElementById('tour-id').value || '';
            
            // Определяем режим редактирования (boolean, не строка!)
            const isEditing = Boolean(tourId && tourId.trim() !== '');
            
            // Продолжаем с сохранением
            proceedWithTourSaving(isEditing, tourId);
        }
        
        // Функция продолжения сохранения тура
        function proceedWithTourSaving(isEditing, tourId) {
            console.log('🚀 Proceeding with tour saving:', { isEditing, tourId });
            
            // Безопасное получение значений с проверкой на null  
            const titleRuElement = document.getElementById('tourTitleRu');
            const titleEnElement = document.getElementById('tourTitleEn');
            const descRuElement = document.getElementById('tourDescRu');
            const descEnElement = document.getElementById('tourDescEn');
            const priceElement = document.getElementById('tourPrice');
            const durationElement = document.getElementById('tourDurationDays');
            
            const formData = {
                title: JSON.stringify({
                    ru: titleRuElement ? titleRuElement.value : '',
                    en: titleEnElement ? titleEnElement.value : (titleRuElement ? titleRuElement.value : '')
                }),
                shortDescription: JSON.stringify({
                    ru: descRuElement ? descRuElement.value : '',
                    en: descEnElement ? descEnElement.value : (descRuElement ? descRuElement.value : '')
                }),
                description: JSON.stringify({
                    ru: descRuElement ? descRuElement.value : '',
                    en: descEnElement ? descEnElement.value : (descRuElement ? descRuElement.value : '')
                }),
                price: priceElement ? parseFloat(priceElement.value) : 0,
                priceType: document.getElementById('tourPriceType')?.value || 'за человека',
                originalPrice: document.getElementById('tourOriginalPrice')?.value ? parseFloat(document.getElementById('tourOriginalPrice').value) : null,
                durationDays: durationElement ? parseInt(durationElement.value) : 1,
                format: document.getElementById('tourType')?.value,
                tourType: document.getElementById('tourType')?.value,
                difficulty: document.getElementById('tourDifficulty')?.value || 'Легкий',
                maxPeople: document.getElementById('tourMaxPeople')?.value ? parseInt(document.getElementById('tourMaxPeople').value) : null,
                minPeople: document.getElementById('tourMinPeople')?.value ? parseInt(document.getElementById('tourMinPeople').value) : null,
                country: document.getElementById('tourCountry')?.value,
                city: document.getElementById('tourCity')?.value,
                pickupInfo: document.getElementById('tourPickupInfo')?.value,
                mainImage: document.getElementById('tourMainImage')?.value,
                images: JSON.stringify(window.tourGalleryImages || []),
                highlights: JSON.stringify(window.tourHighlights || []),
                itinerary: JSON.stringify(window.tourItinerary || []),
                startTimeOptions: JSON.stringify(window.tourStartTimes || []),
                languages: JSON.stringify(window.tourLanguages || ['Русский']),
                availableMonths: JSON.stringify(getSelectedCheckboxValues('month-')),
                availableDays: JSON.stringify(getSelectedCheckboxValues('day-')),
                categoryId: selectedCategories.length > 0 ? selectedCategories[0].id : null,
                tourBlockId: document.getElementById('tourBlockId')?.value ? parseInt(document.getElementById('tourBlockId').value) : null,
                isFeatured: document.getElementById('tourIsFeatured')?.checked || false,
                isActive: true,
                // Собираем выбранные отели
                hotelIds: Array.from(document.querySelectorAll('input[name="selectedHotels"]:checked')).map(cb => parseInt(cb.value)),
                // Собираем выбранных гидов 
                guideIds: Array.from(document.querySelectorAll('input[name="selectedGuides"]:checked')).map(cb => parseInt(cb.value)),
                // Компоненты цены (новая система ценообразования)
                pricingComponents: document.getElementById('tourPricingData')?.value || '[]'
            };
            
            console.log('📤 Sending tour data:', formData);
            
            const apiUrl = getApiUrl();
            const url = isEditing ? `${apiUrl}/tours/${tourId}` : `${apiUrl}/tours`;
            const method = isEditing ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: getAuthHeaders(),
                body: JSON.stringify(formData)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    console.log('✅ Tour saved successfully');
                    alert(isEditing ? 'Тур успешно обновлён!' : 'Тур успешно создан!');
                    document.getElementById('tourModal').style.display = 'none';
                    loadTours(); // Обновляем список туров
                    resetTourForm(); // Очищаем форму
                } else {
                    console.error('❌ Failed to save tour:', data.message);
                    alert('Ошибка сохранения тура: ' + (data.message || 'Неизвестная ошибка'));
                }
            })
            .catch(err => {
                console.error('🚨 Error saving tour:', err);
                alert('Ошибка соединения с сервером: ' + err.message);
            });
        }
        
        // Функция сброса формы
        function resetTourForm() {
            // Очищаем глобальные массивы
            window.tourGalleryImages = [];
            window.tourHighlights = [];
            window.tourItinerary = [];
            window.tourStartTimes = [];
            window.editStartTimes = [];
            
            // Очищаем компоненты цены
            selectedTourComponents = [];
            document.getElementById('tourPricingData').value = '';
            document.getElementById('tourPrice').value = '0';
            document.getElementById('calculatedTotalPrice').textContent = '0 TJS';
            
            // Сбрасываем чекбоксы компонентов и цены
            document.querySelectorAll('#tourPricingComponents input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.querySelectorAll('#tourPricingComponents input[type="number"]').forEach(input => {
                if (input.id.startsWith('quantity_')) {
                    input.value = '1';
                }
            });
            document.querySelectorAll('[id^="quantity_container_"]').forEach(container => {
                container.style.display = 'none';
            });
            document.querySelectorAll('[id^="price_"]').forEach(priceInput => {
                priceInput.disabled = true;
                // Reset to original price from component data
                const componentId = priceInput.id.replace('price_', '');
                const component = tourPricingComponents.find(c => c.id == componentId);
                if (component) {
                    priceInput.value = component.price;
                }
            });
            
            // Обновляем отображение (updateIncludesList удален - используем чекбоксы)
            updateGalleryImagesList();
            updateHighlightsList();
            updateItineraryList();
            updateStartTimesList();
        }

        // Функции управления программой тура
        function addItinerary() {
            const time = document.getElementById('newItineraryTime').value;
            const itineraryTitle = document.getElementById('newItineraryTitle').value.trim();
            const desc = document.getElementById('newItineraryDesc').value.trim();
            
            if (time && itineraryTitle && desc) {
                window.tourItinerary.push({ time, title: itineraryTitle, description: desc });
                updateItineraryList();
                document.getElementById('newItineraryTime').value = '';
                document.getElementById('newItineraryTitle').value = '';
                document.getElementById('newItineraryDesc').value = '';
            } else {
                alert('Пожалуйста, заполните все поля программы тура');
            }
        }

        function removeItinerary(index) {
            window.tourItinerary.splice(index, 1);
            updateItineraryList();
        }

        function updateItineraryList() {
            const itineraryContainer = document.getElementById('itineraryList');
            if (!itineraryContainer) {
                console.warn('itineraryList container not found');
                return;
            }
            itineraryContainer.innerHTML = window.tourItinerary.map((item, index) => `
                <div class="bg-gray-50 p-3 rounded border">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-3">
                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm font-medium">${item.time}</span>
                            <strong>${item.title}</strong>
                        </div>
                        <button type="button" onclick="removeItinerary(${index})" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <p class="text-gray-600 text-sm ml-16">${item.description}</p>
                </div>
            `).join('');
        }

        // Функции управления временем начала тура (быстрое создание)
        function addStartTime() {
            const input = document.getElementById('newStartTime');
            const time = input.value;
            
            if (time && !window.tourStartTimes.includes(time)) {
                window.tourStartTimes.push(time);
                updateStartTimesList();
                input.value = '';
            } else if (window.tourStartTimes.includes(time)) {
                alert('Это время уже добавлено');
            }
        }

        function removeStartTime(index) {
            window.tourStartTimes.splice(index, 1);
            updateStartTimesList();
        }

        function updateStartTimesList() {
            const container = document.getElementById('startTimesList');
            container.innerHTML = window.tourStartTimes.map((time, index) => `
                <div class="flex items-center justify-between bg-gray-50 p-2 rounded">
                    <span>🕐 ${time}</span>
                    <button type="button" onclick="removeStartTime(${index})" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }
        
        // Функции управления временем начала тура (редактирование)
        function addEditStartTime() {
            const input = document.getElementById('editNewStartTime');
            const time = input.value;
            
            if (time && !window.editStartTimes.includes(time)) {
                window.editStartTimes.push(time);
                updateStartTimesList();
                input.value = '';
            } else if (window.editStartTimes.includes(time)) {
                alert('Это время уже добавлено');
            }
        }

        function removeEditStartTime(index) {
            window.editStartTimes.splice(index, 1);
            updateStartTimesList();
        }

        // Функции для работы с языками в форме редактирования
        function addEditLanguageToTour() {
            const select = document.getElementById('eAvailableLanguages');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption && selectedOption.value) {
                const language = selectedOption.value;
                
                // Получаем текущие языки
                const eTourLanguagesField4 = document.getElementById('eTourLanguages');
                let currentLanguages = eTourLanguagesField4.value ? eTourLanguagesField4.value.split(', ') : [];
                
                // Проверяем, не добавлен ли уже
                if (currentLanguages.includes(language)) {
                    alert('Этот язык уже добавлен');
                    return;
                }
                
                // Добавляем новый язык
                currentLanguages.push(language);
                eTourLanguagesField4.value = currentLanguages.join(', ');
                
                // Обновляем отображение
                updateEditSelectedLanguages();
                
                // Сбрасываем выбор
                select.selectedIndex = 0;
            }
        }

        function updateEditSelectedLanguages() {
            const eTourLanguagesField2 = document.getElementById('eTourLanguages');
            const container = document.getElementById('eSelectedLanguages');
            
            if (!container) return;
            
            const languages = eTourLanguagesField2.value ? eTourLanguagesField2.value.split(', ') : [];
            
            if (languages.length === 0 || (languages.length === 1 && languages[0] === '')) {
                container.innerHTML = '<small class="text-gray-500">Выбранные языки появятся здесь</small>';
                return;
            }
            
            container.innerHTML = (Array.isArray(languages) ? languages : []).map((language, index) => `
                <div class="flex items-center justify-between bg-blue-100 text-blue-800 px-2 py-1 rounded mb-1">
                    <span>${language}</span>
                    <button type="button" onclick="removeEditLanguage(${index})" class="text-red-500 hover:text-red-700 ml-2">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeEditLanguage(index) {
            const eTourLanguagesField3 = document.getElementById('eTourLanguages');
            let languages = eTourLanguagesField3.value ? eTourLanguagesField3.value.split(', ') : [];
            languages.splice(index, 1);
            eTourLanguagesField3.value = languages.join(', ');
            updateEditSelectedLanguages();
        }

        // Функции для работы с галереей в форме редактирования
        function addEditGalleryImage() {
            const input = document.getElementById('eNewImageUrl');
            const imageUrl = input.value.trim();
            
            if (imageUrl && !window.tourGalleryImages.includes(imageUrl)) {
                window.tourGalleryImages.push(imageUrl);
                updateGalleryImagesList();
                input.value = '';
            } else if (window.tourGalleryImages.includes(imageUrl)) {
                alert('Это изображение уже добавлено');
            } else {
                alert('Пожалуйста, введите корректный URL изображения');
            }
        }

        function updateEditGalleryImagesList() {
            const container = document.getElementById('eGalleryImagesList');
            if (!container) {
                console.warn('eGalleryImagesList container not found');
                return;
            }
            container.innerHTML = window.tourGalleryImages.map((imageUrl, index) => `
                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded border">
                    <img src="${imageUrl}" alt="Tour image" class="w-16 h-16 object-cover rounded">
                    <div class="flex-1">
                        <p class="text-sm text-gray-700 break-all">${imageUrl}</p>
                    </div>
                    <button type="button" onclick="removeEditGalleryImage(${index})" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('') || '<p class="text-gray-500 text-sm">Нет изображений в галерее</p>';
        }

        function removeEditGalleryImage(index) {
            window.tourGalleryImages.splice(index, 1);
            updateEditGalleryImagesList();
        }

        // Функция для получения отмеченных услуг
        function getSelectedIncludes() {
            const checkboxes = document.querySelectorAll('#includesOptions input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(checkbox => checkbox.value);
        }

        function updateEditStartTimesList() {
            const container = document.getElementById('editStartTimesList');
            if (!container) {
                console.warn('editStartTimesList container not found');
                return;
            }
            container.innerHTML = window.editStartTimes.map((time, index) => `
                <div class="flex items-center justify-between bg-gray-50 p-2 rounded">
                    <span>🕐 ${time}</span>
                    <button type="button" onclick="removeEditStartTime(${index})" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }


        // Add category to tour
        function addCategoryToTour() {
            const select = document.getElementById('availableCategories');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption && selectedOption.value) {
                const categoryValue = selectedOption.value;
                const categoryName = selectedOption.getAttribute('data-name') || selectedOption.text;
                
                // Check if it's a category that needs to be created
                if (categoryValue.startsWith('add_')) {
                    // Create new category first
                    const categoryMap = {
                        'add_day_tours': { ru: 'Однодневные туры', en: 'Day Tours' },
                        'add_multi_day_tours': { ru: 'Многодневные туры', en: 'Multi-day Tours' },
                        'add_excursions': { ru: 'Экскурсии', en: 'Excursions' },
                        'add_city_tours': { ru: 'Городские туры', en: 'City Tours' },
                        'add_nature_eco_tours': { ru: 'Природа/экологические туры', en: 'Nature/Eco Tours' },
                        'add_cultural_tours': { ru: 'Культурно познавательные туры', en: 'Cultural Educational Tours' },
                        'add_historical_tours': { ru: 'Исторические туры', en: 'Historical Tours' },
                        'add_hiking_trekking': { ru: 'Походы/трекинги', en: 'Hiking/Trekking' },
                        'add_mountain_landscapes': { ru: 'Горные ландшафты', en: 'Mountain Landscapes' },
                        'add_lake_landscapes': { ru: 'Озерные ландшафты', en: 'Lake Landscapes' },
                        'add_adventure_tours': { ru: 'Приключенческие туры', en: 'Adventure Tours' },
                        'add_gastronomic_tours': { ru: 'Гастрономические туры', en: 'Gastronomic Tours' },
                        'add_auto_tours': { ru: 'Автотуры/сафари/джип-туры', en: 'Auto Tours/Safari/Jeep Tours' },
                        'add_agro_tours': { ru: 'Агротуры', en: 'Agro Tours' },
                        'add_vip_tours': { ru: 'VIP туры', en: 'VIP Tours' }
                    };
                    
                    const categoryInfo = categoryMap[categoryValue];
                    if (categoryInfo) {
                        const categoryData = {
                            name: {
                                ru: categoryInfo.ru,
                                en: categoryInfo.en,
                                tj: ''
                            }
                        };
                        
                        fetch(`${getApiUrl()}/categories`, {
                            method: 'POST',
                            headers: getAuthHeaders(),
                            body: JSON.stringify(categoryData)
                        })
                            .then(res => res.json())
                            .then(data => {
                                if (data.success && data.data && data.data.id) {
                                    // Category created successfully, add to selected
                                    const categoryId = data.data.id;
                                    
                                    // Check if already added
                                    if (selectedCategories.find(cat => cat.id === categoryId)) {
                                        alert('Эта категория уже добавлена');
                                        return;
                                    }
                                    
                                    selectedCategories.push({id: categoryId, name: categoryName});
                                    updateSelectedCategoriesDisplay();
                                    
                                    // Reload categories to show the new one
                                    loadCategories();
                                } else {
                                    alert('Ошибка при создании категории');
                                }
                            })
                            .catch(err => {
                                console.error('Error creating category:', err);
                                alert('Ошибка при создании категории');
                            });
                    }
                } else {
                    // Existing category, just add it
                    const categoryId = categoryValue;
                    
                    // Check if already added
                    if (selectedCategories.find(cat => cat.id === categoryId)) {
                        alert('Эта категория уже добавлена');
                        return;
                    }
                    
                    selectedCategories.push({id: categoryId, name: categoryName});
                    updateSelectedCategoriesDisplay();
                }
                
                // Reset select
                select.selectedIndex = 0;
            }
        }

        // Remove category from tour
        function removeCategoryFromTour(categoryId) {
            selectedCategories = selectedCategories.filter(cat => cat.id !== categoryId);
            updateSelectedCategoriesDisplay();
        }

        // Update selected categories display
        function updateSelectedCategoriesDisplay() {
            const container = document.getElementById('selectedCategories');
            const categoryHiddenInput = document.getElementById('tourCategory');
            
            if (selectedCategories.length === 0) {
                container.innerHTML = '<small class="text-gray-500">Выбранные категории появятся здесь</small>';
                categoryHiddenInput.value = '';
            } else {
                container.innerHTML = selectedCategories.map(cat => 
                    `<div class="flex justify-between items-center bg-white p-2 rounded border">
                        <span>${cat.name}</span>
                        <button type="button" onclick="removeCategoryFromTour('${cat.id}')" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>`
                ).join('');
                
                // Set first category as primary (for required field)
                categoryHiddenInput.value = selectedCategories[0].id;
            }
        }

        // Add language to tour (main form)
        function addLanguageToTourMain() {
            const select = document.getElementById('availableLanguages');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption && selectedOption.value) {
                const language = selectedOption.value;
                
                // Check if already added
                if (selectedLanguages.includes(language)) {
                    alert('Этот язык уже добавлен');
                    return;
                }
                
                // Add to selected languages
                selectedLanguages.push(language);
                
                // Update display
                updateSelectedLanguagesDisplay();
                
                // Reset select
                select.selectedIndex = 0;
            }
        }

        // Remove language from tour
        function removeLanguageFromTour(language) {
            selectedLanguages = selectedLanguages.filter(lang => lang !== language);
            updateSelectedLanguagesDisplay();
        }

        // Update selected languages display
        function updateSelectedLanguagesDisplay() {
            const container = document.getElementById('selectedLanguages');
            const languagesHiddenInput = document.getElementById('tourLanguages');
            
            if (selectedLanguages.length === 0) {
                container.innerHTML = '<small class="text-gray-500">Выбранные языки появятся здесь</small>';
                languagesHiddenInput.value = '';
            } else {
                container.innerHTML = selectedLanguages.map(lang => 
                    `<div class="flex justify-between items-center bg-white p-2 rounded border">
                        <span>${lang}</span>
                        <button type="button" onclick="removeLanguageFromTour('${lang}')" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>`
                ).join('');
                
                hiddenInput.value = JSON.stringify(selectedLanguages);
            }
        }
        

        // Tours functions
        function loadTours() {
            fetch(`${getApiUrl()}/tours`, {
                headers: getAuthHeaders()
            })
                .then(res => res.json())
                .then(data => {
                    const tbody = document.getElementById('toursTable');
                    const tours = data.data || data.tours || [];
                    if (tours.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-gray-500">Нет туров</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = tours.map(tour => {
                        const title = typeof tour.title === 'string' ? JSON.parse(tour.title || '{}') : tour.title || {};
                        const categoryName = tour.category ? 
                            (typeof tour.category.name === 'string' ? JSON.parse(tour.category.name || '{}') : tour.category.name || {}) :
                            {};
                        return `
                            <tr>
                                <td>${tour.id}</td>
                                <td class="font-medium">${title.ru || title.en || 'Без названия'}</td>
                                <td>${categoryName.ru || categoryName.en || 'Без категории'}</td>
                                <td>${tour.country || '-'}</td>
                                <td>${tour.city || '-'}</td>
                                <td>${tour.duration || tour.durationDays || '-'} дней</td>
                                <td class="font-semibold">$${tour.price}</td>
                                <td>${tour.isActive ? 
                                    '<span class="badge badge-success">Активен</span>' : 
                                    '<span class="badge badge-danger">Неактивен</span>'}</td>
                                <td>
                                    <button onclick="editTour(${tour.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="Редактировать тур">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="copyReviewLink(${tour.id})" class="text-green-600 hover:text-green-800 mr-2" title="Скопировать ссылку для отзывов">
                                        <i class="fas fa-link"></i>
                                    </button>
                                    <button onclick="deleteTour(${tour.id})" class="text-red-600 hover:text-red-800" title="Удалить тур">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                })
                .catch(err => {
                    console.error('Error loading tours:', err);
                    document.getElementById('toursTable').innerHTML = 
                        '<tr><td colspan="9" class="text-center text-red-500">Ошибка загрузки данных</td></tr>';
                });
        }
        
        function openTourModal(tourId = null) {
            console.log('🔵 Opening tour modal with tourId:', tourId);
            currentTourId = tourId;
            console.log('🔵 Set currentTourId to:', currentTourId);
            window.currentTourId = tourId; // Также устанавливаем глобально
            window.tourImageURLs = [];
            
            // ИСПРАВЛЕНО: Очищаем выбранные категории при открытии модального окна
            selectedCategories = [];
            updateSelectedCategoriesDisplay();
            
            document.getElementById('tourModal').classList.add('active');
            
            // Initialize the uploader
            setTimeout(() => {
                initializeTourUploader();
                initializeTourEditUploader();
            }, 100);
            
            // Load hotels and guides for checkboxes
            loadHotelsForCheckboxes();
            loadGuidesForCheckboxes();
            
            // Load categories for tour form
            loadCategories();
            
            if (tourId) {
                // Заполняем скрытое поле ID тура
                document.getElementById('tour-id').value = tourId;
                
                // Load tour data for editing
                fetch(`${getApiUrl()}/tours/${tourId}`, {
                    headers: getAuthHeaders()
                })
                    .then(res => {
                        console.log('API response status:', res.status);
                        if (!res.ok) {
                            throw new Error(`HTTP error! status: ${res.status}`);
                        }
                        return res.json();
                    })
                    .then(data => {
                        console.log('API response data:', data);
                        const tour = data.data || data.tour || data;
                        if (!tour) {
                            throw new Error('Tour data not found in response');
                        }
                        console.log('Tour object:', tour);
                        
                        // Safely parse title and description (handle both string and object formats)
                        let title, description;
                        try {
                            title = typeof tour.title === 'string' ? JSON.parse(tour.title || '{}') : (tour.title || {});
                        } catch (e) {
                            console.warn('Failed to parse title:', e);
                            title = { ru: tour.title || '', en: '' };
                        }
                        
                        try {
                            description = typeof tour.description === 'string' ? JSON.parse(tour.description || '{}') : (tour.description || {});
                        } catch (e) {
                            console.warn('Failed to parse description:', e);
                            description = { ru: tour.description || '', en: '' };
                        }
                        
                        // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Заполняем ОБЕ формы одновременно!
                        
                        // Заполняем поля ОСНОВНОЙ формы tourForm
                        const tourTitleRu = document.getElementById('tourTitleRu');
                        if (tourTitleRu) {
                            tourTitleRu.value = title.ru || '';
                            console.log('✅ Loaded title RU (main form):', title.ru);
                        }
                        
                        const tourTitleEn = document.getElementById('tourTitleEn');
                        if (tourTitleEn) {
                            tourTitleEn.value = title.en || '';
                            console.log('✅ Loaded title EN (main form):', title.en);
                        }
                        
                        const tourDescRu = document.getElementById('tourDescRu');
                        if (tourDescRu) {
                            tourDescRu.value = description.ru || '';
                            console.log('✅ Loaded description RU (main form)');
                        }
                        
                        const tourDescEn = document.getElementById('tourDescEn');
                        if (tourDescEn) {
                            tourDescEn.value = description.en || '';
                            console.log('✅ Loaded description EN (main form)');
                        }
                        
                        // УДАЛЕНО: Заполнение полей Enhanced формы (форма удалена)
                        
                        const tourType = document.getElementById('tourType');
                        if (tourType) {
                            // ИСПРАВЛЕНО: Улучшенная загрузка типа тура из разных полей
                            const typeValue = tour.tourType || tour.format || '';
                            tourType.value = typeValue;
                            console.log('✅ Loaded tour type (main form):', typeValue, 'from tour.tourType:', tour.tourType, 'tour.format:', tour.format);
                        }
                        
                        // УДАЛЕНО: Заполнение eTourType (поле удалено)
                        
                        const tourCategory = document.getElementById('tourCategory');
                        if (tourCategory) {
                            tourCategory.value = tour.categoryId || '';
                            console.log('✅ Loaded category (main form):', tour.categoryId);
                        }
                        
                        // ИСПРАВЛЕНО: Загрузка категории в систему выбора с правильным форматом
                        if (tour.categoryId) {
                            // Нужно найти название категории по ID
                            fetch(`${getApiUrl()}/categories`)
                                .then(res => res.json())
                                .then(data => {
                                    const categories = data.data || data.categories || [];
                                    const category = categories.find(cat => cat.id === tour.categoryId);
                                    if (category) {
                                        const categoryName = typeof category.name === 'string' ? 
                                            JSON.parse(category.name) : category.name;
                                        selectedCategories = [{
                                            id: tour.categoryId, 
                                            name: categoryName.ru || categoryName.en || 'Категория'
                                        }];
                                        updateSelectedCategoriesDisplay();
                                        console.log('✅ Loaded category into selection system:', tour.categoryId, categoryName);
                                    }
                                })
                                .catch(e => console.warn('Failed to load category for editing:', e));
                        }
                        
                        // УДАЛЕНО: Заполнение eTourCategoryId (поле удалено)
                        
                        const tourBlockIdElement = document.getElementById('tourBlockId');
                        if (tourBlockIdElement) {
                            tourBlockIdElement.value = tour.tourBlockId || '';
                            console.log('✅ Loaded tour block:', tour.tourBlockId);
                        }
                        
                        const tourCountry = document.getElementById('tourCountry');
                        if (tourCountry) {
                            tourCountry.value = tour.country || '';
                            console.log('✅ Loaded country:', tour.country);
                        }
                        
                        const tourCity = document.getElementById('tourCity');
                        if (tourCity) {
                            tourCity.value = tour.city || '';
                            console.log('✅ Loaded city:', tour.city);
                        }
                        
                        const tourDurationDays = document.getElementById('tourDurationDays');
                        if (tourDurationDays) {
                            tourDurationDays.value = tour.durationDays || '';
                            console.log('✅ Loaded duration days (main form):', tour.durationDays);
                        }
                        
                        // УДАЛЕНО: Заполнение eTourDurationDays (поле удалено)
                        
                        const tourPrice = document.getElementById('tourPrice');
                        if (tourPrice) {
                            tourPrice.value = tour.price || '';
                            console.log('✅ Loaded price (main form):', tour.price);
                        }
                        
                        // Load pricing components for editing
                        if (tour.pricingData) {
                            try {
                                const components = typeof tour.pricingData === 'string' 
                                    ? JSON.parse(tour.pricingData) 
                                    : tour.pricingData;
                                
                                // Wait for components to be loaded, then populate selections
                                setTimeout(() => {
                                    loadTourPricingComponentsForEdit(components);
                                }, 500);
                                
                                console.log('✅ Will load pricing components for editing:', components);
                            } catch (e) {
                                console.warn('Failed to parse pricing components:', e);
                            }
                        }
                        
                        const tourPriceTypeElement = document.getElementById('tourPriceType');
                        if (tourPriceTypeElement) {
                            tourPriceTypeElement.value = tour.priceType || 'за человека';
                            console.log('✅ Loaded price type:', tour.priceType);
                        }
                        
                        const tourPickupInfoElement = document.getElementById('tourPickupInfo');
                        if (tourPickupInfoElement) {
                            tourPickupInfoElement.value = tour.pickupInfo || '';
                            console.log('✅ Loaded pickup info:', tour.pickupInfo);
                        }
                        
                        
                        const tourMinPeopleElement = document.getElementById('tourMinPeople');
                        if (tourMinPeopleElement) {
                            tourMinPeopleElement.value = tour.minPeople || '';
                            console.log('✅ Loaded min people:', tour.minPeople);
                        }
                        
                        const tourMaxPeopleElement = document.getElementById('tourMaxPeople');
                        if (tourMaxPeopleElement) {
                            tourMaxPeopleElement.value = tour.maxPeople || '';
                            console.log('✅ Loaded max people:', tour.maxPeople);
                        }
                        
                        // Заполняем сложные поля (массивы)
                        if (tour.highlights) {
                            try {
                                const highlights = typeof tour.highlights === 'string' ? JSON.parse(tour.highlights) : tour.highlights;
                                window.tourHighlights = highlights || [];
                                updateHighlightsList();
                            } catch (e) {
                                console.warn('Failed to parse highlights:', e);
                            }
                        }
                        
                        if (tour.itinerary) {
                            try {
                                const itinerary = typeof tour.itinerary === 'string' ? JSON.parse(tour.itinerary) : tour.itinerary;
                                window.tourItinerary = itinerary || [];
                                updateItineraryList();
                            } catch (e) {
                                console.warn('Failed to parse itinerary:', e);
                            }
                        }
                        
                        if (tour.startTimeOptions) {
                            try {
                                const startTimes = typeof tour.startTimeOptions === 'string' ? JSON.parse(tour.startTimeOptions) : tour.startTimeOptions;
                                window.tourStartTimes = startTimes || [];
                                updateStartTimesList();
                            } catch (e) {
                                console.warn('Failed to parse start times:', e);
                            }
                        }
                        
                        if (tour.languages) {
                            try {
                                const languages = typeof tour.languages === 'string' ? JSON.parse(tour.languages) : tour.languages;
                                window.tourLanguages = languages || [];
                                updateSelectedLanguages();
                            } catch (e) {
                                console.warn('Failed to parse languages:', e);
                            }
                        }
                        
                        // Обновляем месяцы и дни доступности
                        if (tour.availableMonths) {
                            try {
                                const months = typeof tour.availableMonths === 'string' ? JSON.parse(tour.availableMonths) : tour.availableMonths;
                                months.forEach(month => {
                                    const checkbox = document.getElementById(`month-${month}`);
                                    if (checkbox) checkbox.checked = true;
                                });
                            } catch (e) {
                                console.warn('Failed to parse available months:', e);
                            }
                        }
                        
                        if (tour.availableDays) {
                            try {
                                const days = typeof tour.availableDays === 'string' ? JSON.parse(tour.availableDays) : tour.availableDays;
                                days.forEach(day => {
                                    const checkbox = document.getElementById(`day-${day}`);
                                    if (checkbox) checkbox.checked = true;
                                });
                            } catch (e) {
                                console.warn('Failed to parse available days:', e);
                            }
                        }
                        // УДАЛЕНО: Заполнение eTourPriceType (поле удалено)
                        // УДАЛЕНО: Заполнение eTourPickupInfo (поле удалено)
                        
                        // УДАЛЕНО: Заполнение eTourFullDesc (поле удалено)
                        
                        // Обработка языков
                        let languages = '';
                        if (tour.languages) {
                            try {
                                const langArray = JSON.parse(tour.languages);
                                languages = langArray.join(', ');
                            } catch (e) {
                                languages = tour.languages;
                            }
                        }
                        // ИСПРАВЛЕНО: Обработка языков для основной формы
                        const tourLanguagesField = document.getElementById('tourLanguages');
                        if (tourLanguagesField) {
                            tourLanguagesField.value = languages;
                            console.log('✅ Set tourLanguages field:', languages);
                        }
                        
                        // ИСПРАВЛЕНО: Обработка времен начала тура для основной формы
                        // Проверяем наличие времен начала тура
                        if (tour.startTimeOptions) {
                            try {
                                const startTimes = typeof tour.startTimeOptions === 'string' ? JSON.parse(tour.startTimeOptions) : tour.startTimeOptions;
                                window.tourStartTimes = startTimes || [];
                                updateStartTimesList(); // Обновляем список в основной форме
                                console.log('✅ Loaded start times:', window.tourStartTimes);
                            } catch (e) {
                                console.warn('Failed to parse start times:', e);
                                window.tourStartTimes = [];
                            }
                        }
                        
                        // ИСПРАВЛЕНО: Заполнение недостающих полей основной формы
                        
                        // Заполнение minPeople и maxPeople в основной форме
                        const tourMinPeopleField = document.getElementById('tourMinPeople');
                        if (tourMinPeopleField && tour.minPeople) {
                            tourMinPeopleField.value = tour.minPeople.toString();
                            console.log('✅ Loaded tourMinPeople:', tour.minPeople);
                        }
                        
                        const tourMaxPeopleField = document.getElementById('tourMaxPeople');
                        if (tourMaxPeopleField && tour.maxPeople) {
                            tourMaxPeopleField.value = tour.maxPeople.toString();
                            console.log('✅ Loaded tourMaxPeople:', tour.maxPeople);
                        }
                        
                        // Заполнение tourBlockId в основной форме
                        const tourBlockIdField = document.getElementById('tourBlockId');
                        if (tourBlockIdField && tour.tourBlockId) {
                            tourBlockIdField.value = tour.tourBlockId.toString();
                            console.log('✅ Loaded tourBlockId:', tour.tourBlockId);
                        }
                        
                        // Заполнение pickupInfo в основной форме
                        const tourPickupInfoField = document.getElementById('tourPickupInfo');
                        if (tourPickupInfoField && tour.pickupInfo) {
                            tourPickupInfoField.value = tour.pickupInfo;
                            console.log('✅ Loaded tourPickupInfo:', tour.pickupInfo);
                        }
                        
                        // Загрузка основных моментов (highlights)
                        window.tourHighlights = [];
                        if (tour.highlights) {
                            try {
                                window.tourHighlights = typeof tour.highlights === 'string' ? JSON.parse(tour.highlights) : tour.highlights;
                            } catch (e) {
                                console.warn('Failed to parse highlights:', e);
                                window.tourHighlights = [];
                            }
                        }
                        try {
                            updateHighlightsList();
                            console.log('✅ Updated highlights list');
                        } catch (e) {
                            console.error('❌ Failed to update highlights list:', e);
                        }
                        
                        // Загрузка маршрута (itinerary)
                        window.tourItinerary = [];
                        if (tour.itinerary) {
                            try {
                                window.tourItinerary = typeof tour.itinerary === 'string' ? JSON.parse(tour.itinerary) : tour.itinerary;
                                console.log('✅ Loaded itinerary:', window.tourItinerary);
                            } catch (e) {
                                console.warn('Failed to parse itinerary:', e);
                                window.tourItinerary = [];
                            }
                        }
                        try {
                            updateItineraryList();
                            console.log('✅ Updated itinerary list');
                        } catch (e) {
                            console.error('❌ Failed to update itinerary list:', e);
                        }
                        
                        // Загрузка доступности по месяцам
                        if (tour.availableMonths) {
                            try {
                                const availableMonths = typeof tour.availableMonths === 'string' ? JSON.parse(tour.availableMonths) : tour.availableMonths;
                                console.log('✅ Loading available months:', availableMonths);
                                // Снимаем выделение со всех месяцев
                                for (let i = 1; i <= 12; i++) {
                                    const checkbox = document.getElementById(`month-${i}`);
                                    if (checkbox) checkbox.checked = false;
                                }
                                // Выделяем нужные месяцы
                                availableMonths.forEach(month => {
                                    const checkbox = document.getElementById(`month-${month}`);
                                    if (checkbox) {
                                        checkbox.checked = true;
                                        console.log('✅ Checked month:', month);
                                    }
                                });
                            } catch (e) {
                                console.warn('Failed to parse availableMonths:', e);
                            }
                        }
                        
                        // Загрузка доступности по дням месяца
                        if (tour.availableDays) {
                            try {
                                const availableDays = typeof tour.availableDays === 'string' ? JSON.parse(tour.availableDays) : tour.availableDays;
                                console.log('✅ Loading available days:', availableDays);
                                // Снимаем выделение со всех дней месяца
                                for (let i = 1; i <= 31; i++) {
                                    const checkbox = document.getElementById(`day-${i}`);
                                    if (checkbox) checkbox.checked = false;
                                }
                                // Выделяем нужные дни месяца
                                availableDays.forEach(day => {
                                    const checkbox = document.getElementById(`day-${day}`);
                                    if (checkbox) {
                                        checkbox.checked = true;
                                        console.log('✅ Checked day:', day);
                                    }
                                });
                            } catch (e) {
                                console.warn('Failed to parse availableDays:', e);
                            }
                        }
                        
                        // УДАЛЕНО: дублирующая загрузка турблока (уже обработано выше)
                        
                        // Загрузка главного изображения
                        const tourMainImageField = document.getElementById('tourMainImage');
                        if (tourMainImageField && tour.mainImage) {
                            tourMainImageField.value = tour.mainImage;
                            console.log('✅ Loaded main image:', tour.mainImage);
                        }
                        
                        // Загрузка галереи изображений
                        window.tourGalleryImages = [];
                        if (tour.images) {
                            try {
                                window.tourGalleryImages = typeof tour.images === 'string' ? JSON.parse(tour.images) : tour.images;
                                console.log('✅ Loaded gallery images:', window.tourGalleryImages);
                            } catch (e) {
                                console.warn('Failed to parse gallery images:', e);
                                window.tourGalleryImages = [];
                            }
                        }
                        try {
                            updateGalleryImagesList();
                            console.log('✅ Updated gallery images list with images:', window.tourGalleryImages);
                            
                            // ИСПРАВЛЕНО: Используем правильный контейнер галереи
                            const galleryContainer = document.getElementById('galleryImagesList');
                            if (galleryContainer) {
                                if (window.tourGalleryImages && window.tourGalleryImages.length > 0) {
                                    console.log('✅ Gallery container has', window.tourGalleryImages.length, 'images');
                                } else {
                                    console.log('✅ Gallery container is empty (no images to show)');
                                }
                            } else {
                                console.error('❌ Element galleryImagesList container not found');
                            }
                        } catch (e) {
                            console.error('❌ Failed to update gallery images list:', e);
                        }
                        
                        // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Загрузка выбранных отелей и гидов
                        // Загрузка выбранных отелей
                        if (tour.tourHotels && Array.isArray(tour.tourHotels)) {
                            console.log('✅ Loading selected hotels:', tour.tourHotels.map(th => th.hotelId));
                            tour.tourHotels.forEach(tourHotel => {
                                const hotelId = tourHotel.hotelId;
                                const checkbox = document.querySelector(`input[name="selectedHotels"][value="${hotelId}"]`);
                                if (checkbox) {
                                    checkbox.checked = true;
                                    console.log('✅ Checked hotel:', hotelId);
                                } else {
                                    console.warn('❌ Hotel checkbox not found for:', hotelId);
                                }
                            });
                        } else {
                            console.log('❌ No tourHotels found or not array:', tour.tourHotels);
                        }
                        
                        // Загрузка выбранных гидов
                        if (tour.tourGuides && Array.isArray(tour.tourGuides)) {
                            console.log('✅ Loading selected guides:', tour.tourGuides.map(tg => tg.guideId));
                            tour.tourGuides.forEach(tourGuide => {
                                const guideId = tourGuide.guideId;
                                const checkbox = document.querySelector(`input[name="selectedGuides"][value="${guideId}"]`);
                                if (checkbox) {
                                    checkbox.checked = true;
                                    console.log('✅ Checked guide:', guideId);
                                } else {
                                    console.warn('❌ Guide checkbox not found for:', guideId);
                                }
                            });
                        } else {
                            console.log('❌ No tourGuides found or not array:', tour.tourGuides);
                        }
                        
                        console.log('✅ Tour data loaded successfully for editing:', tour.id);
                        console.log('🔍 Final currentTourId check:', currentTourId, 'window.currentTourId:', window.currentTourId);
                        
                    })
                    .catch(err => {
                        console.error('❌ Error loading tour data:', err);
                        console.error('❌ Error stack:', err.stack);
                        console.error('❌ Error message:', err.message);
                        alert('Ошибка загрузки данных тура: ' + err.message);
                    });
            }
        }
        
        // Новая функция сохранения для основной формы tourForm
        function saveTourForm() {
            // Получаем ID тура из скрытого поля
            const tourId = document.getElementById('tour-id').value;
            const isEditing = tourId && tourId.trim() !== '';
            
            console.log('💾 Saving tour:', { tourId, isEditing });
            
            // Валидация обязательных полей
            const titleRuValue = document.getElementById('tourTitleRu').value;
            const titleEnValue = document.getElementById('tourTitleEn').value;
            
            const categoryValue = document.getElementById('tourCategory').value;
            const priceValue = document.getElementById('tourPrice').value;
            const durationDaysValue = document.getElementById('tourDurationDays').value;
            
            if (!titleRuValue || titleRuValue.trim() === '') {
                alert('Пожалуйста, введите название тура на русском языке');
                return;
            }
            
            if (!categoryValue || categoryValue === '') {
                alert('Пожалуйста, выберите категорию тура');
                return;
            }
            
            if (!priceValue || isNaN(parseFloat(priceValue))) {
                alert('Пожалуйста, введите корректную цену тура');
                return;
            }
            
            if (!durationDaysValue || isNaN(parseInt(durationDaysValue))) {
                alert('Пожалуйста, введите длительность тура в днях');
                return;
            }
            
            // Собираем выбранные отели
            const selectedHotels = [];
            document.querySelectorAll('input[name="selectedHotels"]:checked').forEach(checkbox => {
                selectedHotels.push(parseInt(checkbox.value));
            });
            
            // Собираем выбранных гидов
            const selectedGuides = [];
            document.querySelectorAll('input[name="selectedGuides"]:checked').forEach(checkbox => {
                selectedGuides.push(parseInt(checkbox.value));
            });
            
            console.log('🏨 Selected hotels:', selectedHotels);
            console.log('👨‍🏫 Selected guides:', selectedGuides);
            
            // Формируем данные для отправки
            const formData = {
                title: JSON.stringify({
                    ru: titleRuValue,
                    en: titleEnValue || titleRuValue
                }),
                description: JSON.stringify({
                    ru: document.getElementById('tourDescRu').value || '',
                    en: document.getElementById('tourDescEn').value || ''
                }),
                price: parseFloat(priceValue),
                priceType: document.getElementById('tourPriceType').value || 'за человека',
                categoryId: categoryValue ? parseInt(categoryValue) : null,
                tourBlockId: document.getElementById('tourBlockId').value ? parseInt(document.getElementById('tourBlockId').value) : null,
                country: document.getElementById('tourCountry').value || '',
                city: document.getElementById('tourCity').value || '',
                durationDays: parseInt(durationDaysValue),
                duration: durationDaysValue.toString(),
                format: document.getElementById('tourType').value || '',
                tourType: document.getElementById('tourType').value || '',
                pickupInfo: document.getElementById('tourPickupInfo').value || '',
                minPeople: document.getElementById('tourMinPeople').value ? parseInt(document.getElementById('tourMinPeople').value) : null,
                maxPeople: document.getElementById('tourMaxPeople').value ? parseInt(document.getElementById('tourMaxPeople').value) : null,
                highlights: JSON.stringify(window.tourHighlights || []),
                itinerary: JSON.stringify(window.tourItinerary || []),
                startTimeOptions: JSON.stringify(window.tourStartTimes || []),
                languages: JSON.stringify(window.tourLanguages || ['Русский']),
                availableMonths: JSON.stringify(getSelectedCheckboxValues('month-')),
                availableDays: JSON.stringify(getSelectedCheckboxValues('day-')),
                mainImage: document.getElementById('tourMainImage')?.value || '',
                images: JSON.stringify(window.tourGalleryImages || []),
                hotelIds: selectedHotels,
                guideIds: selectedGuides,
                isActive: true,
                isFeatured: false
            };
            
            console.log('📝 Form data:', formData);
            
            // Определяем URL и метод
            const url = isEditing ? `${getApiUrl()}/tours/${tourId}` : `${getApiUrl()}/tours`;
            const method = isEditing ? 'PUT' : 'POST';
            
            console.log('🚀 Request:', { url, method, isEditing });
            
            // Отправляем данные
            fetch(url, {
                method: method,
                headers: getAuthHeaders(),
                body: JSON.stringify(formData)
            })
            .then(res => {
                console.log('🌐 HTTP Response status:', res.status, 'OK:', res.ok);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                console.log('📬 Server response:', data);
                console.log('🔍 Success check:', 'data.success =', data.success, 'Type:', typeof data.success);
                
                if (data.success === true) {
                    console.log('✅ Success path triggered');
                    const message = isEditing ? '✅ Тур успешно обновлён!' : '✅ Тур успешно создан!';
                    alert(message);
                    
                    // Закрываем модальное окно и обновляем список
                    closeTourModal();
                    loadTours();
                } else {
                    console.log('❌ Error path triggered - data.success:', data.success);
                    const action = isEditing ? 'обновлении' : 'создании';
                    alert(`❌ Ошибка при ${action} тура: ` + (data.message || 'Неизвестная ошибка'));
                }
            })
            .catch(err => {
                console.error('❌ Error saving tour:', err);
                console.error('❌ Error details:', err.message, err.stack);
                alert('❌ Ошибка соединения с сервером: ' + err.message);
            });
        }
        
        function closeTourModal() {
            document.getElementById('tourModal').classList.remove('active');
            document.getElementById('tourForm').reset();
            
            // Clear the uploader
            if (tourUploader) {
                tourUploader.clear('tour-uploader-container');
            }
            // ИСПРАВЛЕНО: Используем правильный uploader
            
            // Очищаем скрытое поле ID и переменные
            document.getElementById('tour-id').value = '';
            currentTourId = null;
            window.currentTourId = null;
            
            // Очищаем все дополнительные данные
            window.tourHighlights = [];
            window.tourItinerary = [];
            window.tourGalleryImages = [];
            window.editStartTimes = [];
            window.tourStartTimes = [];
            window.tourLanguages = window.tourLanguages || [];
            window.tourImageURLs = [];
            
            // Обновляем списки
            updateHighlightsList();
            updateItineraryList();
            updateGalleryImagesList();
            updateEditStartTimesList();
            updateStartTimesList();
            updateSelectedLanguages();
            
            // Очищаем чекбоксы доступности
            for (let i = 1; i <= 12; i++) {
                const checkbox = document.getElementById(`month-${i}`);
                if (checkbox) checkbox.checked = false;
            }
            for (let i = 0; i <= 6; i++) {
                const checkbox = document.getElementById(`day-${i}`);
                if (checkbox) checkbox.checked = false;
            }
            
            console.log('🔒 Modal closed and form reset');
        }
        
        // Вспомогательные функции для работы с чекбоксами и списками
        function getSelectedCheckboxValues(prefix) {
            const checkboxes = document.querySelectorAll(`input[id^="${prefix}"]:checked`);
            return Array.from(checkboxes).map(cb => cb.id.replace(prefix, ''));
        }
        
        function updateHighlightsList() {
            const container = document.getElementById('highlightsList');
            if (!container) return;
            
            const highlights = window.tourHighlights || [];
            container.innerHTML = highlights.map((highlight, index) => `
                <div class="flex items-center justify-between bg-gray-50 p-3 rounded">
                    <span>${highlight}</span>
                    <button type="button" onclick="removeHighlight(${index})" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }
        
        function updateItineraryList() {
            const container = document.getElementById('itineraryList');
            if (!container) return;
            
            const itinerary = window.tourItinerary || [];
            container.innerHTML = itinerary.map((item, index) => `
                <div class="bg-gray-50 p-3 rounded">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-medium">${item.time} - ${item.title}</span>
                        <button type="button" onclick="removeItinerary(${index})" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <p class="text-sm text-gray-600">${item.description}</p>
                </div>
            `).join('');
        }
        
        function updateStartTimesList() {
            const container = document.getElementById('startTimesList');
            if (!container) return;
            
            const startTimes = window.tourStartTimes || [];
            container.innerHTML = startTimes.map((time, index) => `
                <div class="flex items-center justify-between bg-gray-50 p-2 rounded">
                    <span>${time}</span>
                    <button type="button" onclick="removeStartTime(${index})" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }
        
        function updateSelectedLanguages() {
            const container = document.getElementById('selectedLanguages');
            if (!container) return;
            
            const languages = window.tourLanguages || [];
            if (languages.length === 0) {
                container.innerHTML = '<small class="text-gray-500">Выбранные языки появятся здесь</small>';
                return;
            }
            
            container.innerHTML = (Array.isArray(languages) ? languages : []).map((language, index) => `
                <div class="flex items-center justify-between bg-gray-50 p-2 rounded">
                    <span>${language}</span>
                    <button type="button" onclick="removeLanguage(${index})" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }
        
        // Функции для работы с динамическими списками
        function addHighlight() {
            const highlightInput = document.getElementById('newHighlight');
            const value = highlightInput.value.trim();
            if (value) {
                window.tourHighlights = window.tourHighlights || [];
                window.tourHighlights.push(value);
                highlightInput.value = '';
                updateHighlightsList();
            }
        }
        
        function removeHighlight(index) {
            window.tourHighlights.splice(index, 1);
            updateHighlightsList();
        }
        
        function addItinerary2() {
            const time = document.getElementById('newItineraryTime').value;
            const itineraryTitle2 = document.getElementById('newItineraryTitle').value.trim();
            const description = document.getElementById('newItineraryDesc').value.trim();
            
            if (time && itineraryTitle2) {
                window.tourItinerary = window.tourItinerary || [];
                window.tourItinerary.push({ time, title: itineraryTitle2, description });
                
                // Очищаем поля
                document.getElementById('newItineraryTime').value = '';
                document.getElementById('newItineraryTitle').value = '';
                document.getElementById('newItineraryDesc').value = '';
                
                updateItineraryList();
            }
        }
        
        function removeItinerary(index) {
            window.tourItinerary.splice(index, 1);
            updateItineraryList();
        }
        
        function addStartTime() {
            const startTimeInput = document.getElementById('newStartTime');
            const value = startTimeInput.value;
            if (value) {
                window.tourStartTimes = window.tourStartTimes || [];
                window.tourStartTimes.push(value);
                startTimeInput.value = '';
                updateStartTimesList();
            }
        }
        
        function removeStartTime(index) {
            window.tourStartTimes.splice(index, 1);
            updateStartTimesList();
        }
        
        function addLanguageToTour() {
            const select = document.getElementById('availableLanguages');
            const language = select.value;
            if (language) {
                // Убеждаемся что это массив
                if (!Array.isArray(window.tourLanguages)) {
                    window.tourLanguages = [];
                }
                if (!window.tourLanguages.includes(language)) {
                    window.tourLanguages.push(language);
                    updateSelectedLanguages();
                }
                select.value = '';
            }
        }
        
        function removeLanguage(index) {
            window.tourLanguages.splice(index, 1);
            updateSelectedLanguages();
        }
        
        function loadHotelsForCheckboxes() {
            fetch(`${getApiUrl()}/hotels`, {
                headers: getAuthHeaders()
            })
                .then(res => res.json())
                .then(data => {
                    const container = document.getElementById('hotelCheckboxes');
                    const hotels = data.data || data.hotels || [];
                    container.innerHTML = hotels.map(hotel => {
                        let name;
                    try {
                        name = typeof hotel.name === 'string' ? JSON.parse(hotel.name) : (hotel.name || {});
                    } catch (e) {
                        console.warn('Failed to parse hotel name in checkboxes:', hotel.name);
                        name = hotel.name || {};
                    }
                        return `
                            <label class="checkbox-item">
                                <input type="checkbox" name="selectedHotels" value="${hotel.id}"> ${name.ru || name.en || 'Отель'}
                            </label>
                        `;
                    }).join('');
                });
        }
        
        function loadGuidesForCheckboxes() {
            fetch(`${getApiUrl()}/guides`, {
                headers: getAuthHeaders()
            })
                .then(res => res.json())
                .then(data => {
                    const container = document.getElementById('guideCheckboxes');
                    const guides = data.data || data.guides || [];
                    container.innerHTML = guides.map(guide => {
                        let name;
                        try {
                            name = typeof guide.name === 'string' ? JSON.parse(guide.name) : (guide.name || {});
                        } catch (e) {
                            console.warn('Failed to parse guide name in checkboxes:', guide.name);
                            name = guide.name || {};
                        }
                        return `
                            <label class="checkbox-item">
                                <input type="checkbox" name="selectedGuides" value="${guide.id}"> ${name.ru || name.en || 'Гид'}
                            </label>
                        `;
                    }).join('');
                });
        }
        
        // Hotels functions
        // Удалено: currentHotelId - используем hotel-id
        
        function loadHotels() {
            console.log('Loading hotels...');
            const apiUrl = getApiUrl();
            fetch(`${apiUrl}/hotels`)
                .then(res => {
                    console.log('Hotels response:', res.status);
                    return res.json();
                })
                .then(data => {
                    console.log('Hotels data:', data);
                    const container = document.getElementById('hotelsList');
                    if (!data.success || !data.data || data.data.length === 0) {
                        container.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500">Нет отелей</div>';
                        return;
                    }
                    
                    container.innerHTML = data.data.map(hotel => createHotelCard(hotel)).join('');
                })
                .catch(err => {
                    console.error('Error loading hotels:', err);
                    document.getElementById('hotelsList').innerHTML = 
                        '<div class="col-span-full text-center py-12 text-red-500">Ошибка загрузки данных: ' + err.message + '</div>';
                });
        }
        
        function createHotelCard(hotel) {
            // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Безопасный парсинг JSON
            let name, description, amenities, images;
            
            try {
                name = typeof hotel.name === 'string' ? JSON.parse(hotel.name) : (hotel.name || {});
            } catch (e) {
                console.warn('Failed to parse hotel name in card:', hotel.name);
                name = hotel.name || {};
            }
            
            try {
                description = typeof hotel.description === 'string' ? JSON.parse(hotel.description) : (hotel.description || {});
            } catch (e) {
                console.warn('Failed to parse hotel description in card:', hotel.description);
                description = hotel.description || {};
            }
            
            try {
                amenities = typeof hotel.amenities === 'string' ? JSON.parse(hotel.amenities) : (hotel.amenities || []);
                if (!Array.isArray(amenities)) amenities = [];
            } catch (e) {
                console.warn('Failed to parse hotel amenities in card:', hotel.amenities);
                amenities = [];
            }
            
            try {
                images = typeof hotel.images === 'string' ? JSON.parse(hotel.images) : (hotel.images || []);
                if (!Array.isArray(images)) images = [];
            } catch (e) {
                console.warn('Failed to parse hotel images in card:', hotel.images);
                images = [];
            }
            
            return `
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="relative">
                        ${images.length > 0 ? `
                            <img src="${images[0]}" alt="${name.ru || name.en || 'Hotel'}" class="w-full h-48 object-cover">
                            ${images.length > 1 ? `
                                <div class="absolute top-2 right-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded text-sm">
                                    +${images.length - 1} фото
                                </div>
                            ` : ''}
                        ` : `
                            <div class="w-full h-48 bg-gray-200 flex items-center justify-center">
                                <i class="fas fa-hotel text-gray-400 text-3xl"></i>
                            </div>
                        `}
                        <div class="absolute top-2 left-2">
                            ${hotel.isActive ? 
                                '<span class="badge badge-success">Активен</span>' : 
                                '<span class="badge badge-danger">Неактивен</span>'}
                        </div>
                    </div>
                    
                    <div class="p-4">
                        <h3 class="font-semibold text-lg mb-2">${name.ru || name.en || 'Отель'}</h3>
                        
                        <div class="flex items-center mb-3">
                            <i class="fas fa-map-marker-alt text-gray-400 mr-2"></i>
                            <span class="text-sm text-gray-600">${hotel.address || 'Адрес не указан'}</span>
                        </div>
                        
                        ${hotel.rating ? `
                            <div class="flex items-center mb-3">
                                <div class="flex text-yellow-400">
                                    ${'★'.repeat(Math.floor(hotel.rating))}${'☆'.repeat(5 - Math.floor(hotel.rating))}
                                </div>
                                <span class="ml-2 text-sm text-gray-600">${hotel.rating}/5</span>
                            </div>
                        ` : ''}
                        
                        ${amenities.length > 0 ? `
                            <div class="mb-4">
                                <div class="flex flex-wrap gap-1">
                                    ${amenities.slice(0, 3).map(amenity => `
                                        <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded">${amenity}</span>
                                    `).join('')}
                                    ${amenities.length > 3 ? `
                                        <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded">+${amenities.length - 3}</span>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="flex justify-between items-center">
                            <button onclick="editHotel(${hotel.id})" class="btn btn-primary btn-sm">
                                <i class="fas fa-edit mr-1"></i> Редактировать
                            </button>
                            <button onclick="deleteHotel(${hotel.id})" class="btn btn-danger btn-sm">
                                <i class="fas fa-trash mr-1"></i> Удалить
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function openHotelModal(hotelId = null) {
            // ИСПРАВЛЕНО: установка hotel-id вместо currentHotelId
            document.getElementById('hotel-id').value = hotelId;
            window.hotelImageURLs = [];
            document.getElementById('hotelModal').classList.add('active');
            
            // Reset the hidden input
            document.getElementById('hotelImages').value = '';
            
            // Очистить список изображений
            updateHotelImagesList();
            
            // Initialize the uploader
            setTimeout(() => {
                initializeHotelUploader();
            }, 100);
            
            if (hotelId) {
                document.getElementById('hotelModalTitle').textContent = 'Редактировать отель';
                loadHotelData(hotelId);
            } else {
                document.getElementById('hotelModalTitle').textContent = 'Добавить отель';
                document.getElementById('hotelForm').reset();
                clearRoomTypeFields(); // НОВОЕ: Очистить категории номеров для создания нового отеля
                clearMealTypeFields(); // НОВОЕ: Очистить типы питания для создания нового отеля
                if (hotelUploader) {
                    hotelUploader.clear('hotel-uploader-container');
                }
            }
        }
        
        function closeHotelModal() {
            document.getElementById('hotelModal').classList.remove('active');
            document.getElementById('hotelForm').reset();
            if (hotelUploader) {
                hotelUploader.clear('hotel-uploader-container');
            }
            window.hotelImageURLs = [];
            // ИСПРАВЛЕНО: очистка hotel-id вместо currentHotelId
            document.getElementById('hotel-id').value = '';
            
            // Reset the hidden input
            document.getElementById('hotelImages').value = '';
            
            // Очистить список изображений
            updateHotelImagesList();
            
            // НОВОЕ: Очистить категории номеров и типы питания при закрытии модала
            clearRoomTypeFields();
            clearMealTypeFields();
        }
        
        // НОВОЕ: Функция очистки полей категорий номеров
        function clearRoomTypeFields() {
            document.getElementById('roomSGL').checked = false;
            document.getElementById('roomTWL').checked = false;
            document.getElementById('roomDBL').checked = false;
            document.getElementById('priceSGL').value = '';
            document.getElementById('priceTWL').value = '';
            document.getElementById('priceDBL').value = '';
            document.getElementById('priceSGL').disabled = true;
            document.getElementById('priceTWL').disabled = true;
            document.getElementById('priceDBL').disabled = true;
        }
        
        // НОВОЕ: Функция очистки полей типов питания
        function clearMealTypeFields() {
            document.getElementById('mealRO').checked = false;
            document.getElementById('mealBB').checked = false;
            document.getElementById('mealHB').checked = false;
            document.getElementById('mealFB').checked = false;
            document.getElementById('mealAI').checked = false;
            document.getElementById('priceMealRO').value = '';
            document.getElementById('priceMealBB').value = '';
            document.getElementById('priceMealHB').value = '';
            document.getElementById('priceMealFB').value = '';
            document.getElementById('priceMealAI').value = '';
            document.getElementById('priceMealRO').disabled = true;
            document.getElementById('priceMealBB').disabled = true;
            document.getElementById('priceMealHB').disabled = true;
            document.getElementById('priceMealFB').disabled = true;
            document.getElementById('priceMealAI').disabled = true;
        }
        
        function loadHotelData(hotelId) {
            const apiUrl = getApiUrl();
            fetch(`${apiUrl}/hotels/${hotelId}`, {
                headers: getAuthHeaders()  // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Добавлена авторизация!
            })
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    return res.json();
                })
                .then(data => {
                    console.log('✅ Hotel data received:', data);
                    const hotel = data.data;
                    
                    // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Правильный парсинг JSON
                    let name, description, amenities;
                    try {
                        name = typeof hotel.name === 'string' ? JSON.parse(hotel.name) : (hotel.name || {});
                        console.log('✅ Parsed hotel name:', name);
                    } catch (e) {
                        console.warn('Failed to parse hotel name, using as object:', hotel.name);
                        name = hotel.name || {};
                    }
                    
                    try {
                        description = typeof hotel.description === 'string' ? JSON.parse(hotel.description) : (hotel.description || {});
                        console.log('✅ Parsed hotel description:', description);
                    } catch (e) {
                        console.warn('Failed to parse hotel description, using as object:', hotel.description);
                        description = hotel.description || {};
                    }
                    
                    try {
                        amenities = typeof hotel.amenities === 'string' ? JSON.parse(hotel.amenities) : (hotel.amenities || []);
                        console.log('✅ Parsed hotel amenities:', amenities);
                    } catch (e) {
                        console.warn('Failed to parse hotel amenities, using as array:', hotel.amenities);
                        amenities = Array.isArray(hotel.amenities) ? hotel.amenities : [];
                    }
                    
                    // УЛУЧШЕНИЕ: Лучшая обработка многоязычных полей
                    const hotelNameField = document.getElementById('hotelName');
                    const hotelDescField = document.getElementById('hotelDescription');
                    
                    if (hotelNameField) {
                        hotelNameField.value = name.ru || name.en || hotel.name || '';
                        console.log('✅ Loaded hotel name:', hotelNameField.value);
                    }
                    
                    if (hotelDescField) {
                        hotelDescField.value = description.ru || description.en || hotel.description || '';
                        console.log('✅ Loaded hotel description:', hotelDescField.value);
                    }
                    
                    // НОВОЕ: Загрузка категорий номеров при редактировании
                    if (hotel.roomTypes) {
                        try {
                            const roomTypes = typeof hotel.roomTypes === 'string' ? JSON.parse(hotel.roomTypes) : hotel.roomTypes;
                            
                            // SGL - Одноместный
                            if (roomTypes.SGL) {
                                document.getElementById('roomSGL').checked = true;
                                document.getElementById('priceSGL').disabled = false;
                                document.getElementById('priceSGL').value = roomTypes.SGL.price || '';
                                console.log('✅ Loaded SGL room type:', roomTypes.SGL);
                            }
                            
                            // TWL - Двухместный
                            if (roomTypes.TWL) {
                                document.getElementById('roomTWL').checked = true;
                                document.getElementById('priceTWL').disabled = false;
                                document.getElementById('priceTWL').value = roomTypes.TWL.price || '';
                                console.log('✅ Loaded TWL room type:', roomTypes.TWL);
                            }
                            
                            // DBL - Двухспальный
                            if (roomTypes.DBL) {
                                document.getElementById('roomDBL').checked = true;
                                document.getElementById('priceDBL').disabled = false;
                                document.getElementById('priceDBL').value = roomTypes.DBL.price || '';
                                console.log('✅ Loaded DBL room type:', roomTypes.DBL);
                            }
                        } catch (e) {
                            console.warn('Failed to parse room types:', hotel.roomTypes, e);
                        }
                    }
                    
                    // НОВОЕ: Загрузка типов питания при редактировании
                    if (hotel.mealTypes) {
                        try {
                            const mealTypes = typeof hotel.mealTypes === 'string' ? JSON.parse(hotel.mealTypes) : hotel.mealTypes;
                            
                            // RO - Без питания
                            if (mealTypes.RO) {
                                document.getElementById('mealRO').checked = true;
                                document.getElementById('priceMealRO').disabled = false;
                                document.getElementById('priceMealRO').value = mealTypes.RO.price || '';
                                console.log('✅ Loaded RO meal type:', mealTypes.RO);
                            }
                            
                            // BB - Завтрак
                            if (mealTypes.BB) {
                                document.getElementById('mealBB').checked = true;
                                document.getElementById('priceMealBB').disabled = false;
                                document.getElementById('priceMealBB').value = mealTypes.BB.price || '';
                                console.log('✅ Loaded BB meal type:', mealTypes.BB);
                            }
                            
                            // HB - Полупансион
                            if (mealTypes.HB) {
                                document.getElementById('mealHB').checked = true;
                                document.getElementById('priceMealHB').disabled = false;
                                document.getElementById('priceMealHB').value = mealTypes.HB.price || '';
                                console.log('✅ Loaded HB meal type:', mealTypes.HB);
                            }
                            
                            // FB - Полный пансион
                            if (mealTypes.FB) {
                                document.getElementById('mealFB').checked = true;
                                document.getElementById('priceMealFB').disabled = false;
                                document.getElementById('priceMealFB').value = mealTypes.FB.price || '';
                                console.log('✅ Loaded FB meal type:', mealTypes.FB);
                            }
                            
                            // AI - Все включено
                            if (mealTypes.AI) {
                                document.getElementById('mealAI').checked = true;
                                document.getElementById('priceMealAI').disabled = false;
                                document.getElementById('priceMealAI').value = mealTypes.AI.price || '';
                                console.log('✅ Loaded AI meal type:', mealTypes.AI);
                            }
                        } catch (e) {
                            console.warn('Failed to parse meal types:', hotel.mealTypes, e);
                        }
                    }
                    const addressField = document.getElementById('hotelAddress');
                    const starsField = document.getElementById('hotelStars');
                    
                    if (addressField) {
                        addressField.value = hotel.address || '';
                        console.log('✅ Loaded hotel address:', hotel.address);
                    }
                    
                    if (starsField) {
                        starsField.value = hotel.stars || '';
                        console.log('✅ Loaded hotel stars:', hotel.stars);
                    }
                    // Установка бренда с учетом пользовательского ввода
                    const brandSelect = document.getElementById('hotelBrand');
                    const brandCustom = document.getElementById('hotelBrandCustom');
                    
                    if (hotel.brand) {
                        // Проверить, есть ли бренд в списке
                        const brandOption = Array.from(brandSelect.options).find(option => option.value === hotel.brand);
                        if (brandOption) {
                            brandSelect.value = hotel.brand;
                            brandCustom.style.display = 'none';
                        } else {
                            // Бренд не в списке, использовать пользовательский ввод
                            brandSelect.value = 'custom';
                            brandCustom.value = hotel.brand;
                            brandCustom.style.display = 'block';
                        }
                    } else {
                        brandSelect.value = '';
                        brandCustom.style.display = 'none';
                    }
                    const categoryField = document.getElementById('hotelCategory');
                    if (categoryField) categoryField.value = hotel.category || '';
                    
                    const countryField = document.getElementById('hotelCountry');
                    if (countryField) countryField.value = hotel.country || '';
                    
                    const cityField = document.getElementById('hotelCity');
                    if (cityField) cityField.value = hotel.city || '';
                    
                    const pensionField = document.getElementById('hotelPension');
                    if (pensionField) pensionField.value = hotel.pension || 'none';
                    const hotelActiveField = document.getElementById('hotelActive');
                    if (hotelActiveField) {
                        hotelActiveField.checked = hotel.isActive;
                        console.log('✅ Set hotel active status:', hotel.isActive);
                    } else {
                        console.warn('❌ hotelActive field not found');
                    }
                    
                    // Set amenities - убеждаемся что amenities определен
                    if (amenities && Array.isArray(amenities)) {
                        document.querySelectorAll('#hotelForm input[type="checkbox"]').forEach(checkbox => {
                            if (checkbox.id !== 'hotelActive') {
                                checkbox.checked = amenities.includes(checkbox.value);
                                if (checkbox.checked) {
                                    console.log('✅ Set amenity checked:', checkbox.value);
                                }
                            }
                        });
                    } else {
                        console.warn('❌ Amenities not loaded properly:', amenities);
                    }
                    
                    // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Загрузка изображений отеля
                    if (hotel.images) {
                        try {
                            const images = typeof hotel.images === 'string' ? JSON.parse(hotel.images) : hotel.images;
                            if (Array.isArray(images) && images.length > 0) {
                                window.hotelImageURLs = [...images]; // Восстанавливаем изображения
                                document.getElementById('hotelImages').value = JSON.stringify(images); // Заполняем скрытое поле
                                console.log('✅ Loaded hotel images:', images);
                                
                                // Показываем загруженные изображения в интерфейсе
                                updateHotelImagesList();  
                                setTimeout(() => {
                                    const uploaderContainer = document.getElementById('hotel-uploader-container');
                                    if (uploaderContainer) {
                                        let imagesHtml = '<div class="uploaded-images-preview mb-3"><h4 class="text-sm font-semibold mb-2">Загруженные изображения:</h4><div class="flex gap-2 flex-wrap">';
                                        images.forEach((img, index) => {
                                            imagesHtml += `<div class="image-preview-item relative">
                                                <img src="${img}" alt="Hotel image ${index + 1}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid #e5e7eb;">
                                                <div class="text-xs text-gray-500 text-center mt-1">Изображение ${index + 1}</div>
                                            </div>`;
                                        });
                                        imagesHtml += '</div></div>';
                                        uploaderContainer.insertAdjacentHTML('afterbegin', imagesHtml);
                                    }
                                }, 500); // Задержка чтобы uploader успел загрузиться
                            } else {
                                console.log('✅ No images found for hotel');
                                window.hotelImageURLs = [];
                                document.getElementById('hotelImages').value = '';
                            }
                        } catch (e) {
                            console.error('Error parsing hotel images:', e);
                            window.hotelImageURLs = [];
                            document.getElementById('hotelImages').value = '';
                        }
                    } else {
                        console.log('✅ No images field found for hotel');
                        window.hotelImageURLs = [];
                        document.getElementById('hotelImages').value = '';
                    }
                })
                .catch(err => {
                    console.error('Error loading hotel data:', err);
                    console.error('Error details:', err.message, err.stack);
                    alert('Ошибка загрузки данных отеля: ' + err.message);
                });
        }
        
        function editHotel(hotelId) {
            openHotelModal(hotelId);
        }
        
        function deleteHotel(hotelId) {
            if (!confirm('Вы уверены, что хотите удалить этот отель?')) {
                return;
            }
            
            const apiUrl = getApiUrl();
            fetch(`${apiUrl}/hotels/${hotelId}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert('Отель успешно удален');
                        loadHotels();
                    } else {
                        alert('Ошибка при удалении отеля: ' + (data.message || 'Неизвестная ошибка'));
                    }
                })
                .catch(err => {
                    console.error('Error deleting hotel:', err);
                    alert('Ошибка при удалении отеля');
                });
        }
        
        function searchHotels() {
            const searchTerm = document.getElementById('hotelSearch').value.toLowerCase();
            const hotelCards = document.querySelectorAll('#hotelsList > div');
            
            hotelCards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }
        
        function filterHotels() {
            const filter = document.getElementById('hotelFilter').value;
            const hotelCards = document.querySelectorAll('#hotelsList > div');
            
            hotelCards.forEach(card => {
                if (filter === '') {
                    card.style.display = 'block';
                } else if (filter === 'active') {
                    const isActive = card.innerHTML.includes('badge-success');
                    card.style.display = isActive ? 'block' : 'none';
                } else if (filter === 'inactive') {
                    const isInactive = card.innerHTML.includes('badge-danger');
                    card.style.display = isInactive ? 'block' : 'none';
                }
            });
        }
        
        // Функция для получения выбранного бренда
        function getSelectedBrand() {
            const brandSelect = document.getElementById('hotelBrand');
            const brandCustom = document.getElementById('hotelBrandCustom');
            
            if (brandSelect.value === 'custom') {
                return brandCustom.value.trim() || null;
            }
            return brandSelect.value || null;
        }
        
        // Функция для добавления нового удобства
        function addNewAmenity() {
            const newAmenityInput = document.getElementById('newAmenity');
            const amenityName = newAmenityInput.value.trim();
            
            if (!amenityName) {
                alert('Введите название удобства');
                return;
            }
            
            // Проверить, не существует ли уже такое удобство
            const existingAmenities = document.querySelectorAll('#hotelAmenities input[type="checkbox"]');
            for (let checkbox of existingAmenities) {
                if (checkbox.value === amenityName) {
                    alert('Такое удобство уже существует');
                    return;
                }
            }
            
            // Создать новый чекбокс
            const amenitiesContainer = document.getElementById('hotelAmenities');
            const newCheckbox = document.createElement('label');
            newCheckbox.className = 'checkbox-item';
            newCheckbox.innerHTML = `
                <input type="checkbox" value="${amenityName}" checked> ${amenityName}
            `;
            
            amenitiesContainer.appendChild(newCheckbox);
            newAmenityInput.value = '';
        }
        
        // Обработчик изменения селекта бренда
        document.addEventListener('DOMContentLoaded', function() {
            const brandSelect = document.getElementById('hotelBrand');
            const brandCustomInput = document.getElementById('hotelBrandCustom');
            
            if (brandSelect && brandCustomInput) {
                brandSelect.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        brandCustomInput.style.display = 'block';
                        brandCustomInput.focus();
                    } else {
                        brandCustomInput.style.display = 'none';
                        brandCustomInput.value = '';
                    }
                });
            }
        });
        
        // Hotel form submit handler
        document.getElementById('hotelForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Build name object (русский приоритетный)
            const nameValue = document.getElementById('hotelName').value;
            const name = {
                ru: nameValue,
                en: nameValue,
                tj: nameValue
            };
            
            // Build description object (русский приоритетный)
            const descValue = document.getElementById('hotelDescription').value;
            const description = {
                ru: descValue,
                en: descValue,
                tj: descValue
            };
            
            // НОВОЕ: Обработка категорий номеров с ценами
            const roomTypes = {};
            
            // SGL - Одноместный
            if (document.getElementById('roomSGL').checked) {
                const price = document.getElementById('priceSGL').value;
                if (price && !isNaN(parseFloat(price))) {
                    roomTypes.SGL = {
                        name: 'Одноместный',
                        price: parseFloat(price)
                    };
                }
            }
            
            // TWL - Двухместный
            if (document.getElementById('roomTWL').checked) {
                const price = document.getElementById('priceTWL').value;
                if (price && !isNaN(parseFloat(price))) {
                    roomTypes.TWL = {
                        name: 'Двухместный', 
                        price: parseFloat(price)
                    };
                }
            }
            
            // DBL - Двухспальный
            if (document.getElementById('roomDBL').checked) {
                const price = document.getElementById('priceDBL').value;
                if (price && !isNaN(parseFloat(price))) {
                    roomTypes.DBL = {
                        name: 'Двухспальный',
                        price: parseFloat(price)
                    };
                }
            }
            
            // НОВОЕ: Обработка типов питания с ценами
            const mealTypes = {};
            
            // RO - Без питания
            if (document.getElementById('mealRO').checked) {
                const price = document.getElementById('priceMealRO').value;
                mealTypes.RO = {
                    name: 'Без питания',
                    price: price && !isNaN(parseFloat(price)) ? parseFloat(price) : 0
                };
            }
            
            // BB - Завтрак
            if (document.getElementById('mealBB').checked) {
                const price = document.getElementById('priceMealBB').value;
                if (price && !isNaN(parseFloat(price))) {
                    mealTypes.BB = {
                        name: 'Завтрак',
                        price: parseFloat(price)
                    };
                }
            }
            
            // HB - Полупансион
            if (document.getElementById('mealHB').checked) {
                const price = document.getElementById('priceMealHB').value;
                if (price && !isNaN(parseFloat(price))) {
                    mealTypes.HB = {
                        name: 'Полупансион',
                        price: parseFloat(price)
                    };
                }
            }
            
            // FB - Полный пансион
            if (document.getElementById('mealFB').checked) {
                const price = document.getElementById('priceMealFB').value;
                if (price && !isNaN(parseFloat(price))) {
                    mealTypes.FB = {
                        name: 'Полный пансион',
                        price: parseFloat(price)
                    };
                }
            }
            
            // AI - Все включено
            if (document.getElementById('mealAI').checked) {
                const price = document.getElementById('priceMealAI').value;
                if (price && !isNaN(parseFloat(price))) {
                    mealTypes.AI = {
                        name: 'Все включено',
                        price: parseFloat(price)
                    };
                }
            }
            
            // Get amenities (исключаем чекбоксы категорий номеров и типов питания)
            const amenities = [];
            document.querySelectorAll('#hotelForm input[type="checkbox"]:checked').forEach(checkbox => {
                if (checkbox.id !== 'hotelActive' && 
                    checkbox.id !== 'roomSGL' && 
                    checkbox.id !== 'roomTWL' && 
                    checkbox.id !== 'roomDBL' &&
                    checkbox.id !== 'mealRO' &&
                    checkbox.id !== 'mealBB' &&
                    checkbox.id !== 'mealHB' &&
                    checkbox.id !== 'mealFB' &&
                    checkbox.id !== 'mealAI') {
                    amenities.push(checkbox.value);
                }
            });
            
            // Build hotel data
            const hotelData = {
                name: JSON.stringify(name),
                description: JSON.stringify(description),
                address: document.getElementById('hotelAddress').value,
                stars: parseInt(document.getElementById('hotelStars').value) || null,
                brand: getSelectedBrand() || null,
                category: document.getElementById('hotelCategory')?.value || null,
                country: document.getElementById('hotelCountry')?.value || null,
                city: document.getElementById('hotelCity')?.value || null,
                pension: 'none', // Legacy field - теперь используем mealTypes
                amenities: JSON.stringify(amenities),
                roomTypes: JSON.stringify(roomTypes), // Категории номеров с ценами
                mealTypes: JSON.stringify(mealTypes), // НОВОЕ: Типы питания с ценами
                isActive: document.getElementById('hotelActive').checked,
                images: JSON.stringify(window.hotelImageURLs || []) // Use uploaded images
            };
            
            console.log('📝 Отправляем отель с данными:', hotelData);
            
            // ИСПРАВЛЕНО: Используем hotel-id для единой логики POST/PUT
            const hotelId = document.getElementById('hotel-id').value;
            const isEditing = hotelId && hotelId.trim() !== '';
            
            const apiUrl = getApiUrl();
            const url = isEditing ? `${apiUrl}/hotels/${hotelId}` : `${apiUrl}/hotels`;
            const method = isEditing ? 'PUT' : 'POST';
            
            // For now, send as JSON instead of FormData (images handled separately)
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    ...getAuthHeaders()
                },
                body: JSON.stringify(hotelData)
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert(isEditing ? 'Отель успешно обновлен' : 'Отель успешно создан');
                        closeHotelModal();
                        loadHotels();
                    } else {
                        alert('Ошибка: ' + (data.message || 'Неизвестная ошибка'));
                    }
                })
                .catch(err => {
                    console.error('Error saving hotel:', err);
                    alert('Ошибка при сохранении отеля');
                });
        });
        
        // НОВОЕ: JavaScript для управления полями категорий номеров и типов питания
        document.addEventListener('DOMContentLoaded', function() {
            // Обработчики для включения/выключения полей цены категорий номеров
            document.getElementById('roomSGL').addEventListener('change', function() {
                document.getElementById('priceSGL').disabled = !this.checked;
                if (!this.checked) document.getElementById('priceSGL').value = '';
            });
            
            document.getElementById('roomTWL').addEventListener('change', function() {
                document.getElementById('priceTWL').disabled = !this.checked;
                if (!this.checked) document.getElementById('priceTWL').value = '';
            });
            
            document.getElementById('roomDBL').addEventListener('change', function() {
                document.getElementById('priceDBL').disabled = !this.checked;
                if (!this.checked) document.getElementById('priceDBL').value = '';
            });
            
            // НОВОЕ: Обработчики для включения/выключения полей цены типов питания
            document.getElementById('mealRO').addEventListener('change', function() {
                document.getElementById('priceMealRO').disabled = !this.checked;
                if (!this.checked) document.getElementById('priceMealRO').value = '';
            });
            
            document.getElementById('mealBB').addEventListener('change', function() {
                document.getElementById('priceMealBB').disabled = !this.checked;
                if (!this.checked) document.getElementById('priceMealBB').value = '';
            });
            
            document.getElementById('mealHB').addEventListener('change', function() {
                document.getElementById('priceMealHB').disabled = !this.checked;
                if (!this.checked) document.getElementById('priceMealHB').value = '';
            });
            
            document.getElementById('mealFB').addEventListener('change', function() {
                document.getElementById('priceMealFB').disabled = !this.checked;
                if (!this.checked) document.getElementById('priceMealFB').value = '';
            });
            
            document.getElementById('mealAI').addEventListener('change', function() {
                document.getElementById('priceMealAI').disabled = !this.checked;
                if (!this.checked) document.getElementById('priceMealAI').value = '';
            });
        });

        // Initialize ObjectUploader for hotels
        let hotelUploader = null;
        let tourUploader = null;
        window.hotelImageURLs = [];
        window.tourImageURLs = [];

        // Функции управления изображениями отелей
        function removeHotelImage(index) {
            window.hotelImageURLs.splice(index, 1);
            updateHotelImagesList();
            // Update hidden input
            const hiddenField = document.getElementById('hotelImages');
            if (hiddenField) {
                hiddenField.value = JSON.stringify(window.hotelImageURLs);
            }
        }

        function updateHotelImagesList() {
            const container = document.getElementById('hotelImagesList');
            if (!container) {
                console.warn('hotelImagesList container not found');
                return;
            }
            
            if (!window.hotelImageURLs || window.hotelImageURLs.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Нет загруженных изображений</p>';
                return;
            }
            
            container.innerHTML = window.hotelImageURLs.map((imageUrl, index) => `
                <div class="flex items-center justify-between bg-gray-50 p-3 rounded border mb-2">
                    <div class="flex items-center gap-3">
                        <img src="${imageUrl}" alt="Hotel image" class="w-16 h-16 object-cover rounded" onerror="this.style.display='none';">
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-medium text-gray-900 truncate">${imageUrl}</div>
                        </div>
                    </div>
                    <button type="button" onclick="removeHotelImage(${index})" class="text-red-500 hover:text-red-700 ml-2">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        function initializeHotelUploader() {
            if (hotelUploader) return;
            
            hotelUploader = new ObjectUploader({
                maxFiles: 10,
                maxFileSize: 10 * 1024 * 1024, // 10MB
                onComplete: (fileInfo, allFiles) => {
                    console.log('Hotel image uploaded:', fileInfo);
                    
                    // Normalize the object path for database storage
                    fetch('/api/images', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ imageURL: fileInfo.url })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.hotelImageURLs = window.hotelImageURLs || [];
                            window.hotelImageURLs.push(data.objectPath);
                            // Update hidden input for form submission
                            const hiddenField = document.getElementById('hotelImages');
                            if (hiddenField) {
                                hiddenField.value = JSON.stringify(window.hotelImageURLs);
                            }
                            // Update the display
                            updateHotelImagesList();
                            console.log('Hotel image processed:', data.objectPath);
                        }
                    })
                    .catch(error => {
                        console.error('Error processing uploaded image:', error);
                    });
                },
                onError: (error) => {
                    alert('Ошибка загрузки: ' + error);
                }
            });
            
            hotelUploader.createElement('hotel-uploader-container');
        }

        function initializeTourUploader() {
            if (tourUploader) return;
            
            tourUploader = new ObjectUploader({
                maxFiles: 15,
                maxFileSize: 10 * 1024 * 1024, // 10MB
                onComplete: (fileInfo, allFiles) => {
                    console.log('Tour image uploaded:', fileInfo);
                    
                    // Normalize the object path for database storage
                    fetch('/api/images', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ imageURL: fileInfo.url })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.tourImageURLs = window.tourImageURLs || [];
                            window.tourGalleryImages = window.tourGalleryImages || [];
                            
                            window.tourImageURLs.push(data.objectPath);
                            window.tourGalleryImages.push(data.objectPath);
                            
                            // Update hidden input for form submission
                            const hiddenField = document.getElementById('tourImages');
                            if (hiddenField) {
                                hiddenField.value = JSON.stringify(window.tourImageURLs);
                            }
                            
                            // Set as main image if it's the first one
                            if (window.tourGalleryImages.length === 1) {
                                const mainImageInput = document.getElementById('tourMainImage');
                                if (mainImageInput) {
                                    mainImageInput.value = data.objectPath;
                                    console.log('Set main image for create:', data.objectPath);
                                }
                            }
                            
                            // Update gallery display
                            updateGalleryImagesList();
                            console.log('Tour image processed:', data.objectPath);
                        }
                    })
                    .catch(error => {
                        console.error('Error processing uploaded image:', error);
                    });
                },
                onError: (error) => {
                    alert('Ошибка загрузки: ' + error);
                }
            });
            
            tourUploader.createElement('tour-uploader-container');
        }

        function initializeTourEditUploader() {
            if (window.tourEditUploader) return;
            
            window.tourEditUploader = new ObjectUploader({
                maxFiles: 15,
                maxFileSize: 10 * 1024 * 1024, // 10MB
                onComplete: (fileInfo, allFiles) => {
                    console.log('Tour edit image uploaded:', fileInfo);
                    
                    // Normalize the object path for database storage
                    fetch('/api/images', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ imageURL: fileInfo.url })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.tourImageURLs.push(data.objectPath);
                            // Update gallery images array
                            window.tourGalleryImages = window.tourGalleryImages || [];
                            window.tourGalleryImages.push(data.objectPath);
                            
                            // Set as main image if it's the first one
                            if (window.tourGalleryImages.length === 1) {
                                const editMainImageInput = document.getElementById('eTourMainImage');
                                if (editMainImageInput) {
                                    editMainImageInput.value = data.objectPath;
                                    console.log('Set edit main image:', data.objectPath);
                                }
                            }
                            
                            // Update gallery display for edit form
                            updateGalleryImagesList();
                        }
                    })
                    .catch(error => {
                        console.error('Error processing uploaded image:', error);
                    });
                },
                onError: (error) => {
                    alert('Ошибка загрузки: ' + error);
                }
            });
            
            // ИСПРАВЛЕНО: Не используем несуществующий tour-edit-uploader-container
        }

        // Bookings functions
        function loadBookings(status = 'all') {
            let url = `${getApiUrl()}/orders`;
            if (status !== 'all') {
                url += `?status=${status}`;
            }
            
            fetch(url, {
                headers: getAuthHeaders()
            })
                .then(res => res.json())
                .then(data => {
                    const tbody = document.getElementById('bookingsTable');
                    const orders = data.data || data.orders || [];
                    if (orders.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="10" class="text-center text-gray-500">Нет заказов</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = orders.map(order => `
                        <tr>
                            <td class="font-medium">${order.orderNumber || 'N/A'}</td>
                            <td>${formatDate(order.createdAt)}</td>
                            <td>${order.customer?.fullName || 'Неизвестно'}</td>
                            <td>${getTourName(order.tour)}</td>
                            <td>${order.tourDate || '-'}</td>
                            <td>${JSON.parse(order.tourists || '[]').length} чел.</td>
                            <td class="font-semibold">$${order.totalAmount}</td>
                            <td>${getPaymentBadge(order.paymentStatus)}</td>
                            <td>${getStatusBadge(order.status)}</td>
                            <td>
                                <button onclick="viewBooking(${order.id})" class="text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                })
                .catch(err => {
                    console.error('Error loading bookings:', err);
                });
        }
        
        function viewBooking(bookingId) {
            currentBookingId = bookingId;
            document.getElementById('bookingModal').classList.add('active');
            
            fetch(`${getApiUrl()}/orders/${bookingId}`, {
                headers: getAuthHeaders()
            })
                .then(res => res.json())
                .then(data => {
                    const order = data.order;
                    const tourists = JSON.parse(order.tourists || '[]');
                    
                    document.getElementById('bookingDetails').innerHTML = `
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm text-gray-600">Номер заказа</p>
                                    <p class="font-semibold">${order.orderNumber}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Дата заказа</p>
                                    <p class="font-semibold">${formatDate(order.createdAt)}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Клиент</p>
                                    <p class="font-semibold">${order.customer?.fullName}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Email</p>
                                    <p class="font-semibold">${order.customer?.email}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Тур</p>
                                    <p class="font-semibold">${getTourName(order.tour)}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Дата тура</p>
                                    <p class="font-semibold">${order.tourDate}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Отель</p>
                                    <p class="font-semibold">${order.hotel ? getHotelName(order.hotel) : 'Не выбран'}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-600">Гид</p>
                                    <p class="font-semibold">${order.guide ? getGuideName(order.guide) : 'Не выбран'}</p>
                                </div>
                            </div>
                            
                            <div>
                                <p class="text-sm text-gray-600 mb-2">Список туристов</p>
                                <div class="bg-gray-50 p-3 rounded">
                                    ${tourists.map((t, i) => `
                                        <div class="mb-2">
                                            ${i + 1}. ${t.fullName} (${t.birthDate})
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            ${order.wishes ? `
                                <div>
                                    <p class="text-sm text-gray-600 mb-2">Пожелания клиента</p>
                                    <div class="bg-gray-50 p-3 rounded">
                                        ${order.wishes}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="flex justify-between items-center pt-4 border-t">
                                <div>
                                    <p class="text-sm text-gray-600">Общая сумма</p>
                                    <p class="text-2xl font-bold text-green-600">$${order.totalAmount}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-gray-600">Статус</p>
                                    <p>${getStatusBadge(order.status)}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
        }
        
        function closeBookingModal() {
            document.getElementById('bookingModal').classList.remove('active');
            currentBookingId = null;
        }
        
        // Hotels functions - moved to line 4302
        
        // Guides functions
        function loadGuides() {
            fetch(`${getApiUrl()}/guides`, {
                headers: getAuthHeaders()
            })
                .then(res => res.json())
                .then(data => {
                    const container = document.getElementById('guidesList');
                    
                    const guides = data.data || data.guides || [];
                    if (guides.length === 0) {
                        container.innerHTML = '<p class="text-gray-500">Нет гидов</p>';
                        return;
                    }
                    
                    container.innerHTML = guides.map(guide => {
                        const name = JSON.parse(guide.name || '{}');
                        const languages = JSON.parse(guide.languages || '[]');
                        
                        return `
                            <div class="bg-white rounded-lg shadow-sm p-4">
                                <div class="flex items-center mb-4">
                                    ${guide.photo ? 
                                        `<img src="${guide.photo}" alt="${name.ru}" class="w-16 h-16 rounded-full object-cover mr-4">` :
                                        `<div class="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center mr-4">
                                            <i class="fas fa-user text-gray-400 text-2xl"></i>
                                        </div>`
                                    }
                                    <div>
                                        <h3 class="font-semibold text-lg">${name.ru || name.en || 'Гид'}</h3>
                                        <p class="text-sm text-gray-600">${guide.experience || 0} лет опыта</p>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <p class="text-sm text-gray-600 mb-1">Языки:</p>
                                    <div class="flex flex-wrap gap-1">
                                        ${languages.map(lang => `
                                            <span class="badge badge-info text-xs">${lang}</span>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-yellow-500">
                                        ${'★'.repeat(Math.floor(guide.rating || 5))}${'☆'.repeat(5 - Math.floor(guide.rating || 5))}
                                    </span>
                                    <div>
                                        <button onclick="editGuide(${guide.id})" class="text-blue-600 hover:text-blue-800 mr-2">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteGuide(${guide.id})" class="text-red-600 hover:text-red-800">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                });
        }
        
        // Reviews functions
        function loadReviews(filter = 'all') {
            fetch(`${getApiUrl()}/reviews`, {
                headers: getAuthHeaders()
            })
                .then(res => res.json())
                .then(data => {
                    const tbody = document.getElementById('reviewsTable');
                    let reviews = data.data || data.reviews || [];
                    
                    // Filter reviews
                    if (filter === 'pending') {
                        reviews = reviews.filter(r => !r.isModerated);
                    } else if (filter === 'approved') {
                        reviews = reviews.filter(r => r.isApproved);
                    } else if (filter === 'rejected') {
                        reviews = reviews.filter(r => r.isModerated && !r.isApproved);
                    }
                    
                    if (reviews.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-gray-500">Нет отзывов</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = reviews.map(review => `
                        <tr>
                            <td>${review.id}</td>
                            <td>${formatDate(review.createdAt)}</td>
                            <td>${review.reviewerName || review.customer?.fullName || 'Аноним'}</td>
                            <td>${getTourName(review.tour)}</td>
                            <td>
                                <span class="text-yellow-500">
                                    ${'★'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}
                                </span>
                            </td>
                            <td class="max-w-xs">
                                <div class="truncate" title="${review.text}">${review.text}</div>
                                ${review.text.length > 100 ? 
                                    `<button onclick="showFullReview('${review.text.replace(/'/g, "\\'")}')" class="text-blue-600 text-xs">показать полностью</button>` 
                                    : ''
                                }
                            </td>
                            <td>
                                ${review.photos ? renderReviewPhotos(review.photos) : '<span class="text-gray-400">Нет фото</span>'}
                            </td>
                            <td>
                                ${!review.isModerated ? 
                                    '<span class="badge badge-warning">На модерации</span>' :
                                    review.isApproved ?
                                        '<span class="badge badge-success">Одобрен</span>' :
                                        '<span class="badge badge-danger">Отклонен</span>'
                                }
                            </td>
                            <td>
                                ${!review.isModerated ? `
                                    <button onclick="approveReview(${review.id})" class="text-green-600 hover:text-green-800 mr-2" title="Одобрить">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button onclick="rejectReview(${review.id})" class="text-red-600 hover:text-red-800" title="Отклонить">
                                        <i class="fas fa-times"></i>
                                    </button>
                                ` : `
                                    <button onclick="deleteReview(${review.id})" class="text-red-600 hover:text-red-800" title="Удалить">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                `}
                            </td>
                        </tr>
                    `).join('');
                });
        }
        
        // Функция для отображения фотографий отзыва
        function renderReviewPhotos(photosData) {
            try {
                // API возвращает photos как массив, не как JSON строку
                let photos = photosData;
                if (typeof photosData === 'string') {
                    photos = JSON.parse(photosData);
                }
                
                if (!Array.isArray(photos) || photos.length === 0) {
                    return '<span class="text-gray-400">Нет фото</span>';
                }
                
                return `
                    <div class="flex gap-1">
                        ${photos.slice(0, 3).map(photo => `
                            <img src="${photo}" alt="Фото отзыва" 
                                 class="w-8 h-8 object-cover rounded cursor-pointer" 
                                 onclick="showPhotoModal('${photo}')"
                                 title="Нажмите для увеличения">
                        `).join('')}
                        ${photos.length > 3 ? `<span class="text-xs text-gray-500">+${photos.length - 3}</span>` : ''}
                    </div>
                `;
            } catch (e) {
                return '<span class="text-gray-400">Нет фото</span>';
            }
        }
        
        // Функция для показа полного текста отзыва
        function showFullReview(text) {
            alert(text);
        }
        
        // Функция для показа фотографии в модальном окне
        function showPhotoModal(photoUrl) {
            const modal = `
                <div id="photoModal" class="modal active" onclick="closePhotoModal()">
                    <div class="modal-content" style="max-width: 90%; background: transparent; padding: 0;">
                        <img src="${photoUrl}" alt="Фото отзыва" style="max-width: 100%; max-height: 90vh; border-radius: 8px;">
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modal);
        }
        
        // Функция для закрытия модального окна с фотографией
        function closePhotoModal() {
            const modal = document.getElementById('photoModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Helper functions
        function getTourName(tour) {
            if (!tour) return 'Неизвестно';
            // API возвращает title как объект, не как JSON строку
            if (typeof tour.title === 'object') {
                return tour.title.ru || tour.title.en || 'Без названия';
            }
            // Если это строка JSON, парсим её
            try {
                const title = JSON.parse(tour.title || '{}');
                return title.ru || title.en || 'Без названия';
            } catch {
                return tour.title || 'Без названия';
            }
        }
        
        function getHotelName(hotel) {
            if (!hotel) return 'Неизвестно';
            const name = JSON.parse(hotel.name || '{}');
            return name.ru || name.en || 'Отель';
        }
        
        function getGuideName(guide) {
            if (!guide) return 'Неизвестно';
            const name = JSON.parse(guide.name || '{}');
            return name.ru || name.en || 'Гид';
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU');
        }
        
        function getStatusBadge(status) {
            const badges = {
                pending: '<span class="badge badge-warning">Ожидает</span>',
                confirmed: '<span class="badge badge-info">Подтвержден</span>',
                paid: '<span class="badge badge-success">Оплачен</span>',
                completed: '<span class="badge badge-success">Завершен</span>',
                cancelled: '<span class="badge badge-danger">Отменен</span>'
            };
            return badges[status] || '<span class="badge">Неизвестно</span>';
        }
        
        function getPaymentBadge(status) {
            const badges = {
                unpaid: '<span class="badge badge-warning">Не оплачен</span>',
                paid: '<span class="badge badge-success">Оплачен</span>',
                refunded: '<span class="badge badge-danger">Возврат</span>'
            };
            return badges[status] || '<span class="badge">Неизвестно</span>';
        }
        
        // Tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                const parent = this.parentElement;
                parent.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                const status = this.dataset.status;
                const filter = this.dataset.filter;
                
                if (status) {
                    loadBookings(status);
                } else if (filter) {
                    loadReviews(filter);
                }
            });
        });
        
        // Form submissions - ИСПОЛЬЗУЕМ ЕДИНУЮ ФУНКЦИЮ СОХРАНЕНИЯ  
        const tourFormElement = document.getElementById('tourForm');
        if (tourFormElement) {
            tourFormElement.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('🔥 tourForm submit - calling saveTourForm');
                saveTourForm(); // Новая функция для основной формы
            });
        }
        
        // Additional functions
        function editTour(id) {
            console.log('🎯 editTour called with ID:', id);
            // Очищаем все чекбоксы перед загрузкой новых данных
            document.querySelectorAll('input[name="selectedHotels"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('input[name="selectedGuides"]').forEach(cb => cb.checked = false);
            openTourModal(id);
        }
        
        function deleteTour(id) {
            if (confirm('Вы уверены, что хотите удалить этот тур?')) {
                fetch(`${getApiUrl()}/tours/${id}`, {
                    method: 'DELETE'
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert('Тур успешно удален');
                        loadTours();
                    }
                });
            }
        }
        
        function copyReviewLink(tourId) {
            const baseUrl = window.location.origin;
            const reviewLink = `${baseUrl}/review-form.html?tourId=${tourId}`;
            
            // Копируем ссылку в буфер обмена
            navigator.clipboard.writeText(reviewLink).then(() => {
                // Показываем уведомление об успешном копировании
                showNotification('Ссылка для отзывов скопирована в буфер обмена!', 'success');
            }).catch(err => {
                console.error('Ошибка копирования:', err);
                // Fallback для старых браузеров
                const textArea = document.createElement('textarea');
                textArea.value = reviewLink;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showNotification('Ссылка для отзывов скопирована!', 'success');
                } catch (err) {
                    showNotification('Ошибка копирования ссылки', 'error');
                }
                document.body.removeChild(textArea);
            });
        }
        
        function showNotification(message, type = 'info') {
            // Создаем элемент уведомления
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;
            
            // Добавляем на страницу
            document.body.appendChild(notification);
            
            // Убираем через 3 секунды
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
        
        function confirmBooking() {
            if (currentBookingId) {
                fetch(`${getApiUrl()}/orders/${currentBookingId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: 'confirmed' })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert('Заказ подтвержден');
                        closeBookingModal();
                        loadBookings();
                    }
                });
            }
        }
        
        function cancelBooking() {
            if (currentBookingId && confirm('Вы уверены, что хотите отменить этот заказ?')) {
                fetch(`${getApiUrl()}/orders/${currentBookingId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: 'cancelled' })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert('Заказ отменен');
                        closeBookingModal();
                        loadBookings();
                    }
                });
            }
        }
        
        function approveReview(id) {
            fetch(`${getApiUrl()}/reviews/${id}/moderate`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ isApproved: true })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Отзыв одобрен');
                    loadReviews();
                } else {
                    alert('Ошибка: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Ошибка при одобрении отзыва');
            });
        }
        
        function rejectReview(id) {
            fetch(`${getApiUrl()}/reviews/${id}/moderate`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ isApproved: false })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Отзыв отклонен');
                    loadReviews();
                } else {
                    alert('Ошибка: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Ошибка при отклонении отзыва');
            });
        }
        
        function deleteReview(id) {
            if (confirm('Вы уверены, что хотите удалить этот отзыв?')) {
                fetch(`${getApiUrl()}/reviews/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert('Отзыв удален');
                        loadReviews();
                    } else {
                        alert('Ошибка: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    alert('Ошибка при удалении отзыва');
                });
            }
        }
        
        function openGuideModal() {
            const modal = `
                <div id="guideModal" class="modal active">
                    <div class="modal-content" style="width: 600px;">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-semibold">Добавить гида</h2>
                            <button onclick="closeGuideModal()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <form id="guideForm">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="form-group">
                                    <label class="form-label">Имя (Русский)</label>
                                    <input type="text" class="form-input" id="guideNameRu" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Имя (English)</label>
                                    <input type="text" class="form-input" id="guideNameEn" required>
                                </div>
                                <div class="form-group col-span-2">
                                    <label class="form-label">Описание (Русский)</label>
                                    <textarea class="form-input" rows="3" id="guideDescRu"></textarea>
                                </div>
                                <div class="form-group col-span-2">
                                    <label class="form-label">Описание (English)</label>
                                    <textarea class="form-input" rows="3" id="guideDescEn"></textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Языки</label>
                                    <input type="text" class="form-input" id="guideLanguages" placeholder="Русский, English, Тоҷикӣ">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Опыт работы (лет)</label>
                                    <input type="number" class="form-input" id="guideExperience" min="0">
                                </div>
                                <div class="form-group col-span-2">
                                    <label class="form-label">Контакты</label>
                                    <input type="text" class="form-input" id="guideContact" placeholder="Телефон, Email">
                                </div>
                            </div>
                            
                            <div class="flex justify-end gap-3 mt-6">
                                <button type="button" onclick="closeGuideModal()" class="btn btn-secondary">Отмена</button>
                                <button type="submit" class="btn btn-primary">Сохранить</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modal);
            
            document.getElementById('guideForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveGuide();
            });
        }
        
        function closeGuideModal() {
            const modal = document.getElementById('guideModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function saveGuide() {
            const formData = {
                name: JSON.stringify({
                    ru: document.getElementById('guideNameRu').value,
                    en: document.getElementById('guideNameEn').value
                }),
                description: JSON.stringify({
                    ru: document.getElementById('guideDescRu').value,
                    en: document.getElementById('guideDescEn').value
                }),
                languages: document.getElementById('guideLanguages').value.split(',').map(l => l.trim()).filter(l => l),
                experience: parseInt(document.getElementById('guideExperience').value) || 0,
                contact: document.getElementById('guideContact').value,
                isActive: true
            };
            
            fetch(`${getApiUrl()}/guides`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(formData)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Гид успешно создан!');
                    closeGuideModal();
                    loadGuides();
                } else {
                    alert('Ошибка при создании гида: ' + (data.message || 'Неизвестная ошибка'));
                }
            })
            .catch(err => {
                console.error('Error saving guide:', err);
                alert('Ошибка при сохранении гида');
            });
        }
        
        function editGuide(id) {
            alert('Редактирование гида будет добавлено в следующем обновлении');
        }
        
        function deleteGuide(id) {
            if (confirm('Вы уверены, что хотите удалить этого гида?')) {
                fetch(`${getApiUrl()}/guides/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert('Гид успешно удален');
                        loadGuides();
                    } else {
                        alert('Ошибка при удалении гида: ' + (data.message || 'Неизвестная ошибка'));
                    }
                })
                .catch(err => {
                    console.error('Error deleting guide:', err);
                    alert('Ошибка при удалении гида');
                });
            }
        }

        // =============================================
        // CMS FUNCTIONS
        // =============================================
        
        // CMS Tab switching - ИСПРАВЛЕНО
        function switchCMSTab(tab) {
            // Удалено: cmsToursTab больше не существует
            document.getElementById('cmsBlocksTab').style.display = 'none';
            document.getElementById('cmsSettingsTab').style.display = 'none';
            document.getElementById('cmsHomepageTab').style.display = 'none';
            
            // Show selected tab
            document.getElementById(`cms${tab.charAt(0).toUpperCase() + tab.slice(1)}Tab`).style.display = 'block';
            
            // Update tab buttons
            document.querySelectorAll('#cmsSection .tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Load data for the selected tab
            switch(tab) {
                case 'blocks':
                    loadCMSContentBlocks();
                    break;
                case 'settings':
                    loadCMSSettings();
                    break;
                case 'homepage':
                    loadCMSHomepageContent();
                    break;
            }
        }
        
        // Load CMS Content Blocks
        function loadCMSContentBlocks() {
            console.log('Loading CMS content blocks...');
            fetch(`${getApiUrl()}/cms/content-blocks`, {
                headers: getAuthHeaders()
            })
            .then(res => res.json())
            .then(data => {
                console.log('CMS Content blocks response:', data);
                const tbody = document.getElementById('contentBlocksTable');
                
                if (!data.success || !data.data || data.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500">Нет блоков контента</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.data.map(block => {
                    const title = JSON.parse(block.title || '{}');
                    return `
                        <tr>
                            <td class="font-medium">${block.id}</td>
                            <td>${block.type}</td>
                            <td>${title.ru || 'Не указано'}</td>
                            <td>${title.en || 'Не указано'}</td>
                            <td>${block.isActive ? '<span class="badge badge-success">Активен</span>' : '<span class="badge badge-warning">Неактивен</span>'}</td>
                            <td>${formatDate(block.updatedAt)}</td>
                            <td class="flex gap-2">
                                <button onclick="editContentBlock(${block.id})" class="text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteContentBlock(${block.id})" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            })
            .catch(err => {
                console.error('Error loading content blocks:', err);
                const tbody = document.getElementById('contentBlocksTable');
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-red-500">Ошибка загрузки данных</td></tr>';
            });
        }
        
        // Open Content Block Modal
        function openContentBlockModal(id = null) {
            currentContentBlockId = id;
            const modal = document.getElementById('contentBlockModal');
            const title = document.getElementById('contentBlockModalTitle');
            
            if (id) {
                title.textContent = 'Редактировать блок контента';
                loadContentBlockData(id);
            } else {
                title.textContent = 'Добавить блок контента';
                document.getElementById('contentBlockForm').reset();
            }
            
            modal.classList.add('active');
        }
        
        // Close Content Block Modal
        function closeContentBlockModal() {
            document.getElementById('contentBlockModal').classList.remove('active');
            currentContentBlockId = null;
        }
        
        // Load Content Block Data for editing
        function loadContentBlockData(id) {
            fetch(`${getApiUrl()}/cms/content-blocks/${id}`, {
                headers: getAuthHeaders()
            })
            .then(res => res.json())
            .then(data => {
                if (data.success && data.data) {
                    const block = data.data;
                    const title = JSON.parse(block.title || '{}');
                    const content = JSON.parse(block.content || '{}');
                    
                    document.getElementById('blockType').value = block.type;
                    document.getElementById('blockOrder').value = block.sortOrder;
                    document.getElementById('blockActive').checked = block.isActive;
                    
                    // Fill multilingual fields
                    ['ru', 'en', 'tj', 'fa', 'de', 'zh'].forEach(lang => {
                        const titleField = document.getElementById(`blockTitle_${lang}`);
                        const contentField = document.getElementById(`blockContent_${lang}`);
                        if (titleField) titleField.value = title[lang] || '';
                        if (contentField) contentField.value = content[lang] || '';
                    });
                }
            })
            .catch(err => {
                console.error('Error loading content block:', err);
                alert('Ошибка загрузки блока');
            });
        }
        
        // Save Content Block
        document.getElementById('contentBlockForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const title = {};
            const content = {};
            
            ['ru', 'en', 'tj', 'fa', 'de', 'zh'].forEach(lang => {
                const titleField = document.getElementById(`blockTitle_${lang}`);
                const contentField = document.getElementById(`blockContent_${lang}`);
                if (titleField) title[lang] = titleField.value;
                if (contentField) content[lang] = contentField.value;
            });
            
            const formData = {
                type: document.getElementById('blockType').value,
                title: JSON.stringify(title),
                content: JSON.stringify(content),
                sortOrder: parseInt(document.getElementById('blockOrder').value),
                isActive: document.getElementById('blockActive').checked
            };
            
            const url = currentContentBlockId ? 
                `${getApiUrl()}/cms/content-blocks/${currentContentBlockId}` : 
                `${getApiUrl()}/cms/content-blocks`;
            const method = currentContentBlockId ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: getAuthHeaders(),
                body: JSON.stringify(formData)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Блок контента успешно сохранен!');
                    closeContentBlockModal();
                    loadCMSContentBlocks();
                } else {
                    alert('Ошибка при сохранении: ' + (data.message || 'Неизвестная ошибка'));
                }
            })
            .catch(err => {
                console.error('Error saving content block:', err);
                alert('Ошибка соединения с сервером');
            });
        });
        
        // Edit Content Block
        function editContentBlock(id) {
            openContentBlockModal(id);
        }
        
        // Delete Content Block
        function deleteContentBlock(id) {
            if (confirm('Вы уверены, что хотите удалить этот блок контента?')) {
                fetch(`${getApiUrl()}/cms/content-blocks/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert('Блок контента удален');
                        loadCMSContentBlocks();
                    } else {
                        alert('Ошибка при удалении: ' + (data.message || 'Неизвестная ошибка'));
                    }
                })
                .catch(err => {
                    console.error('Error deleting content block:', err);
                    alert('Ошибка соединения с сервером');
                });
            }
        }
        
        // Load CMS Settings
        function loadCMSSettings() {
            fetch(`${getApiUrl()}/cms/settings`, {
                headers: getAuthHeaders()
            })
            .then(res => res.json())
            .then(data => {
                if (data.success && data.data) {
                    const settings = data.data;
                    const siteTitle = JSON.parse(settings.siteTitle || '{}');
                    const siteDescription = JSON.parse(settings.siteDescription || '{}');
                    
                    document.getElementById('siteTitle_ru').value = siteTitle.ru || '';
                    document.getElementById('siteTitle_en').value = siteTitle.en || '';
                    document.getElementById('siteDescription_ru').value = siteDescription.ru || '';
                    document.getElementById('siteDescription_en').value = siteDescription.en || '';
                    document.getElementById('contactEmail').value = settings.contactEmail || '';
                    document.getElementById('contactPhone').value = settings.contactPhone || '';
                }
            })
            .catch(err => {
                console.error('Error loading CMS settings:', err);
            });
        }
        
        // Save CMS Settings
        document.getElementById('siteSettingsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                siteTitle: JSON.stringify({
                    ru: document.getElementById('siteTitle_ru').value,
                    en: document.getElementById('siteTitle_en').value
                }),
                siteDescription: JSON.stringify({
                    ru: document.getElementById('siteDescription_ru').value,
                    en: document.getElementById('siteDescription_en').value
                }),
                contactEmail: document.getElementById('contactEmail').value,
                contactPhone: document.getElementById('contactPhone').value
            };
            
            fetch(`${getApiUrl()}/cms/settings`, {
                method: 'PUT',
                headers: getAuthHeaders(),
                body: JSON.stringify(formData)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Настройки сайта успешно сохранены!');
                } else {
                    alert('Ошибка при сохранении настроек: ' + (data.message || 'Неизвестная ошибка'));
                }
            })
            .catch(err => {
                console.error('Error saving settings:', err);
                alert('Ошибка соединения с сервером');
            });
        });
        
        // Load CMS Homepage Content
        function loadCMSHomepageContent() {
            fetch(`${getApiUrl()}/public/homepage?lang=ru`, {
                headers: getAuthHeaders()
            })
            .then(res => res.json())
            .then(data => {
                const container = document.getElementById('homepageContentList');
                
                if (!data.success || !data.data) {
                    container.innerHTML = '<div class="text-center text-gray-500">Нет контента для главной страницы</div>';
                    return;
                }
                
                const { settings, contentBlocks } = data.data;
                
                let html = '<div class="bg-white rounded-xl shadow-sm p-6 mb-4">';
                html += '<h3 class="text-lg font-semibold mb-2">Настройки сайта</h3>';
                html += `<p><strong>Название сайта:</strong> ${settings.siteTitle || 'Не указано'}</p>`;
                html += `<p><strong>Описание:</strong> ${settings.siteDescription || 'Не указано'}</p>`;
                html += `<p><strong>Email:</strong> ${settings.contactEmail || 'Не указано'}</p>`;
                html += `<p><strong>Телефон:</strong> ${settings.contactPhone || 'Не указано'}</p>`;
                html += '</div>';
                
                if (contentBlocks.length > 0) {
                    html += '<div class="bg-white rounded-xl shadow-sm p-6">';
                    html += '<h3 class="text-lg font-semibold mb-4">Активные блоки контента</h3>';
                    contentBlocks.forEach(block => {
                        html += `
                            <div class="border-b border-gray-200 pb-4 mb-4 last:border-b-0">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h4 class="font-medium">${block.title || 'Без названия'}</h4>
                                        <p class="text-sm text-gray-600">${block.type}</p>
                                        <p class="text-sm text-gray-500 mt-2">${(block.content || '').substring(0, 150)}...</p>
                                    </div>
                                    <button onclick="editContentBlock(${block.id})" class="btn btn-primary btn-sm">
                                        Редактировать
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                
                container.innerHTML = html;
            })
            .catch(err => {
                console.error('Error loading homepage content:', err);
                const container = document.getElementById('homepageContentList');
                container.innerHTML = '<div class="text-center text-red-500">Ошибка загрузки контента</div>';
            });
        }

        // Tour Blocks Management Functions
        function switchCMSTab(tab) {
            // Hide all tabs
            document.getElementById('cmsBlocksTab').style.display = 'none';
            document.getElementById('cmsSettingsTab').style.display = 'none';
            // Удалено: cmsToursTab больше не существует
            
            // Remove active class from all tab buttons
            document.querySelectorAll('#cmsSection .tab-button').forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab and add active class
            if (tab === 'blocks') {
                document.getElementById('cmsBlocksTab').style.display = 'block';
                document.querySelector('#cmsSection .tab-button:nth-child(1)').classList.add('active');
                loadTourBlocks();
            } else if (tab === 'settings') {
                document.getElementById('cmsSettingsTab').style.display = 'block';
                document.querySelector('#cmsSection .tab-button:nth-child(2)').classList.add('active');
                loadCMSSettings();
            } else if (tab === 'tours') {
                // Удалено: cmsToursTab больше не существует
                document.querySelector('#cmsSection .tab-button:nth-child(3)').classList.add('active');
                loadEnhancedTourForm();
            }
        }

        // Load Tour Blocks
        function loadTourBlocks() {
            fetch(`${getApiUrl()}/tour-blocks`, {
                headers: getAuthHeaders()
            })
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('tourBlocksTable');
                
                if (!data.success || !data.data || data.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-gray-500">Нет блоков туров</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.data.map(block => {
                    const title = typeof block.title === 'string' ? JSON.parse(block.title || '{}') : block.title || {};
                    const toursCount = block.tours ? block.tours.length : 0;
                    return `
                        <tr>
                            <td class="font-medium">${block.id}</td>
                            <td>${title.ru || 'Не указано'}</td>
                            <td>${title.en || 'Не указано'}</td>
                            <td><code class="bg-gray-100 px-2 py-1 rounded text-sm">${block.slug}</code></td>
                            <td>${toursCount} туров</td>
                            <td>${block.isActive ? '<span class="badge badge-success">Активен</span>' : '<span class="badge badge-warning">Неактивен</span>'}</td>
                            <td>${block.sortOrder}</td>
                            <td class="flex gap-2">
                                <button onclick="editTourBlock(${block.id})" class="text-blue-600 hover:text-blue-800" title="Редактировать">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="manageTourBlockTours(${block.id})" class="text-green-600 hover:text-green-800" title="Управлять турами">
                                    <i class="fas fa-list"></i>
                                </button>
                                <button onclick="deleteTourBlock(${block.id})" class="text-red-600 hover:text-red-800" title="Удалить">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            })
            .catch(err => {
                console.error('Error loading tour blocks:', err);
                const tbody = document.getElementById('tourBlocksTable');
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-red-500">Ошибка загрузки данных</td></tr>';
            });
        }

        // Global variables for modal handling
        let currentTourBlockId = null;

        // Open Tour Block Modal
        function openTourBlockModal(id = null) {
            currentTourBlockId = id;
            
            // Create modal HTML if it doesn't exist
            let modal = document.getElementById('tourBlockModal');
            if (!modal) {
                const modalHTML = `
                    <div id="tourBlockModal" class="modal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2 id="tourBlockModalTitle">Создать блок туров</h2>
                                <button onclick="closeTourBlockModal()" class="modal-close">&times;</button>
                            </div>
                            <div class="modal-body">
                                <form id="tourBlockForm">
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <div class="form-group">
                                            <label class="form-label">Название блока (RU)</label>
                                            <input type="text" class="form-input" id="blockTitleRu" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Название блока (EN)</label>
                                            <input type="text" class="form-input" id="blockTitleEn" required>
                                        </div>
                                        <div class="form-group lg:col-span-2">
                                            <label class="form-label">Описание блока (RU)</label>
                                            <textarea class="form-input" id="blockDescRu" rows="3"></textarea>
                                        </div>
                                        <div class="form-group lg:col-span-2">
                                            <label class="form-label">Описание блока (EN)</label>
                                            <textarea class="form-input" id="blockDescEn" rows="3"></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Слаг (URL)</label>
                                            <input type="text" class="form-input" id="blockSlug" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Порядок сортировки</label>
                                            <input type="number" class="form-input" id="blockSortOrder" value="0">
                                        </div>
                                        <div class="form-group lg:col-span-2">
                                            <label class="form-label flex items-center">
                                                <input type="checkbox" id="blockIsActive" class="mr-2" checked>
                                                Активный блок
                                            </label>
                                        </div>
                                    </div>
                                    <div class="mt-6 flex gap-2">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i>
                                            Сохранить
                                        </button>
                                        <button type="button" onclick="closeTourBlockModal()" class="btn btn-secondary">
                                            Отмена
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                modal = document.getElementById('tourBlockModal');
            }
            
            const title = document.getElementById('tourBlockModalTitle');
            
            if (id) {
                title.textContent = 'Редактировать блок туров';
                loadTourBlockData(id);
            } else {
                title.textContent = 'Создать блок туров';
                document.getElementById('tourBlockForm').reset();
                document.getElementById('blockIsActive').checked = true;
            }
            
            modal.classList.add('active');
        }

        // Close Tour Block Modal
        function closeTourBlockModal() {
            const modal = document.getElementById('tourBlockModal');
            if (modal) {
                modal.classList.remove('active');
            }
            currentTourBlockId = null;
        }

        // Load Tour Block Data for editing
        function loadTourBlockData(id) {
            fetch(`${getApiUrl()}/tour-blocks/${id}`, {
                headers: getAuthHeaders()
            })
            .then(res => res.json())
            .then(data => {
                if (data.success && data.data) {
                    const block = data.data;
                    const title = JSON.parse(block.title || '{}');
                    const description = JSON.parse(block.description || '{}');
                    
                    document.getElementById('blockTitleRu').value = title.ru || '';
                    document.getElementById('blockTitleEn').value = title.en || '';
                    document.getElementById('blockDescRu').value = description.ru || '';
                    document.getElementById('blockDescEn').value = description.en || '';
                    document.getElementById('blockSlug').value = block.slug || '';
                    document.getElementById('blockSortOrder').value = block.sortOrder || 0;
                    document.getElementById('blockIsActive').checked = block.isActive;
                }
            })
            .catch(err => {
                console.error('Error loading tour block:', err);
                alert('Ошибка загрузки блока');
            });
        }

        // Initialize form handlers when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Tour Block Form Handler
            setTimeout(() => {
                const form = document.getElementById('tourBlockForm');
                if (form) {
                    form.addEventListener('submit', function(e) {
                        e.preventDefault();
                        saveTourBlock();
                    });
                }
            }, 100);
        });

        // Save Tour Block
        function saveTourBlock() {
            const formData = {
                title: JSON.stringify({
                    ru: document.getElementById('blockTitleRu').value,
                    en: document.getElementById('blockTitleEn').value
                }),
                description: JSON.stringify({
                    ru: document.getElementById('blockDescRu').value,
                    en: document.getElementById('blockDescEn').value
                }),
                slug: document.getElementById('blockSlug').value,
                sortOrder: parseInt(document.getElementById('blockSortOrder').value) || 0,
                isActive: document.getElementById('blockIsActive').checked
            };
            
            const url = currentTourBlockId ? 
                `${getApiUrl()}/tour-blocks/${currentTourBlockId}` : 
                `${getApiUrl()}/tour-blocks`;
            const method = currentTourBlockId ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: getAuthHeaders(),
                body: JSON.stringify(formData)
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Блок туров успешно сохранен!');
                    closeTourBlockModal();
                    loadTourBlocks();
                } else {
                    alert('Ошибка при сохранении: ' + (data.message || 'Неизвестная ошибка'));
                }
            })
            .catch(err => {
                console.error('Error saving tour block:', err);
                alert('Ошибка соединения с сервером');
            });
        }

        // Edit Tour Block
        function editTourBlock(id) {
            openTourBlockModal(id);
        }

        // Delete Tour Block
        function deleteTourBlock(id) {
            if (confirm('Вы уверены, что хотите удалить этот блок туров? Все туры из блока останутся, но будут не привязаны к блоку.')) {
                fetch(`${getApiUrl()}/tour-blocks/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert('Блок туров удален');
                        loadTourBlocks();
                    } else {
                        alert('Ошибка при удалении: ' + (data.message || 'Неизвестная ошибка'));
                    }
                })
                .catch(err => {
                    console.error('Error deleting tour block:', err);
                    alert('Ошибка соединения с сервером');
                });
            }
        }

        // Manage Tour Block Tours
        function manageTourBlockTours(blockId) {
            alert('Функция управления турами в блоке скоро будет реализована');
        }

        // Load Enhanced Tour Form
        function loadEnhancedTourForm() {
            // Load tour blocks for selection
            fetch(`${getApiUrl()}/tour-blocks`, {
                headers: getAuthHeaders()
            })
            .then(res => res.json())
            .then(data => {
                const select = document.getElementById('eTourBlockId');
                if (select && data.success && data.data) {
                    select.innerHTML = '<option value="">Выберите блок туров</option>' +
                        data.data.map(block => {
                            const title = JSON.parse(block.title || '{}');
                            return `<option value="${block.id}">${title.ru || title.en || `Блок ${block.id}`}</option>`;
                        }).join('');
                }
            })
            .catch(err => console.error('Error loading tour blocks for form:', err));

            // Load categories for selection
            loadCategories().then(categories => {
                // Удалено: eTourCategoryId больше не существует
                // Удалено: логика заполнения eTourCategoryId
            });
        }

        // УДАЛЕНО: Enhanced Tour Form Handler - больше не нужен

        // УДАЛЕНО: function saveEnhancedTour() - заменена единой логикой
        // function saveEnhancedTour() {
        // УДАЛЕНО: Вся функция saveEnhancedTour() заменена единой логикой
        
        // ===== TOUR FUNCTIONALITY CLEANED =====
        // ПОЛНОСТЬЮ УДАЛЕНА ДУБЛИРОВАННАЯ ФУНКЦИЯ saveEnhancedTour()
        
        // ===== TRANSLATION FUNCTIONALITY =====
        
        // Show translations section
        function showTranslations() {
            showSection('translations');
            loadTranslationData();
        }

        // Load translation-related data
        function loadTranslationData() {
            loadTourSelectOptions();
            loadTranslationStatistics();
        }

        // Load tour options for translation dropdown
        function loadTourSelectOptions() {
            fetch(`${getApiUrl()}/tours`, {
                headers: getAuthHeaders()
            })
            .then(res => res.json())
            .then(data => {
                const select = document.getElementById('translationTourSelect');
                if (select && data.success && data.data) {
                    select.innerHTML = '<option value="">-- Выберите тур --</option>' +
                        data.data.map(tour => {
                            const title = JSON.parse(tour.title || '{}');
                            return `<option value="${tour.id}">${title.ru || title.en || `Тур ${tour.id}`}</option>`;
                        }).join('');
                }
            })
            .catch(err => console.error('Error loading tours for translation:', err));
        }

        // Load translation statistics
        function loadTranslationStatistics() {
            fetch(`${getApiUrl()}/tours`, {
                headers: getAuthHeaders()
            })
            .then(res => res.json())
            .then(data => {
                if (data.success && data.data) {
                    const tours = data.data;
                    let translatedCount = 0;
                    let pendingCount = 0;
                    
                    tours.forEach(tour => {
                        const title = JSON.parse(tour.title || '{}');
                        const description = JSON.parse(tour.description || '{}');
                        
                        // Check if all 6 languages are present
                        const supportedLanguages = ['ru', 'en', 'tj', 'fa', 'de', 'zh'];
                        const titleComplete = supportedLanguages.every(lang => title[lang] && title[lang].trim());
                        const descComplete = supportedLanguages.every(lang => description[lang] && description[lang].trim());
                        
                        if (titleComplete && descComplete) {
                            translatedCount++;
                        } else {
                            pendingCount++;
                        }
                    });
                    
                    document.getElementById('translatedToursCount').textContent = translatedCount;
                    document.getElementById('pendingTranslationsCount').textContent = pendingCount;
                }
            })
            .catch(err => console.error('Error loading translation statistics:', err));
        }

        // Single tour translation form handler
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const singleForm = document.getElementById('singleTranslationForm');
                if (singleForm) {
                    singleForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        translateSingleTour();
                    });
                }
                
                const manualForm = document.getElementById('manualTranslationForm');
                if (manualForm) {
                    manualForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        translateManualText();
                    });
                }
            }, 200);
        });

        // Translate single tour
        function translateSingleTour() {
            const tourId = document.getElementById('translationTourSelect').value;
            if (!tourId) {
                alert('Пожалуйста, выберите тур для перевода');
                return;
            }
            
            const btn = document.getElementById('translateSingleBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Переводится...';
            
            fetch(`${getApiUrl()}/translate/tour/${tourId}`, {
                method: 'POST',
                headers: getAuthHeaders()
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Тур успешно переведен на все языки!');
                    loadTranslationStatistics(); // Refresh stats
                } else {
                    alert('Ошибка перевода: ' + (data.error || 'Неизвестная ошибка'));
                }
            })
            .catch(err => {
                console.error('Translation error:', err);
                alert('Ошибка соединения с сервером');
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
        }

        // Batch translate all tours
        function batchTranslateAllTours() {
            if (!confirm('Это может занять несколько минут. Продолжить перевод всех туров?')) {
                return;
            }
            
            showTranslationProgress();
            
            fetch(`${getApiUrl()}/tours`, {
                headers: getAuthHeaders()
            })
            .then(res => res.json())
            .then(data => {
                if (data.success && data.data) {
                    const tourIds = data.data.map(tour => tour.id);
                    return batchTranslateTours(tourIds);
                } else {
                    throw new Error('Не удалось загрузить список туров');
                }
            })
            .catch(err => {
                console.error('Batch translation error:', err);
                alert('Ошибка: ' + err.message);
                hideTranslationProgress();
            });
        }

        // Batch translate selected tours
        function batchTranslateTours(tourIds) {
            return fetch(`${getApiUrl()}/translate/tours/batch`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({ tourIds })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    updateProgressBar(100);
                    document.getElementById('progressText').textContent = 
                        `Завершено! ${data.data.successCount} туров переведено успешно, ${data.data.errorCount} ошибок`;
                    
                    // Show results
                    const results = document.getElementById('translationResults');
                    results.innerHTML = `
                        <div class="text-green-600 font-medium">✅ Успешно переведено: ${data.data.successCount} туров</div>
                        ${data.data.errors.length > 0 ? 
                            `<div class="text-red-600 font-medium">❌ Ошибки: ${data.data.errors.join(', ')}</div>` : ''
                        }
                    `;
                    
                    loadTranslationStatistics(); // Refresh stats
                    
                    setTimeout(() => {
                        hideTranslationProgress();
                    }, 5000);
                } else {
                    throw new Error(data.error || 'Batch translation failed');
                }
            })
            .catch(err => {
                console.error('Batch translation error:', err);
                alert('Ошибка массового перевода: ' + err.message);
                hideTranslationProgress();
            });
        }

        // Manual text translation
        function translateManualText() {
            const sourceText = document.getElementById('sourceText').value;
            const sourceLanguage = document.getElementById('sourceLanguage').value;
            const targetLanguage = document.getElementById('targetLanguage').value;
            
            if (!sourceText.trim()) {
                alert('Пожалуйста, введите текст для перевода');
                return;
            }
            
            if (sourceLanguage === targetLanguage) {
                alert('Исходный и целевой языки должны отличаться');
                return;
            }
            
            const btn = document.getElementById('manualTranslateBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Переводится...';
            
            fetch(`${getApiUrl()}/translate/text`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    text: sourceText,
                    fromLanguage: sourceLanguage,
                    toLanguage: targetLanguage,
                    context: 'tour_description'
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('translatedText').value = data.data.translatedText;
                } else {
                    alert('Ошибка перевода: ' + (data.error || 'Неизвестная ошибка'));
                }
            })
            .catch(err => {
                console.error('Manual translation error:', err);
                alert('Ошибка соединения с сервером');
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
        }

        // Copy translation to clipboard
        function copyTranslation() {
            const text = document.getElementById('translatedText').value;
            if (!text) {
                alert('Нет текста для копирования');
                return;
            }
            
            navigator.clipboard.writeText(text).then(() => {
                alert('Перевод скопирован в буфер обмена!');
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('Не удалось скопировать текст');
            });
        }

        // Get selected checkbox values
        function getSelectedCheckboxValues(prefix) {
            const checkboxes = document.querySelectorAll(`input[id^="${prefix}"]`);
            const selected = [];
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selected.push(checkbox.value);
                }
            });
            return selected;
        }

        // Price Calculator Functions - Database-driven
        let priceCalculatorComponents = [];

        async function loadPriceCalculatorComponents() {
            try {
                const response = await fetch(`${getApiUrl()}/price-calculator`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    priceCalculatorComponents = data.data;
                    renderPriceCalculatorTable();
                } else {
                    console.error('Failed to load pricing components:', data.message);
                    alert('Ошибка загрузки компонентов цен');
                }
            } catch (error) {
                console.error('Error loading pricing components:', error);
                alert('Ошибка соединения с сервером при загрузке компонентов');
            }
        }

        function renderPriceCalculatorTable() {
            const tbody = document.getElementById('priceCalculatorTable');
            
            if (priceCalculatorComponents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="border border-gray-300 px-4 py-2 text-center text-gray-500">Нет компонентов для отображения</td></tr>';
                return;
            }

            tbody.innerHTML = priceCalculatorComponents.map(component => `
                <tr data-component-id="${component.id}">
                    <td class="border border-gray-300 px-4 py-2">${component.name}</td>
                    <td class="border border-gray-300 px-4 py-2">
                        <input type="number" class="form-input w-20" value="${component.price}" step="0.01" 
                               onchange="updateComponentPrice(${component.id}, this.value)">
                    </td>
                    <td class="border border-gray-300 px-4 py-2 text-center">${component.unit}</td>
                    <td class="border border-gray-300 px-4 py-2 text-center">
                        <button onclick="deleteComponent(${component.id})" class="text-red-500 hover:text-red-700" title="Удалить">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function updateComponentPrice(componentId, newPrice) {
            try {
                const response = await fetch(`${getApiUrl()}/price-calculator/${componentId}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        price: parseFloat(newPrice)
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    // Update local data
                    const component = priceCalculatorComponents.find(c => c.id === componentId);
                    if (component) {
                        component.price = parseFloat(newPrice);
                    }
                    console.log('✅ Component price updated successfully');
                } else {
                    console.error('Failed to update component price:', data.message);
                    alert('Ошибка обновления цены: ' + data.message);
                    loadPriceCalculatorComponents(); // Reload to reset
                }
            } catch (error) {
                console.error('Error updating component price:', error);
                alert('Ошибка соединения с сервером');
                loadPriceCalculatorComponents(); // Reload to reset
            }
        }

        function savePriceCalculator() {
            // All prices are already saved automatically when changed
            alert('✅ Все изменения автоматически сохранены в базе данных!');
        }

        function addNewPriceRow() {
            const service = prompt('Введите название услуги:');
            if (!service) return;
            
            const price = prompt('Введите цену (TJS):');
            if (!price || isNaN(parseFloat(price))) return;
            
            const unit = prompt('Введите единицу измерения:');
            if (!unit) return;

            const category = prompt('Введите категорию (transport, accommodation, meals, guides, tickets, transfer, documents):');
            if (!category) return;

            createNewComponent(service, parseFloat(price), unit, category);
        }

        async function createNewComponent(name, price, unit, category) {
            try {
                const response = await fetch(`${getApiUrl()}/price-calculator`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        key: `${category}_${Date.now()}`, // Generate unique key
                        category,
                        name,
                        price,
                        unit,
                        sortOrder: priceCalculatorComponents.filter(c => c.category === category).length + 1
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    console.log('✅ New component created successfully');
                    loadPriceCalculatorComponents(); // Reload table
                } else {
                    console.error('Failed to create component:', data.message);
                    alert('Ошибка создания компонента: ' + data.message);
                }
            } catch (error) {
                console.error('Error creating component:', error);
                alert('Ошибка соединения с сервером');
            }
        }

        async function deleteComponent(componentId) {
            if (!confirm('Удалить этот компонент цены?')) return;
            
            try {
                const response = await fetch(`${getApiUrl()}/price-calculator/${componentId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                const data = await response.json();
                if (data.success) {
                    console.log('✅ Component deleted successfully');
                    loadPriceCalculatorComponents(); // Reload table
                } else {
                    console.error('Failed to delete component:', data.message);
                    alert('Ошибка удаления компонента: ' + data.message);
                }
            } catch (error) {
                console.error('Error deleting component:', error);
                alert('Ошибка соединения с сервером');
            }
        }

        async function resetPrices() {
            if (confirm('Сбросить все цены к стандартным значениям? Это удалит все текущие компоненты и создаст стандартные.')) {
                try {
                    // Delete all existing components first
                    for (const component of priceCalculatorComponents) {
                        await fetch(`${getApiUrl()}/price-calculator/${component.id}`, {
                            method: 'DELETE',
                            headers: getAuthHeaders()
                        });
                    }
                    
                    // Initialize defaults
                    const response = await fetch(`${getApiUrl()}/price-calculator/initialize`, {
                        method: 'POST',
                        headers: getAuthHeaders()
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        console.log('✅ Default components initialized');
                        loadPriceCalculatorComponents(); // Reload table
                        alert('Стандартные цены восстановлены!');
                    } else {
                        console.error('Failed to initialize defaults:', data.message);
                        alert('Ошибка восстановления стандартных цен');
                    }
                } catch (error) {
                    console.error('Error resetting prices:', error);
                    alert('Ошибка соединения с сервером');
                }
            }
        }

        // Banner Management Functions
        async function loadCurrentSlides() {
            try {
                const response = await fetch(`${getApiUrl()}/slides/admin`, {
                    headers: getAuthHeaders()
                });
                const result = await response.json();
                
                if (result.success) {
                    displayCurrentSlides(result.data);
                } else {
                    console.error('Failed to load slides:', result.message);
                }
            } catch (error) {
                console.error('Error loading slides:', error);
            }
        }

        function displayCurrentSlides(slides) {
            const container = document.getElementById('currentSlides');
            if (!container) return;

            container.innerHTML = slides.map(slide => {
                const title = JSON.parse(slide.title || '{}');
                const description = JSON.parse(slide.description || '{}');
                const buttonText = JSON.parse(slide.buttonText || '{}');
                
                return `
                    <div class="border rounded-lg p-4 bg-white">
                        ${slide.image ? `<img src="${slide.image}" alt="Slide" class="w-full h-32 object-cover rounded mb-2" onerror="this.style.display='none'">` : ''}
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-medium">${title.ru || title.en || 'Без названия'}</h4>
                                <p class="text-sm text-gray-600">${(description.ru || description.en || '').substring(0, 80)}${(description.ru || description.en || '').length > 80 ? '...' : ''}</p>
                            </div>
                            <span class="px-2 py-1 text-xs rounded ${slide.isActive ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600'}">
                                ${slide.isActive ? 'Активен' : 'Неактивен'}
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-500">Порядок: ${slide.order}</span>
                            <div class="flex gap-2">
                                <button class="btn btn-sm btn-danger" onclick="deleteSlide(${slide.id})">Удалить</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('') || '<p class="text-gray-500">Нет слайдов</p>';
        }

        function editSlide(id) {
            alert('Функция редактирования слайда будет реализована');
        }

        async function deleteSlide(id) {
            if (!confirm('Удалить этот слайд?')) return;

            try {
                const response = await fetch(`${getApiUrl()}/slides/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('Слайд удален');
                    loadCurrentSlides();
                } else {
                    alert('Ошибка при удалении слайда');
                }
            } catch (error) {
                console.error('Error deleting slide:', error);
                alert('Ошибка при удалении слайда');
            }
        }

        // Banner form submission
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const bannerForm = document.getElementById('bannerForm');
                if (bannerForm) {
                    bannerForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        saveBannerSlide();
                    });
                }
            }, 100);
        });

        async function saveBannerSlide() {
            const slideData = {
                title: {
                    ru: document.getElementById('bannerTitleRu').value,
                    en: document.getElementById('bannerTitleEn').value
                },
                description: {
                    ru: document.getElementById('bannerDescRu').value,
                    en: document.getElementById('bannerDescEn').value
                },
                image: document.getElementById('bannerImage').value || '',
                link: document.getElementById('bannerLink').value || '',
                buttonText: {
                    ru: document.getElementById('bannerButtonTextRu').value || '',
                    en: document.getElementById('bannerButtonTextEn').value || ''
                },
                order: parseInt(document.getElementById('bannerOrder').value) || 1,
                isActive: document.getElementById('bannerActive').checked
            };

            try {
                const response = await fetch(`${getApiUrl()}/slides`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(slideData)
                });

                const result = await response.json();
                
                if (result.success) {
                    alert('Слайд успешно создан!');
                    loadCurrentSlides();
                    document.getElementById('bannerForm').reset();
                } else {
                    alert('Ошибка при создании слайда: ' + result.message);
                }
            } catch (error) {
                console.error('Error creating slide:', error);
                alert('Ошибка при создании слайда');
            }
        }

        // Show batch translation modal (placeholder)
        function showBatchTranslationModal() {
            alert('Функция выборочного перевода туров будет реализована в следующей версии');
        }

        // Show/hide translation progress
        function showTranslationProgress() {
            document.getElementById('translationProgress').style.display = 'block';
            updateProgressBar(0);
            document.getElementById('progressText').textContent = 'Подготовка к переводу...';
            document.getElementById('translationResults').innerHTML = '';
        }

        function hideTranslationProgress() {
            document.getElementById('translationProgress').style.display = 'none';
        }

        function updateProgressBar(percent) {
            document.getElementById('progressBar').style.width = percent + '%';
        }

        // Global error handlers
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            // Prevent the default error logging
            event.preventDefault();
        });
        
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
        });

        
        // Category selection functions
        const categoryMapping = {
            'Однодневные туры': 1,
            'Многодневные туры': 2,
            'Экскурсии': 3,
            'Городские туры': 4,
            'Природа/экологические туры': 5,
            'Культурно познавательные туры': 6,
            'Исторические туры': 7,
            'Походы/трекинги': 8,
            'Горные ландшафты': 9,
            'Озерные ландшафты': 10,
            'Приключенческие туры': 11,
            'Гастрономические туры': 12,
            'Автотуры/сафари/джип-туры': 13,
            'Агротуры': 14,
            'VIP туры': 15
        };

        function selectCategory(categoryNameRu, categoryNameEn) {
            const categoryId = categoryMapping[categoryNameRu];
            if (categoryId) {
                // Set the category ID in the hidden field
                document.getElementById('tourCategory').value = categoryId;
                
                // Update the category selection display
                const categoryButton = document.querySelector('[onclick="showCategoryListModal()"]');
                if (categoryButton) {
                    const textElement = categoryButton.querySelector('.text-gray-600');
                    if (textElement) {
                        textElement.textContent = categoryNameRu;
                        textElement.classList.remove('text-gray-600');
                        textElement.classList.add('text-blue-600');
                    }
                }
                
                // Close the modal
                closeCategoryListModal();
            } else {
                console.error('Category ID not found for:', categoryNameRu);
                alert('Ошибка: категория не найдена');
            }
        }

        function showCategoryListModal() {
            document.getElementById('categoryListModal').classList.add('active');
        }

        function closeCategoryListModal() {
            document.getElementById('categoryListModal').classList.remove('active');
        }

        // Check authentication on page load
        function checkAuthOnLoad() {
            const token = localStorage.getItem('authToken');
            if (token) {
                // Verify token with backend before showing dashboard
                fetch(`${getApiUrl()}/admin/verify-token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Token is valid, show dashboard
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('adminDashboard').style.display = 'block';
                        showSection('dashboard');
                        loadDashboard();
                    } else {
                        // Token is invalid, show login
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('user');
                        document.getElementById('loginScreen').style.display = 'flex';
                        document.getElementById('adminDashboard').style.display = 'none';
                    }
                })
                .catch(err => {
                    console.error('Token verification failed:', err);
                    // On error, show login
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('user');
                    document.getElementById('loginScreen').style.display = 'flex';
                    document.getElementById('adminDashboard').style.display = 'none';
                });
            } else {
                // Show login screen
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('adminDashboard').style.display = 'none';
            }
        }

        // Navigation handling
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication first
            checkAuthOnLoad();
            
            // Add click handlers for all navigation items
            const navItems = document.querySelectorAll('.nav-item[data-section]');
            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.getAttribute('data-section');
                    showSection(section);
                    
                    // Update active state
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        });

        // Tour Pricing Components Functions
        let tourPricingComponents = [];
        let selectedTourComponents = [];

        async function loadTourPricingComponents() {
            try {
                const response = await fetch(`${getApiUrl()}/price-calculator`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (data.success) {
                    tourPricingComponents = data.data;
                    renderTourPricingComponents();
                } else {
                    console.error('Failed to load tour pricing components:', data.message);
                    document.getElementById('tourPricingComponents').innerHTML = 
                        '<div class="text-center text-red-500 py-4">Ошибка загрузки компонентов цен</div>';
                }
            } catch (error) {
                console.error('Error loading tour pricing components:', error);
                document.getElementById('tourPricingComponents').innerHTML = 
                    '<div class="text-center text-red-500 py-4">Ошибка соединения с сервером</div>';
            }
        }

        function renderTourPricingComponents() {
            const container = document.getElementById('tourPricingComponents');
            
            if (tourPricingComponents.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">Нет доступных компонентов</div>';
                return;
            }

            // Group components by category
            const categories = {
                transport: { name: 'Транспорт', items: [] },
                accommodation: { name: 'Проживание', items: [] },
                meals: { name: 'Питание', items: [] },
                guides: { name: 'Сопровождение', items: [] },
                tickets: { name: 'Билеты и сборы', items: [] },
                transfer: { name: 'Трансфер', items: [] },
                documents: { name: 'Документы и разрешения', items: [] }
            };

            tourPricingComponents.forEach(component => {
                if (categories[component.category]) {
                    categories[component.category].items.push(component);
                }
            });

            container.innerHTML = Object.keys(categories).map(categoryKey => {
                const category = categories[categoryKey];
                if (category.items.length === 0) return '';
                
                return `
                    <div class="mb-6">
                        <h4 class="font-semibold text-gray-700 mb-3 border-b pb-2">${category.name}</h4>
                        <div class="space-y-2">
                            ${category.items.map(component => `
                                <div class="flex items-center gap-3 p-3 bg-white rounded border">
                                    <input type="checkbox" id="component_${component.id}" 
                                           onchange="toggleTourComponent(${component.id}, this.checked)"
                                           class="w-4 h-4 text-blue-600">
                                    <label for="component_${component.id}" class="flex-1 cursor-pointer font-medium">
                                        ${component.name}
                                    </label>
                                    <div class="flex items-center gap-2">
                                        <span class="text-sm text-gray-600">TJS</span>
                                        <input type="number" min="0" step="0.01" value="${component.price}" 
                                               class="w-20 px-2 py-1 border rounded text-center"
                                               id="price_${component.id}"
                                               onchange="updateComponentPrice(${component.id}, this.value)"
                                               disabled>
                                        <span class="text-sm text-gray-500">/ ${component.unit}</span>
                                    </div>
                                    <div class="flex items-center gap-2" id="quantity_container_${component.id}" style="display: none;">
                                        <span class="text-sm">Кол-во:</span>
                                        <input type="number" min="1" value="1" 
                                               class="w-16 px-2 py-1 border rounded text-center"
                                               id="quantity_${component.id}"
                                               onchange="updateComponentQuantity(${component.id}, this.value)">
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).filter(html => html).join('');
        }


        function toggleTourComponent(componentId, isChecked) {
            const quantityContainer = document.getElementById(`quantity_container_${componentId}`);
            const priceInput = document.getElementById(`price_${componentId}`);
            
            if (isChecked) {
                quantityContainer.style.display = 'flex';
                priceInput.disabled = false; // Enable price editing when selected
                
                const component = tourPricingComponents.find(c => c.id === componentId);
                if (component) {
                    selectedTourComponents.push({
                        id: componentId,
                        key: component.key,
                        name: component.name,
                        price: parseFloat(priceInput.value) || component.price,
                        unit: component.unit,
                        quantity: 1
                    });
                }
            } else {
                quantityContainer.style.display = 'none';
                priceInput.disabled = true; // Disable price editing when unselected
                priceInput.value = tourPricingComponents.find(c => c.id === componentId)?.price || 0; // Reset to original price
                selectedTourComponents = selectedTourComponents.filter(c => c.id !== componentId);
            }
            
            calculateTourTotalPrice();
        }

        function updateComponentPrice(componentId, newPrice) {
            const component = selectedTourComponents.find(c => c.id === componentId);
            if (component) {
                component.price = parseFloat(newPrice) || 0;
                calculateTourTotalPrice();
                console.log(`Updated price for ${component.name}: ${newPrice} TJS`);
            }
        }

        function updateComponentQuantity(componentId, quantity) {
            const component = selectedTourComponents.find(c => c.id === componentId);
            if (component) {
                component.quantity = parseInt(quantity) || 1;
                calculateTourTotalPrice();
            }
        }

        function calculateTourTotalPrice() {
            let totalPrice = 0;
            
            selectedTourComponents.forEach(component => {
                totalPrice += component.price * component.quantity;
            });
            
            // Update display
            document.getElementById('calculatedTotalPrice').textContent = `${totalPrice.toFixed(2)} TJS`;
            // Update hidden field for form submission
            document.getElementById('tourPrice').value = totalPrice.toFixed(2);
            // Save selected components data
            document.getElementById('tourPricingData').value = JSON.stringify(selectedTourComponents);
        }

        function loadTourPricingComponentsForEdit(savedComponents) {
            console.log('📋 Loading pricing components for editing:', savedComponents);
            
            // Clear current selections
            selectedTourComponents = [];
            
            // Reset all checkboxes and disable price inputs
            document.querySelectorAll('#tourPricingComponents input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.querySelectorAll('[id^="quantity_container_"]').forEach(container => {
                container.style.display = 'none';
            });
            document.querySelectorAll('[id^="price_"]').forEach(priceInput => {
                priceInput.disabled = true;
            });
            
            if (!savedComponents || savedComponents.length === 0) {
                console.log('No saved pricing components to load');
                return;
            }
            
            // Populate saved selections
            savedComponents.forEach(savedComponent => {
                const componentId = savedComponent.id;
                const quantity = savedComponent.quantity || 1;
                const price = savedComponent.price;
                
                // Find checkbox and check it
                const checkbox = document.getElementById(`component_${componentId}`);
                if (checkbox) {
                    checkbox.checked = true;
                    
                    // Show quantity container and enable price input
                    const quantityContainer = document.getElementById(`quantity_container_${componentId}`);
                    if (quantityContainer) {
                        quantityContainer.style.display = 'flex';
                    }
                    
                    const priceInput = document.getElementById(`price_${componentId}`);
                    if (priceInput) {
                        priceInput.disabled = false;
                        priceInput.value = price; // Set saved custom price
                    }
                    
                    // Set quantity
                    const quantityInput = document.getElementById(`quantity_${componentId}`);
                    if (quantityInput) {
                        quantityInput.value = quantity;
                    }
                    
                    // Add to selected components
                    selectedTourComponents.push({
                        id: componentId,
                        key: savedComponent.key,
                        name: savedComponent.name,
                        price: price,
                        unit: savedComponent.unit,
                        quantity: quantity
                    });
                    
                    console.log(`✅ Restored component: ${savedComponent.name} (price: ${price}, qty: ${quantity})`);
                }
            });
            
            // Recalculate total price
            calculateTourTotalPrice();
            console.log('✅ Pricing components loaded and calculated for editing');
        }

        // Show section function
        function showSection(sectionName) {
            // Hide all sections
            const sections = ['dashboardSection', 'toursSection', 'priceCalculatorSection', 'bannerManagementSection', 'bookingsSection', 'hotelsSection', 'guidesSection', 'reviewsSection', 'cmsSection', 'translationSection', 'settingsSection'];
            sections.forEach(sectionId => {
                const element = document.getElementById(sectionId);
                if (element) element.style.display = 'none';
            });

            // Show selected section - map section names to section IDs
            let sectionId;
            switch(sectionName) {
                case 'price-calculator':
                    sectionId = 'priceCalculatorSection';
                    loadPriceCalculatorComponents(); // Load pricing components from database
                    break;
                case 'tours':
                    sectionId = 'toursSection';
                    loadTourPricingComponents(); // Load pricing components for tour form
                    break;
                case 'banner-management':
                    sectionId = 'bannerManagementSection';
                    break;
                default:
                    sectionId = sectionName + 'Section';
            }
            
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.style.display = 'block';
            }

            // Load section-specific data
            switch(sectionName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'tours':
                    loadTours();
                    break;
                case 'price-calculator':
                    loadPriceCalculator();
                    break;
                case 'banner-management':
                    loadBannerManagement();
                    break;
                case 'bookings':
                    loadBookings();
                    break;
                case 'hotels':
                    loadHotels();
                    break;
                case 'guides':
                    loadGuides();
                    break;
                case 'reviews':
                    loadReviews();
                    break;
                case 'cms':
                    switchCMSTab('blocks');
                    break;
                case 'translations':
                    showTranslations();
                    break;
                case 'exchange-rates':
                    loadExchangeRates();
                    break;
                case 'settings':
                    // Load settings if needed
                    break;
            }
        }

        // Load functions for new sections
        function loadPriceCalculator() {
            // Load saved prices from localStorage if available
            const savedPrices = localStorage.getItem('priceCalculatorData');
            if (savedPrices) {
                try {
                    const prices = JSON.parse(savedPrices);
                    // Update table with saved prices
                    console.log('Loaded saved prices:', prices);
                } catch (e) {
                    console.error('Error loading saved prices:', e);
                }
            }
        }

        function loadBannerManagement() {
            loadCurrentSlides();
        }

        // Exchange Rates Functions
        async function loadExchangeRates() {
            try {
                const response = await fetch(`${getApiUrl()}/exchange-rates`);
                const data = await response.json();
                
                if (data.success) {
                    displayExchangeRates(data.data);
                } else {
                    console.error('Error loading exchange rates:', data.message);
                }
            } catch (error) {
                console.error('Error loading exchange rates:', error);
                showErrorMessage('Ошибка при загрузке курсов валют');
            }
        }

        function displayExchangeRates(rates) {
            const tbody = document.getElementById('exchangeRatesTableBody');
            
            if (!rates || rates.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500">
                            Курсы валют не найдены
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = rates.map(rate => `
                <tr>
                    <td>
                        <span class="font-semibold">${rate.currency}</span>
                    </td>
                    <td>${rate.name}</td>
                    <td>
                        <span class="bg-gray-100 px-2 py-1 rounded text-sm">${rate.symbol}</span>
                    </td>
                    <td>
                        <span class="font-mono">${rate.rate}</span>
                        ${rate.currency === 'TJS' ? '<small class="text-gray-500 block">Базовая валюта</small>' : ''}
                    </td>
                    <td>
                        <span class="text-sm text-gray-600">
                            ${new Date(rate.updatedAt).toLocaleDateString('ru-RU', { 
                                year: 'numeric', 
                                month: 'short', 
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}
                        </span>
                    </td>
                    <td>
                        ${rate.currency !== 'TJS' ? `
                            <button onclick="editExchangeRate('${rate.currency}')" class="btn btn-sm btn-primary">
                                <i class="fas fa-edit"></i>
                                Редактировать
                            </button>
                        ` : '<span class="text-gray-400 text-sm">Базовая</span>'}
                    </td>
                </tr>
            `).join('');
        }

        function editExchangeRate(currency) {
            fetch(`${getApiUrl()}/exchange-rates`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const rate = data.data.find(r => r.currency === currency);
                        if (rate) {
                            document.getElementById('editCurrency').value = rate.currency;
                            document.getElementById('editCurrencyCode').value = rate.currency;
                            document.getElementById('editCurrencyName').value = rate.name;
                            document.getElementById('editCurrencySymbol').value = rate.symbol;
                            document.getElementById('editCurrencyRate').value = rate.rate;
                            
                            document.getElementById('exchangeRateModal').classList.add('active');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading exchange rate:', error);
                    showErrorMessage('Ошибка при загрузке курса валюты');
                });
        }

        function closeExchangeRateModal() {
            document.getElementById('exchangeRateModal').classList.remove('active');
            document.getElementById('exchangeRateForm').reset();
        }

        async function calculateCurrency() {
            const amount = document.getElementById('calcAmount').value;
            const targetCurrency = document.getElementById('calcTargetCurrency').value;
            
            if (!amount || amount <= 0) {
                showErrorMessage('Введите корректную сумму');
                return;
            }
            
            try {
                const response = await fetch(`${getApiUrl()}/exchange-rates/convert?amount=${amount}&targetCurrency=${targetCurrency}`);
                const data = await response.json();
                
                if (data.success) {
                    const result = document.getElementById('calcResult');
                    result.textContent = `${data.data.symbol}${data.data.convertedAmount}`;
                } else {
                    showErrorMessage('Ошибка при конвертации');
                }
            } catch (error) {
                console.error('Error calculating currency:', error);
                showErrorMessage('Ошибка при конвертации валюты');
            }
        }

        // Exchange Rate Form Handler
        document.getElementById('exchangeRateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const currency = document.getElementById('editCurrency').value;
            const rate = parseFloat(document.getElementById('editCurrencyRate').value);
            const symbol = document.getElementById('editCurrencySymbol').value;
            const name = document.getElementById('editCurrencyName').value;
            
            try {
                const response = await fetch(`${getApiUrl()}/exchange-rates/${currency}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ rate, symbol, name })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccessMessage('Курс валюты обновлен');
                    closeExchangeRateModal();
                    loadExchangeRates();
                } else {
                    showErrorMessage(data.message || 'Ошибка при обновлении курса валюты');
                }
            } catch (error) {
                console.error('Error updating exchange rate:', error);
                showErrorMessage('Ошибка при обновлении курса валюты');
            }
        });
    </script>
</body>
</html>