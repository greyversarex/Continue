<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="review.page_title">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ - Bunyod Tour</title>
    <!-- üåê –¶–ï–ù–¢–†–ê–õ–¨–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –ò–ù–¢–ï–†–ù–ê–¶–ò–û–ù–ê–õ–ò–ó–ê–¶–ò–ò -->
    <script src="/public/js/i18n.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .star-rating {
            font-size: 2rem;
            color: #d1d5db;
            cursor: pointer;
        }
        .star-rating.active {
            color: #fbbf24;
        }
        .star-rating:hover {
            color: #fbbf24;
        }
        .preview-image {
            max-width: 150px;
            max-height: 150px;
            object-fit: cover;
            border-radius: 8px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <a href="/" class="flex items-center space-x-3">
                    <img src="/attached_assets/Logo-Ru_1754635713718.png" alt="Bunyod Tour" class="h-10">
                    <span class="text-xl font-bold text-gray-800">Bunyod Tour</span>
                </a>
                <a href="/" class="text-blue-600 hover:text-blue-800">
                    <i class="fas fa-arrow-left mr-2"></i>
                    <span data-translate="review.back_to_home">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</span>
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <div class="max-w-2xl mx-auto">
            <!-- Tour Info -->
            <div id="tour-info" class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h1 class="text-2xl font-bold text-gray-800 mb-4" data-translate="review.leave_review_title">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ –æ —Ç—É—Ä–µ</h1>
                <div id="tour-details" class="text-gray-600">
                    <span data-translate="review.loading_tour_info">–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç—É—Ä–µ...</span>
                </div>
            </div>

            <!-- Review Form -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <form id="review-form" class="space-y-6">
                    <!-- Name -->
                    <div>
                        <label for="reviewerName" class="block text-sm font-medium text-gray-700 mb-2" data-translate="review.your_name">
                            –í–∞—à–µ –∏–º—è *
                        </label>
                        <input type="text" id="reviewerName" name="reviewerName" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                               data-translate-placeholder="review.enter_name" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è">
                    </div>

                    <!-- Rating -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="review.rating">
                            –û—Ü–µ–Ω–∫–∞ *
                        </label>
                        <div class="flex space-x-1">
                            <span class="star-rating" data-rating="1">‚òÖ</span>
                            <span class="star-rating" data-rating="2">‚òÖ</span>
                            <span class="star-rating" data-rating="3">‚òÖ</span>
                            <span class="star-rating" data-rating="4">‚òÖ</span>
                            <span class="star-rating" data-rating="5">‚òÖ</span>
                        </div>
                        <input type="hidden" id="rating" name="rating" required>
                        <p class="text-sm text-gray-500 mt-1" data-translate="review.click_stars">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∑–≤—ë–∑–¥—ã –¥–ª—è –æ—Ü–µ–Ω–∫–∏</p>
                    </div>

                    <!-- Review Text -->
                    <div>
                        <label for="text" class="block text-sm font-medium text-gray-700 mb-2" data-translate="review.your_review">
                            –í–∞—à –æ—Ç–∑—ã–≤ *
                        </label>
                        <textarea id="text" name="text" rows="6" required
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  data-translate-placeholder="review.share_impressions" placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è–º–∏ –æ —Ç—É—Ä–µ..."></textarea>
                    </div>

                    <!-- Photo Upload -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2" data-translate="review.photos_optional">
                            –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
                        </label>
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <input type="file" id="photos" multiple accept="image/*" class="hidden">
                            <button type="button" id="upload-btn" 
                                    class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
                                <i class="fas fa-camera mr-2"></i>
                                <span data-translate="review.choose_photos">–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</span>
                            </button>
                            <p class="text-sm text-gray-500 mt-2" data-translate="review.photo_limits">–ú–∞–∫—Å–∏–º—É–º 5 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏, –¥–æ 5MB –∫–∞–∂–¥–∞—è</p>
                        </div>
                        
                        <!-- Photo Preview -->
                        <div id="photo-preview" class="mt-4 grid grid-cols-3 gap-4 hidden">
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="pt-4">
                        <button type="submit" id="submit-btn"
                                class="w-full bg-green-600 text-white py-3 px-4 rounded-md hover:bg-green-700 font-medium">
                            <i class="fas fa-paper-plane mr-2"></i>
                            <span data-translate="review.submit_review">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</span>
                        </button>
                        <p class="text-sm text-gray-500 text-center mt-2" data-translate="review.moderation_notice">
                            –û—Ç–∑—ã–≤ –±—É–¥–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –ø–æ—Å–ª–µ –º–æ–¥–µ—Ä–∞—Ü–∏–∏
                        </p>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md mx-4">
            <div class="text-center">
                <div class="text-green-500 text-5xl mb-4">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2" data-translate="review.thank_you">–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ç–∑—ã–≤!</h3>
                <p class="text-gray-600 mb-6" data-translate="review.success_message">
                    –í–∞—à –æ—Ç–∑—ã–≤ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∏ –±—É–¥–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –ø–æ—Å–ª–µ –º–æ–¥–µ—Ä–∞—Ü–∏–∏.
                </p>
                <button onclick="window.location.href='/'" 
                        class="bg-blue-500 text-white px-6 py-2 rounded-md hover:bg-blue-600">
                    <span data-translate="review.back_to_home">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        let selectedRating = 0;
        let uploadedPhotos = [];
        let tourId = null;

        // –ü–æ–ª—É—á–∞–µ–º ID —Ç—É—Ä–∞ –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        tourId = urlParams.get('tourId');

        if (!tourId) {
            document.getElementById('tour-details').innerHTML = 
                '<p class="text-red-600">–û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω ID —Ç—É—Ä–∞</p>';
        } else {
            loadTourInfo();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç—É—Ä–µ
        async function loadTourInfo() {
            try {
                const response = await fetch(`/api/tours/${tourId}`);
                const data = await response.json();
                
                if (data.success) {
                    const tour = data.data;
                    document.getElementById('tour-details').innerHTML = `
                        <h2 class="text-xl font-semibold">${tour.title.ru}</h2>
                        <p class="text-gray-600 mt-2">${tour.description.ru.substring(0, 200)}...</p>
                        <div class="mt-3 text-sm">
                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">
                                ${tour.duration}
                            </span>
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded ml-2">
                                ${tour.price} ${tour.priceType}
                            </span>
                        </div>
                    `;
                } else {
                    document.getElementById('tour-details').innerHTML = 
                        '<p class="text-red-600">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç—É—Ä–µ</p>';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                document.getElementById('tour-details').innerHTML = 
                    '<p class="text-red-600">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç—É—Ä–µ</p>';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞
        document.querySelectorAll('.star-rating').forEach(star => {
            star.addEventListener('click', function() {
                selectedRating = parseInt(this.dataset.rating);
                document.getElementById('rating').value = selectedRating;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                document.querySelectorAll('.star-rating').forEach((s, index) => {
                    if (index < selectedRating) {
                        s.classList.add('active');
                    } else {
                        s.classList.remove('active');
                    }
                });
            });
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
        document.getElementById('upload-btn').addEventListener('click', function() {
            document.getElementById('photos').click();
        });

        document.getElementById('photos').addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            if (files.length > 5) {
                alert('–ú–∞–∫—Å–∏–º—É–º 5 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π');
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const uploadBtn = document.getElementById('upload-btn');
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>–ó–∞–≥—Ä—É–∑–∫–∞...';
            uploadBtn.disabled = true;

            try {
                const formData = new FormData();
                files.forEach(file => {
                    formData.append('photos', file);
                });

                const response = await fetch('/api/reviews/upload-photos', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    uploadedPhotos = data.data.photos;
                    showPhotoPreview(files, uploadedPhotos);
                } else {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + data.message);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π');
            } finally {
                uploadBtn.innerHTML = '<i class="fas fa-camera mr-2"></i>–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏';
                uploadBtn.disabled = false;
            }
        });

        // –ü–æ–∫–∞–∑ –ø—Ä–µ–≤—å—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
        function showPhotoPreview(files, urls) {
            const preview = document.getElementById('photo-preview');
            preview.innerHTML = '';
            
            files.forEach((file, index) => {
                const div = document.createElement('div');
                div.className = 'relative';
                
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.className = 'preview-image w-full h-32 object-cover rounded-lg';
                
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600';
                removeBtn.innerHTML = '√ó';
                removeBtn.onclick = () => removePhoto(index);
                
                div.appendChild(img);
                div.appendChild(removeBtn);
                preview.appendChild(div);
            });
            
            preview.classList.remove('hidden');
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
        function removePhoto(index) {
            uploadedPhotos.splice(index, 1);
            
            if (uploadedPhotos.length === 0) {
                document.getElementById('photo-preview').classList.add('hidden');
                document.getElementById('photos').value = '';
            } else {
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é
                const files = Array.from(document.getElementById('photos').files);
                files.splice(index, 1);
                showPhotoPreview(files, uploadedPhotos);
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
        document.getElementById('review-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!tourId) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω ID —Ç—É—Ä–∞');
                return;
            }

            if (selectedRating === 0) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ü–µ–Ω–∫—É');
                return;
            }

            const submitBtn = document.getElementById('submit-btn');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>–û—Ç–ø—Ä–∞–≤–∫–∞...';
            submitBtn.disabled = true;

            try {
                const formData = {
                    tourId: parseInt(tourId),
                    reviewerName: document.getElementById('reviewerName').value,
                    rating: selectedRating,
                    text: document.getElementById('text').value,
                    photos: uploadedPhotos
                };

                const response = await fetch('/api/reviews', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('success-modal').classList.remove('hidden');
                    document.getElementById('success-modal').classList.add('flex');
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.message);
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤';
                    submitBtn.disabled = false;
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–∑—ã–≤–∞');
                submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤';
                submitBtn.disabled = false;
            }
        });
    </script>
</body>
</html>