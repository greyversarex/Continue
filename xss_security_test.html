<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ XSS –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .pass { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .fail { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .test-input { background-color: #f8f9fa; padding: 5px; font-family: monospace; }
        .test-output { background-color: #e9ecef; padding: 5px; font-family: monospace; }
    </style>
</head>
<body>
    <h1>üîí –¢–µ—Å—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ XSS –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π</h1>
    <p>–≠—Ç–æ—Ç —Ç–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è XSS —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.</p>

    <!-- –ó–∞–≥—Ä—É–∂–∞–µ–º i18n.js -->
    <script src="/public/js/i18n.js"></script>

    <div id="test-results"></div>

    <script>
        // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º
        const maliciousInputs = [
            '<script>alert("XSS")</script>',
            '<img src="x" onerror="alert(\'XSS\')">',
            '"><script>alert("XSS")</script>',
            '&lt;script&gt;alert("XSS")&lt;/script&gt;',
            '<svg onload="alert(1)">',
            'javascript:alert("XSS")',
            '&amp;&lt;&gt;"\'',
            '<div onclick="alert(1)">Click me</div>'
        ];

        const testResults = [];

        function runTests() {
            const resultsDiv = document.getElementById('test-results');
            
            // –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏ escapeHTML
            testResults.push('<h2>üìã –¢–µ—Å—Ç 1: –§—É–Ω–∫—Ü–∏—è escapeHTML</h2>');
            
            maliciousInputs.forEach((input, index) => {
                try {
                    const escaped = escapeHTML(input);
                    const isSafe = !escaped.includes('<script') && 
                                   !escaped.includes('onerror=') && 
                                   !escaped.includes('onclick=') &&
                                   !escaped.includes('onload=') &&
                                   !escaped.includes('javascript:');
                    
                    testResults.push(`
                        <div class="test-result ${isSafe ? 'pass' : 'fail'}">
                            <strong>–¢–µ—Å—Ç 1.${index + 1}: ${isSafe ? '‚úÖ –ü–†–û–ô–î–ï–ù' : '‚ùå –ù–ï –ü–†–û–ô–î–ï–ù'}</strong>
                            <br>–í—Ö–æ–¥: <span class="test-input">${input}</span>
                            <br>–í—ã—Ö–æ–¥: <span class="test-output">${escaped}</span>
                        </div>
                    `);
                } catch (error) {
                    testResults.push(`
                        <div class="test-result fail">
                            <strong>–¢–µ—Å—Ç 1.${index + 1}: ‚ùå –û–®–ò–ë–ö–ê</strong>
                            <br>–í—Ö–æ–¥: <span class="test-input">${input}</span>
                            <br>–û—à–∏–±–∫–∞: ${error.message}
                        </div>
                    `);
                }
            });

            // –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏ escapeDataAttribute
            testResults.push('<h2>üìã –¢–µ—Å—Ç 2: –§—É–Ω–∫—Ü–∏—è escapeDataAttribute</h2>');
            
            maliciousInputs.forEach((input, index) => {
                try {
                    const escaped = escapeDataAttribute(input);
                    const isSafe = !escaped.includes('"') && 
                                   !escaped.includes('<') && 
                                   !escaped.includes('>') &&
                                   escaped.includes('&quot;') === (input.includes('"'));
                    
                    testResults.push(`
                        <div class="test-result ${isSafe ? 'pass' : 'fail'}">
                            <strong>–¢–µ—Å—Ç 2.${index + 1}: ${isSafe ? '‚úÖ –ü–†–û–ô–î–ï–ù' : '‚ùå –ù–ï –ü–†–û–ô–î–ï–ù'}</strong>
                            <br>–í—Ö–æ–¥: <span class="test-input">${input}</span>
                            <br>–í—ã—Ö–æ–¥: <span class="test-output">${escaped}</span>
                        </div>
                    `);
                } catch (error) {
                    testResults.push(`
                        <div class="test-result fail">
                            <strong>–¢–µ—Å—Ç 2.${index + 1}: ‚ùå –û–®–ò–ë–ö–ê</strong>
                            <br>–í—Ö–æ–¥: <span class="test-input">${input}</span>
                            <br>–û—à–∏–±–∫–∞: ${error.message}
                        </div>
                    `);
                }
            });

            // –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –ø–µ—Ä–µ–≤–æ–¥–æ–≤
            testResults.push('<h2>üìã –¢–µ—Å—Ç 3: –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–µ—Ä–µ–≤–æ–¥–æ–≤</h2>');
            
            const maliciousTitle = {
                ru: '<script>alert("XSS –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ")</script>',
                en: '<img src="x" onerror="alert(\'XSS in title\')">'
            };
            
            const maliciousDescription = {
                ru: '<div onclick="alert(1)">–û–ø–∞—Å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</div>',
                en: 'javascript:alert("XSS")'
            };
            
            const maliciousCategory = {
                ru: '<svg onload="alert(2)">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</svg>',
                en: '"><script>alert("XSS")</script>'
            };
            
            try {
                const safeTitle = getTitleByLanguage(maliciousTitle, 'ru');
                const safeDescription = getDescriptionByLanguage(maliciousDescription, 'ru');
                const safeCategory = getCategoryNameByLanguage(maliciousCategory, 'ru');
                
                const titleSafe = !safeTitle.includes('<script') && safeTitle.includes('&lt;');
                const descSafe = !safeDescription.includes('onclick=') && safeDescription.includes('&lt;');
                const catSafe = !safeCategory.includes('<svg') && safeCategory.includes('&lt;');
                
                testResults.push(`
                    <div class="test-result ${titleSafe ? 'pass' : 'fail'}">
                        <strong>–¢–µ—Å—Ç 3.1: ${titleSafe ? '‚úÖ –ü–†–û–ô–î–ï–ù' : '‚ùå –ù–ï –ü–†–û–ô–î–ï–ù'} - getTitleByLanguage</strong>
                        <br>–í—Ö–æ–¥: <span class="test-input">${JSON.stringify(maliciousTitle)}</span>
                        <br>–í—ã—Ö–æ–¥: <span class="test-output">${safeTitle}</span>
                    </div>
                `);
                
                testResults.push(`
                    <div class="test-result ${descSafe ? 'pass' : 'fail'}">
                        <strong>–¢–µ—Å—Ç 3.2: ${descSafe ? '‚úÖ –ü–†–û–ô–î–ï–ù' : '‚ùå –ù–ï –ü–†–û–ô–î–ï–ù'} - getDescriptionByLanguage</strong>
                        <br>–í—Ö–æ–¥: <span class="test-input">${JSON.stringify(maliciousDescription)}</span>
                        <br>–í—ã—Ö–æ–¥: <span class="test-output">${safeDescription}</span>
                    </div>
                `);
                
                testResults.push(`
                    <div class="test-result ${catSafe ? 'pass' : 'fail'}">
                        <strong>–¢–µ—Å—Ç 3.3: ${catSafe ? '‚úÖ –ü–†–û–ô–î–ï–ù' : '‚ùå –ù–ï –ü–†–û–ô–î–ï–ù'} - getCategoryNameByLanguage</strong>
                        <br>–í—Ö–æ–¥: <span class="test-input">${JSON.stringify(maliciousCategory)}</span>
                        <br>–í—ã—Ö–æ–¥: <span class="test-output">${safeCategory}</span>
                    </div>
                `);
                
            } catch (error) {
                testResults.push(`
                    <div class="test-result fail">
                        <strong>–¢–µ—Å—Ç 3: ‚ùå –û–®–ò–ë–ö–ê</strong>
                        <br>–û—à–∏–±–∫–∞: ${error.message}
                    </div>
                `);
            }

            // –¢–µ—Å—Ç 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ API —ç–∫—Å–ø–æ—Ä—Ç–∞
            testResults.push('<h2>üìã –¢–µ—Å—Ç 4: API —ç–∫—Å–ø–æ—Ä—Ç</h2>');
            
            try {
                const hasI18nAPI = typeof window.i18n === 'object';
                const hasCurrentLanguage = typeof window.i18n.currentLanguage === 'function';
                const currentLang = hasCurrentLanguage ? window.i18n.currentLanguage() : null;
                const hasEscapeFunctions = typeof window.escapeHTML === 'function' && typeof window.escapeDataAttribute === 'function';
                
                testResults.push(`
                    <div class="test-result ${hasI18nAPI ? 'pass' : 'fail'}">
                        <strong>–¢–µ—Å—Ç 4.1: ${hasI18nAPI ? '‚úÖ –ü–†–û–ô–î–ï–ù' : '‚ùå –ù–ï –ü–†–û–ô–î–ï–ù'} - window.i18n —Å—É—â–µ—Å—Ç–≤—É–µ—Ç</strong>
                    </div>
                `);
                
                testResults.push(`
                    <div class="test-result ${hasCurrentLanguage ? 'pass' : 'fail'}">
                        <strong>–¢–µ—Å—Ç 4.2: ${hasCurrentLanguage ? '‚úÖ –ü–†–û–ô–î–ï–ù' : '‚ùå –ù–ï –ü–†–û–ô–î–ï–ù'} - currentLanguage() —Ñ—É–Ω–∫—Ü–∏—è</strong>
                        <br>–¢–µ–∫—É—â–∏–π —è–∑—ã–∫: <span class="test-output">${currentLang}</span>
                    </div>
                `);
                
                testResults.push(`
                    <div class="test-result ${hasEscapeFunctions ? 'pass' : 'fail'}">
                        <strong>–¢–µ—Å—Ç 4.3: ${hasEscapeFunctions ? '‚úÖ –ü–†–û–ô–î–ï–ù' : '‚ùå –ù–ï –ü–†–û–ô–î–ï–ù'} - –§—É–Ω–∫—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã</strong>
                    </div>
                `);
                
            } catch (error) {
                testResults.push(`
                    <div class="test-result fail">
                        <strong>–¢–µ—Å—Ç 4: ‚ùå –û–®–ò–ë–ö–ê</strong>
                        <br>–û—à–∏–±–∫–∞: ${error.message}
                    </div>
                `);
            }
            
            // –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            resultsDiv.innerHTML = testResults.join('');
            
            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            const totalPassed = testResults.filter(r => r.includes('‚úÖ –ü–†–û–ô–î–ï–ù')).length;
            const totalFailed = testResults.filter(r => r.includes('‚ùå –ù–ï –ü–†–û–ô–î–ï–ù') || r.includes('‚ùå –û–®–ò–ë–ö–ê')).length;
            
            resultsDiv.innerHTML += `
                <div class="test-result info">
                    <h2>üìä –ò—Ç–æ–≥–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
                    <strong>–ü—Ä–æ–π–¥–µ–Ω–æ: ${totalPassed} | –ù–µ –ø—Ä–æ–π–¥–µ–Ω–æ: ${totalFailed}</strong>
                    ${totalFailed === 0 ? '<br>üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!' : '<br>‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏!'}
                </div>
            `;
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', runTests);
        } else {
            runTests();
        }
    </script>
</body>
</html>